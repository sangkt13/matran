<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MedMatrix VDLS + Bloom (T√°ch trang)</title>
  <meta name="theme-color" content="#2563eb" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .table-scroll::-webkit-scrollbar { height: 10px; width: 10px; }
    .table-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 999px; }
    .sticky-top { position: sticky; top: 0; z-index: 20; }
    .sticky-left { position: sticky; left: 0; z-index: 10; background: white; }
    .sticky-left-2 { position: sticky; left: 280px; z-index: 10; background: white; }
    .shadow-soft { box-shadow: 0 10px 30px rgba(2, 6, 23, 0.08); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .chip { border: 1px solid #e2e8f0; background: #f8fafc; }
    .btn { border: 1px solid #e2e8f0; background: white; }
    .btn:hover { background: #f8fafc; }
    .btn-primary { background: #2563eb; color: white; border-color: #2563eb; }
    .btn-primary:hover { filter: brightness(0.95); }
    .btn-green { background: #10b981; color: white; border-color: #10b981; }
    .btn-green:hover { filter: brightness(0.95); }
    .btn-purple { background: #7c3aed; color: white; border-color: #7c3aed; }
    .btn-purple:hover { filter: brightness(0.95); }
    .input { border: 1px solid #e2e8f0; background: white; }
    .input:focus { outline: 2px solid rgba(37,99,235,.25); border-color: #93c5fd; }
    .tab-active { background: #2563eb; color: white; border-color: #2563eb; }

    /* ===== Split pane (k√©o d√£n v√πng l√†m vi·ªác) ===== */
    .split-wrap { display:flex; gap:12px; align-items:stretch; }
    .pane-left { width: 420px; min-width: 320px; max-width: 700px; }
    .pane-right { flex:1; min-width: 360px; }
    .splitter {
      width: 10px;
      cursor: col-resize;
      border-radius: 999px;
      background: #e2e8f0;
      position: relative;
    }
    .splitter::after{
      content:"";
      position:absolute; inset: 6px 3px;
      border-radius: 999px;
      background:#cbd5e1;
    }
    .splitter:hover{ background:#cbd5e1; }
    .noselect { user-select:none; }
  </style>
</head>

<body class="bg-slate-50 text-slate-900">
  <div class="max-w-[1400px] mx-auto p-4 md:p-6">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
      <div>
        <div class="text-2xl font-bold">MedMatrix ‚Äì VDLS & Bloom</div>
        <div class="text-sm text-slate-600">T√°ch tab ‚ÄúCLO & Bloom‚Äù ri√™ng ƒë·ªÉ d·ªÖ quan s√°t + th√™m ch·ª©c nƒÉng nh·∫≠p CLO</div>
      </div>
      <div class="flex flex-wrap gap-2">
        <button id="btnExportJson" class="btn rounded-xl px-4 py-2 text-sm font-semibold">Xu·∫•t JSON</button>
        <button id="btnExportCsv" class="btn-green rounded-xl px-4 py-2 text-sm font-semibold">Xu·∫•t theo m·ª•c (CSV)</button>
      </div>
    </div>

    <!-- Tabs -->
    <div class="flex flex-wrap gap-2 mb-4">
      <button data-tab="tabOverview" class="tab btn tab-active rounded-xl px-4 py-2 text-sm font-semibold">T·ªïng quan</button>
      <button data-tab="tabGroups" class="tab btn rounded-xl px-4 py-2 text-sm font-semibold">Ph√¢n nh√≥m & VDLS</button>
      <button data-tab="tabBloom" class="tab btn rounded-xl px-4 py-2 text-sm font-semibold">Chi ti·∫øt CLO & Bloom</button>
      <button data-tab="tabData" class="tab btn rounded-xl px-4 py-2 text-sm font-semibold">D·ªØ li·ªáu nh√∫ng</button>
    </div>

    <!-- Split Layout -->
    <div class="split-wrap">
      <!-- Left -->
      <div id="paneLeft" class="pane-left space-y-4">
        <!-- Th√¥ng s·ªë chung -->
        <div class="bg-white rounded-2xl p-4 shadow-soft border border-slate-200">
          <div class="flex items-center gap-2 mb-3">
            <span class="inline-flex w-9 h-9 rounded-xl items-center justify-center bg-slate-100">‚öôÔ∏è</span>
            <div class="font-bold">TH√îNG S·ªê CHUNG</div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-xs text-slate-600">T·ªïng s·ªë c√¢u h·ªèi</label>
              <input id="inpTotalQ" type="number" class="input w-full rounded-xl px-3 py-2 mt-1" min="1" step="1">
            </div>
            <div>
              <label class="text-xs text-slate-600">Th·ªùi gian l√†m b√†i (ph√∫t)</label>
              <input id="inpDuration" type="number" class="input w-full rounded-xl px-3 py-2 mt-1" min="1" step="1">
            </div>
          </div>

          <div class="mt-3">
            <label class="text-xs text-slate-600">K·ª≥ thi</label>
            <input id="inpExamName" type="text" class="input w-full rounded-xl px-3 py-2 mt-1" placeholder="VD: Thi cu·ªëi k·ª≥...">
          </div>

          <div class="mt-4 grid grid-cols-2 gap-3">
            <label class="flex items-center gap-2 text-sm">
              <input id="chkLockMinMaxGroup" type="checkbox" class="w-4 h-4">
              Kh√≥a Min/Max theo Ph√¢n nh√≥m
            </label>
            <label class="flex items-center gap-2 text-sm">
              <input id="chkLockMinMaxVDLS" type="checkbox" class="w-4 h-4">
              Kh√≥a Min/Max theo VDLS
            </label>
          </div>
        </div>

        <!-- Bloom default -->
        <div class="bg-white rounded-2xl p-4 shadow-soft border border-slate-200">
          <div class="flex items-center gap-2 mb-3">
            <span class="inline-flex w-9 h-9 rounded-xl items-center justify-center bg-slate-100">üß†</span>
            <div class="font-bold">BLOOM M·∫∂C ƒê·ªäNH (%)</div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-xs text-slate-600">Nh·ªõ</label>
              <input id="b_nho" type="number" class="input w-full rounded-xl px-3 py-2 mt-1" min="0" max="100">
            </div>
            <div>
              <label class="text-xs text-slate-600">Hi·ªÉu</label>
              <input id="b_hieu" type="number" class="input w-full rounded-xl px-3 py-2 mt-1" min="0" max="100">
            </div>
            <div>
              <label class="text-xs text-slate-600">V·∫≠n d·ª•ng</label>
              <input id="b_vd" type="number" class="input w-full rounded-xl px-3 py-2 mt-1" min="0" max="100">
            </div>
            <div>
              <label class="text-xs text-slate-600">Ph√¢n t√≠ch</label>
              <input id="b_pt" type="number" class="input w-full rounded-xl px-3 py-2 mt-1" min="0" max="100">
            </div>
            <div>
              <label class="text-xs text-slate-600">ƒê√°nh gi√°</label>
              <input id="b_dg" type="number" class="input w-full rounded-xl px-3 py-2 mt-1" min="0" max="100">
            </div>
            <div>
              <label class="text-xs text-slate-600">S√°ng t·∫°o</label>
              <input id="b_st" type="number" class="input w-full rounded-xl px-3 py-2 mt-1" min="0" max="100">
            </div>
          </div>

          <div class="mt-3 flex items-center justify-between gap-3">
            <label class="flex items-center gap-2 text-sm">
              <input id="chkLockBloom" type="checkbox" class="w-4 h-4">
              Kh√≥a Bloom (t·ª± ph√¢n b·ªï t·ªïng)
            </label>
            <button id="btnApplyBloom" class="btn-purple rounded-xl px-4 py-2 text-sm font-semibold">√Åp d·ª•ng Bloom</button>
          </div>

          <div id="bloomSumHint" class="mt-2 text-xs text-slate-600"></div>
        </div>

        <!-- Summary -->
        <div class="bg-white rounded-2xl p-4 shadow-soft border border-slate-200">
          <div class="flex items-center justify-between mb-2">
            <div class="font-bold">KI·ªÇM TRA T·ªîNG C√ÇU</div>
            <span id="badgeCalc" class="chip rounded-full px-3 py-1 text-xs font-semibold">ƒêang t√≠nh‚Ä¶</span>
          </div>

          <div class="grid grid-cols-3 gap-2 text-sm mt-2">
            <div class="chip rounded-xl p-3">
              <div class="text-xs text-slate-600">T·ªïng nh√≥m</div>
              <div class="text-lg font-bold" id="sumGroups">0</div>
            </div>
            <div class="chip rounded-xl p-3">
              <div class="text-xs text-slate-600">T·ªïng VDLS</div>
              <div class="text-lg font-bold" id="sumVDLS">0</div>
            </div>
            <div class="chip rounded-xl p-3">
              <div class="text-xs text-slate-600">T·ªïng CLO</div>
              <div class="text-lg font-bold" id="sumCLO">0</div>
            </div>
          </div>

          <div class="mt-3 grid grid-cols-6 gap-2 text-xs">
            <div class="chip rounded-xl p-2">
              <div class="text-slate-500">Nh·ªõ</div>
              <div class="font-bold text-base" id="t_nho">0</div>
            </div>
            <div class="chip rounded-xl p-2">
              <div class="text-slate-500">Hi·ªÉu</div>
              <div class="font-bold text-base" id="t_hieu">0</div>
            </div>
            <div class="chip rounded-xl p-2">
              <div class="text-slate-500">V.D·ª•ng</div>
              <div class="font-bold text-base" id="t_vd">0</div>
            </div>
            <div class="chip rounded-xl p-2">
              <div class="text-slate-500">P.T√≠ch</div>
              <div class="font-bold text-base" id="t_pt">0</div>
            </div>
            <div class="chip rounded-xl p-2">
              <div class="text-slate-500">ƒê.Gi√°</div>
              <div class="font-bold text-base" id="t_dg">0</div>
            </div>
            <div class="chip rounded-xl p-2">
              <div class="text-slate-500">S.T·∫°o</div>
              <div class="font-bold text-base" id="t_st">0</div>
            </div>
          </div>

          <div class="mt-2 text-xs text-slate-500">
            N·∫øu CLO b·∫°n d√°n ch∆∞a ƒë·∫ßy ƒë·ªß, t·ªïng CLO c√≥ th·ªÉ l·ªách ‚Äî nh∆∞ng app v·∫´n ch·∫°y.
          </div>
        </div>
      </div>

      <!-- Splitter -->
      <div id="splitter" class="splitter"></div>

      <!-- Right -->
      <div id="paneRight" class="pane-right">
        <!-- Tab: Overview -->
        <div id="tabOverview" class="tabPanel bg-white rounded-2xl shadow-soft border border-slate-200 p-4">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-lg font-bold">T·ªïng quan ph√¢n b·ªï</div>
              <div class="text-sm text-slate-600">T√≠nh t·ª´ T√≠n ch·ªâ √ó H·ªá s·ªë ‚Üí % th√¥ ‚Üí ph√¢n b·ªï s·ªë c√¢u</div>
            </div>
            <div class="text-xs text-slate-500 mono" id="metaLine"></div>
          </div>

          <div class="mt-4 table-scroll overflow-auto border border-slate-200 rounded-2xl">
            <table class="min-w-[980px] w-full text-sm">
              <thead class="sticky-top bg-slate-50 border-b border-slate-200">
                <tr>
                  <th class="text-left p-3 w-[280px]">Ph√¢n nh√≥m</th>
                  <th class="text-right p-3">T√≠n ch·ªâ</th>
                  <th class="text-right p-3">H·ªá s·ªë</th>
                  <th class="text-right p-3">% th√¥</th>
                  <th class="text-right p-3">Min</th>
                  <th class="text-right p-3">Max</th>
                  <th class="text-right p-3">S·ªë c√¢u</th>
                </tr>
              </thead>
              <tbody id="tblGroups" class="divide-y divide-slate-100"></tbody>
            </table>
          </div>

          <div class="mt-3 text-xs text-slate-500">
            ‚Ä¢ Min/Max tr·ªëng = kh√¥ng r√†ng bu·ªôc. ‚Ä¢ L√†m tr√≤n theo ‚Äúlargest remainder‚Äù ƒë·ªÉ t·ªïng ƒë√∫ng.
          </div>
        </div>

        <!-- Tab: Groups & VDLS -->
        <div id="tabGroups" class="tabPanel hidden bg-white rounded-2xl shadow-soft border border-slate-200 p-4">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div>
              <div class="text-lg font-bold">Ph√¢n nh√≥m & VDLS</div>
              <div class="text-sm text-slate-600">VDLS ƒë∆∞·ª£c chia theo s·ªë c√¢u c·ªßa t·ª´ng ph√¢n nh√≥m</div>
            </div>
            <div class="flex gap-2">
              <input id="searchVDLS" class="input rounded-xl px-3 py-2 text-sm w-[280px]" placeholder="T√¨m VDLS...">
            </div>
          </div>

          <div class="mt-4 table-scroll overflow-auto border border-slate-200 rounded-2xl">
            <table class="min-w-[1200px] w-full text-sm">
              <thead class="sticky-top bg-slate-50 border-b border-slate-200">
                <tr>
                  <th class="text-left p-3 w-[280px] sticky-left">Ph√¢n nh√≥m</th>
                  <th class="text-left p-3 w-[520px] sticky-left-2">VDLS</th>
                  <th class="text-center p-3">Tr·∫°ng th√°i</th>
                  <th class="text-right p-3">Tr·ªçng s·ªë</th>
                  <th class="text-right p-3">Min</th>
                  <th class="text-right p-3">Max</th>
                  <th class="text-right p-3">S·ªë c√¢u</th>
                </tr>
              </thead>
              <tbody id="tblVDLS" class="divide-y divide-slate-100"></tbody>
            </table>
          </div>
        </div>

        <!-- Tab: CLO & Bloom -->
        <div id="tabBloom" class="tabPanel hidden bg-white rounded-2xl shadow-soft border border-slate-200 p-4">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div>
              <div class="text-lg font-bold">Chi ti·∫øt CLO & Bloom</div>
              <div class="text-sm text-slate-600">T√≠nh s·ªë c√¢u theo t·ª´ng CLO √ó Bloom t·ª´ ph√¢n b·ªï VDLS</div>
            </div>
            <div class="flex flex-wrap gap-2 items-center">
              <select id="filterGroup" class="input rounded-xl px-3 py-2 text-sm">
                <option value="">T·∫•t c·∫£ ph√¢n nh√≥m</option>
              </select>
              <input id="searchCLO" class="input rounded-xl px-3 py-2 text-sm w-[260px]" placeholder="T√¨m CLO / VDLS...">
            </div>
          </div>

          <!-- ===== FORM NH·∫¨P CLO (ADD) ===== -->
          <div class="mt-3 bg-slate-50 border border-slate-200 rounded-2xl p-3">
            <div class="font-semibold mb-2">Nh·∫≠p CLO nhanh</div>

            <div class="grid grid-cols-1 md:grid-cols-6 gap-2 items-end">
              <div class="md:col-span-2">
                <label class="text-xs text-slate-600">Ph√¢n nh√≥m</label>
                <select id="addCloGroup" class="input w-full rounded-xl px-3 py-2 text-sm mt-1"></select>
              </div>

              <div class="md:col-span-2">
                <label class="text-xs text-slate-600">VDLS</label>
                <select id="addCloProblem" class="input w-full rounded-xl px-3 py-2 text-sm mt-1"></select>
              </div>

              <div class="md:col-span-2">
                <label class="text-xs text-slate-600">CLO</label>
                <input id="addCloName" class="input w-full rounded-xl px-3 py-2 text-sm mt-1" placeholder="VD: Ch·∫©n ƒëo√°n YHHƒê">
              </div>

              <div class="md:col-span-2">
                <label class="text-xs text-slate-600">Bloom</label>
                <select id="addCloBloom" class="input w-full rounded-xl px-3 py-2 text-sm mt-1">
                  <option>Nh·ªõ</option>
                  <option>Hi·ªÉu</option>
                  <option>V·∫≠n d·ª•ng</option>
                  <option>Ph√¢n t√≠ch</option>
                  <option>ƒê√°nh gi√°</option>
                  <option>S√°ng t·∫°o</option>
                </select>
              </div>

              <div class="md:col-span-2">
                <label class="text-xs text-slate-600">Tr·∫°ng th√°i</label>
                <select id="addCloInclude" class="input w-full rounded-xl px-3 py-2 text-sm mt-1">
                  <option value="C√≥">C√≥</option>
                  <option value="Kh√¥ng">Kh√¥ng</option>
                </select>
              </div>

              <div class="md:col-span-1">
                <label class="text-xs text-slate-600">Tr·ªçng s·ªë</label>
                <input id="addCloWeight" type="number" min="0" step="0.1"
                      class="input w-full rounded-xl px-3 py-2 text-sm mt-1" value="1">
              </div>

              <div class="md:col-span-1 flex gap-2">
                <button id="btnAddCLO" class="btn-primary rounded-xl px-4 py-2 text-sm font-semibold w-full">
                  Th√™m CLO
                </button>
              </div>
            </div>

            <div class="mt-2 flex flex-wrap gap-2">
              <button id="btnAutoCLO" class="btn rounded-xl px-4 py-2 text-sm font-semibold">
                T·∫°o khung CLO/Bloom t·ª´ VDLS (t·ª± sinh)
              </button>
              <button id="btnRebuildCLO_TSV" class="btn rounded-xl px-4 py-2 text-sm font-semibold">
                Xu·∫•t l·∫°i CLO_TSV t·ª´ d·ªØ li·ªáu hi·ªán c√≥
              </button>
              <div id="addCloMsg" class="text-xs text-slate-600 self-center"></div>
            </div>
          </div>
          <!-- ===== END FORM NH·∫¨P CLO ===== -->

          <div class="mt-4 table-scroll overflow-auto border border-slate-200 rounded-2xl">
            <table class="min-w-[1600px] w-full text-sm">
              <thead class="sticky-top bg-slate-50 border-b border-slate-200">
                <tr>
                  <th class="text-left p-3 w-[280px] sticky-left">Ph√¢n nh√≥m</th>
                  <th class="text-left p-3 w-[560px] sticky-left-2">VDLS</th>
                  <th class="text-left p-3">CLO</th>
                  <th class="text-center p-3">Bloom</th>
                  <th class="text-center p-3">Tr·∫°ng th√°i</th>
                  <th class="text-right p-3">Tr·ªçng s·ªë</th>
                  <th class="text-right p-3">S·ªë c√¢u</th>
                </tr>
              </thead>
              <tbody id="tblCLO" class="divide-y divide-slate-100"></tbody>
            </table>
          </div>
        </div>

        <!-- Tab: Embedded data -->
        <div id="tabData" class="tabPanel hidden bg-white rounded-2xl shadow-soft border border-slate-200 p-4">
          <div class="text-lg font-bold">D·ªØ li·ªáu nh√∫ng (TSV)</div>
          <div class="text-sm text-slate-600">B·∫°n c√≥ th·ªÉ ch·ªânh d·ªØ li·ªáu tr·ª±c ti·∫øp trong GROUP_TSV / VDLS_TSV / CLO_TSV</div>

          <div class="grid grid-cols-1 gap-4 mt-4">
            <div>
              <div class="text-sm font-semibold mb-2">GROUP_TSV</div>
              <textarea id="txtGroup" class="input w-full rounded-2xl p-3 h-[220px] mono text-xs"></textarea>
            </div>
            <div>
              <div class="text-sm font-semibold mb-2">VDLS_TSV</div>
              <textarea id="txtVDLS" class="input w-full rounded-2xl p-3 h-[260px] mono text-xs"></textarea>
            </div>
            <div>
              <div class="text-sm font-semibold mb-2">CLO_TSV</div>
              <textarea id="txtCLO" class="input w-full rounded-2xl p-3 h-[320px] mono text-xs"></textarea>
            </div>
            <div class="flex gap-2">
              <button id="btnReloadFromText" class="btn-primary rounded-xl px-4 py-2 text-sm font-semibold">N·∫°p l·∫°i d·ªØ li·ªáu t·ª´ textarea</button>
              <div class="text-xs text-slate-500 self-center">* N·∫øu b·∫°n s·ª≠a TSV ·ªü ƒë√¢y v√† b·∫•m n·∫°p l·∫°i, app s·∫Ω t√≠nh l·∫°i.</div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

<script>
/* =========================================================
   A) D·ªÆ LI·ªÜU NH√öNG (TSV) ‚Äî D√ÅN Y NGUY√äN
   ========================================================= */

let GROUP_TSV = `
Ph√¢n nh√≥m	T√≠n ch·ªâ	H·ªá s·ªë	% th√¥	T·ª∑ l·ªá (%) min	T·ª∑ l·ªá (%) max	S·ªë c√¢u	S·ªë VDLS
B·ªánh T·∫°ng ph·ªß	4	2	9.09%			11	4
B·ªánh h·ªá th·ªëng Tim m·∫°ch ‚Äì h√¥ h·∫•p 	6	2	13.64%			16	5
B·ªánh h·ªá th·ªëng Ti·∫øt ni·ªáu ‚Äì N·ªôi ti·∫øt - Huy·∫øt h·ªçc	5	2	11.36%			14	5
B·ªánh h·ªá th·ªëng Ti√™u h√≥a - gan m·∫≠t	5	2	11.36%			14	5
B·ªánh h·ªá th·ªëng Ng≈© quan ‚Äì L√£o khoa	4	1	4.55%			5	2
B·ªánh h·ªá th·ªëng C∆° - x∆∞∆°ng ‚Äì kh·ªõp	4	3	13.64%			16	5
B·ªánh h·ªá th·ªëng Th·∫ßn kinh	4	3	13.64%			16	5
B·ªánh h·ªá th·ªëng Nhi·ªÖm ‚Äì Ph·ª•	8	1	9.09%			11	4
B·ªánh h·ªá th·ªëng Nhi khoa	4	1	4.55%			5	2
B·ªánh h·ªá th·ªëng Ngo·∫°i khoa - Da li·ªÖu	8	1	9.09%			11	4
T·ªïng	52	18	100%			120	40
`.trim();

let VDLS_TSV = `
Ph√¢n nh√≥m VDLS	T√¨nh tr·∫°ng	T·ª∑ tr·ªçng	% th√¥	T·ª∑ l·ªá (%) min	T·ª∑ l·ªá (%) max	S·ªë c√¢u
B·ªánh T·∫°ng ph·ªß			9.09%	0%	0%
Bi·ªán ch·ª©ng t·∫°ng ph·ªß	C√≥	1	9.09%			11
B·ªánh h·ªá th·ªëng Tim m·∫°ch ‚Äì h√¥ h·∫•p 			13.64%	0%	0%
YHHƒê: B·ªánh m·∫°ch v√†nh m·∫°n. YHCT: T√¢m th·ªëng.	C√≥	1	2.73%			3
YHHƒê: TƒÉng huy·∫øt √°p. YHCT: Huy·ªÖn v·ª±ng.	C√≥	1	2.73%			3
YHHƒê: Suy tƒ©nh m·∫°ch m·∫°n t√≠nh.	C√≥	1	2.73%			3
YHHƒê: COPD. 	C√≥	1	2.73%			3
YHHƒê: Hen ph·∫ø qu·∫£n. YHCT: H√°o ch·ª©ng, suy·ªÖn ch·ª©ng.	C√≥	1	2.73%			3
B·ªánh h·ªá th·ªëng Ti·∫øt ni·ªáu ‚Äì N·ªôi ti·∫øt - Huy·∫øt h·ªçc			11.36%	0%	0%
YHHƒê: Nhi·ªÖm khu·∫©n ti·∫øt ni·ªáu. YHCT: L√¢m ch·ª©ng. 	C√≥	1	2.84%			3
YHHƒê: B√©o ph√¨. YHCT: Ph√¨ b·∫°ng.	C√≥	1	2.84%			3
YHHƒê: ƒê√°i th√°o ƒë∆∞·ªùng. YHCT: Ti√™u kh√°t.	C√≥	1	2.84%			3
YHHƒê: Thi·∫øu m√°u m·∫°n.	C√≥	1	2.84%			3
B·ªánh h·ªá th·ªëng Ti√™u h√≥a - gan m·∫≠t			11.36%	0%	0%
YHHƒê: Vi√™m lo√©t d·∫° d√†y t√° tr√†ng. YHCT: V·ªã qu·∫£n th·ªëng, Ph√∫c m√£n, Bƒ© m√£n, Ch·ª©ng tr∆∞·ªõng.	C√≥	1	2.27%			3
YHHƒê: GERD. YHCT: Hung th·ªëng, √Åi kh√≠. 	C√≥	1	2.27%			3
YHHƒê: H·ªôi ch·ª©ng ru·ªôt k√≠ch th√≠ch. YHCT: Ti·∫øt t·∫£, Ph√∫c m√£n, Ti·ªán b√≠.	C√≥	1	2.27%			3
YHHƒê: Vi√™m gan m·∫°n. YHCT: Ho√†ng ƒë·∫£n, ch·ª©ng tr∆∞·ªõng.	C√≥	1	2.27%			3
YHHƒê: X∆° gan. YHCT: Ho√†ng ƒë·∫£n, C·ªï tr∆∞·ªõng.	C√≥	1	2.27%			3
B·ªánh h·ªá th·ªëng Ng≈© quan ‚Äì L√£o khoa			4.55%	0%	0%
YHHƒê: B·ªánh th·∫≠n m·∫°n. YHCT: H∆∞ lao. 	C√≥	1	2.27%			3
YHHƒê: Vi√™m m≈©i d·ªã ·ª©ng.	C√≥	1	2.27%			3
B·ªánh h·ªá th·ªëng C∆° - x∆∞∆°ng ‚Äì kh·ªõp			13.64%	0%	0%
YHHƒê: Tho√°i h√≥a c·ªôt s·ªëng th·∫Øt l∆∞ng. YHCT: T√Ω ch·ª©ng, Y√™u th·ªëng.	C√≥	1	2.73%			3
YHHƒê: Tho√°i h√≥a kh·ªõp g·ªëi. YHCT: T√Ω ch·ª©ng, H·∫°c t·∫•t phong.	C√≥	1	2.73%			3
YHHƒê: Lo√£ng x∆∞∆°ng.	C√≥	1	2.73%			3
YHHƒê: Vi√™m kh·ªõp d·∫°ng th·∫•p. YHCT: T√Ω ch·ª©ng.	C√≥	1	2.73%			3
YHHƒê: Vi√™m kh·ªõp gout. YHCT: T√Ω ch·ª©ng, Th·ªëng phong.	C√≥	1	2.73%			3
B·ªánh h·ªá th·ªëng Th·∫ßn kinh			13.64%	0%	0%
YHHƒê: Di ch·ª©ng tai bi·∫øn m·∫°ch m√°u n√£o. YHCT: B√°n th√¢n b·∫•t to·∫°i.	C√≥	1	2.73%			3
YHHƒê: ƒêau ƒë·∫ßu. YHCT: ƒê·∫ßu th·ªëng, ƒê√†m ch·ª©ng.	C√≥	1	2.73%			3
YHHƒê: ƒêau th·∫ßn kinh t·ªça. YHCT: Y√™u th·ªëng, Y√™u c∆∞·ªõc th·ªëng, T·ªça c·ªët phong, Ma m·ªôc b·∫•t nh√¢n.	C√≥	1	2.73%			3
YHHƒê: Li·ªát m·∫∑t. YHCT: Kh·∫©u nh√£n oa t√†.	C√≥	1	2.73%			3
YHHƒê: M·∫•t ng·ªß. YHCT: Th·∫•t mi√™n.	C√≥	1	2.73%			3
B·ªánh h·ªá th·ªëng Nhi·ªÖm ‚Äì Ph·ª•			9.09%	0%	0%
YHHƒê: Vi√™m gan si√™u vi. YHCT: Ho√†ng ƒë·∫£n.	C√≥	1	2.27%			3
YHHƒê: S·ªët xu·∫•t huy·∫øt Dengue. YHCT: √în b·ªánh.	C√≥	1	2.27%			3
YHHƒê: ƒêau b·ª•ng kinh nguy√™n ph√°t. YHCT: Th·ªëng kinh.	C√≥	1	2.27%			3
YHHƒê: R·ªëi lo·∫°n m√£n kinh v√† chu m√£n kinh.	C√≥	1	2.27%			3
B·ªánh h·ªá th·ªëng Nhi khoa			4.55%	0%	0%
YHHƒê: Suy dinh d∆∞·ª°ng ·ªü tr·∫ª em. YHCT: Cam t√≠ch.	C√≥	1	2.27%			3
YHHƒê: ƒê√°i d·∫ßm ·ªü tr·∫ª em. YHCT: D·∫° ni·ªáu.	C√≥	1	2.27%			3
B·ªánh h·ªá th·ªëng Ngo·∫°i khoa - Da li·ªÖu			9.09%	0%	0%
YHHƒê: Trƒ©. YHCT: H·∫° trƒ©.	C√≥	1	2.27%			3
YHHƒê: S·ªèi ƒë∆∞·ªùng ni·ªáu. YHCT: L√¢m ch·ª©ng.	C√≥	1	2.27%			3
YHHƒê: M√†y ƒëay.	C√≥	1	2.27%			3
YHHƒê: M·ª•n tr·ª©ng c√°.	C√≥	1	2.27%			3
`.trim();

let CLO_TSV = `
Ph√¢n nh√≥m VDLS	CLO	BLOOM	Tr·∫°ng th√°i	Tr·ªçng s·ªë	% th√¥	S·ªë c√¢u c·∫ßn	S·ªë c√¢u so·∫°n
B·ªánh T·∫°ng ph·ªß							
Bi·ªán ch·ª©ng t·∫°ng ph·ªß							
	Ch·∫©n ƒëo√°n	Ph√¢n t√≠ch	C√≥	1	4.55%	5.45	11
	ƒêi·ªÅu tr·ªã	Ph√¢n t√≠ch	C√≥	1	4.55%	5.45	11
B·ªánh h·ªá th·ªëng Tim m·∫°ch ‚Äì h√¥ h·∫•p 							
YHHƒê: B·ªánh m·∫°ch v√†nh m·∫°n. YHCT: T√¢m th·ªëng.							
	Ch·∫©n ƒëo√°n YHHƒê	ƒê√°nh gi√°	C√≥	1	0.91%	1.09	2
	Ch·∫©n ƒëo√°n YHCT	ƒê√°nh gi√°	Kh√¥ng	1	0.00%	0.00	0
	ƒêi·ªÅu tr·ªã YHHƒê	ƒê√°nh gi√°	C√≥	1	0.91%	1.09	2
	ƒêi·ªÅu tr·ªã YHCT	ƒê√°nh gi√°	Kh√¥ng	1	0.00%	0.00	0
	D·ª± ph√≤ng YHHƒê	Ph√¢n t√≠ch	C√≥	1	0.91%	1.09	2
	D·ª± ph√≤ng YHCT	Ph√¢n t√≠ch	Kh√¥ng	1	0.00%	0.00	0
YHHƒê: TƒÉng huy·∫øt √°p. YHCT: Huy·ªÖn v·ª±ng.							
	Ch·∫©n ƒëo√°n YHHƒê	ƒê√°nh gi√°	Kh√¥ng	1	0.00%	0.00	0
	Ch·∫©n ƒëo√°n YHCT	ƒê√°nh gi√°	Kh√¥ng	1	0.00%	0.00	0
	ƒêi·ªÅu tr·ªã YHHƒê	ƒê√°nh gi√°	C√≥	1	0.91%	1.09	2
	ƒêi·ªÅu tr·ªã YHCT	ƒê√°nh gi√°	C√≥	1	0.91%	1.09	2
	D·ª± ph√≤ng YHHƒê	Ph√¢n t√≠ch	C√≥	1	0.91%	1.09	2
	D·ª± ph√≤ng YHCT	Ph√¢n t√≠ch	Kh√¥ng	1	0.00%	0.00	0
YHHƒê: Suy tƒ©nh m·∫°ch m·∫°n t√≠nh.							
	Ch·∫©n ƒëo√°n YHHƒê	ƒê√°nh gi√°	Kh√¥ng	1	0.00%	0.00	0
	Ch·∫©n ƒëo√°n YHCT	ƒê√°nh gi√°	Kh√¥ng	1	0.00%	0.00	0
	ƒêi·ªÅu tr·ªã YHHƒê	ƒê√°nh gi√°	C√≥	1	0.68%	0.82	2
	ƒêi·ªÅu tr·ªã YHCT	ƒê√°nh gi√°	C√≥	1	0.68%	0.82	2
	D·ª± ph√≤ng YHHƒê	Ph√¢n t√≠ch	C√≥	1	0.68%	0.82	2
	D·ª± ph√≤ng YHCT	Ph√¢n t√≠ch	C√≥	1	0.68%	0.82	2
YHHƒê: COPD. 							
	Ch·∫©n ƒëo√°n YHHƒê	ƒê√°nh gi√°	Kh√¥ng	1	0.00%	0.00	0
	Ch·∫©n ƒëo√°n YHCT	ƒê√°nh gi√°	Kh√¥ng	1	0.00%	0.00	0
	ƒêi·ªÅu tr·ªã YHHƒê	ƒê√°nh gi√°	C√≥	1	0.91%	1.09	2
	ƒêi·ªÅu tr·ªã YHCT	ƒê√°nh gi√°	C√≥	1	0.91%	1.09	2
	D·ª± ph√≤ng YHHƒê	Ph√¢n t√≠ch	C√≥	1	0.91%	1.09	2
	D·ª± ph√≤ng YHCT	Ph√¢n t√≠ch	Kh√¥ng	1	0.00%	0.00	0
YHHƒê: Hen ph·∫ø qu·∫£n. YHCT: H√°o ch·ª©ng, suy·ªÖn ch·ª©ng.							
	Ch·∫©n ƒëo√°n YHHƒê	ƒê√°nh gi√°	C√≥	1	0.91%	1.09	2
	Ch·∫©n ƒëo√°n YHCT	ƒê√°nh gi√°	Kh√¥ng	1	0.00%	0.00	0
	ƒêi·ªÅu tr·ªã YHHƒê	ƒê√°nh gi√°	C√≥	1	0.91%	1.09	2
	ƒêi·ªÅu tr·ªã YHCT	ƒê√°nh gi√°	C√≥	1	0.91%	1.09	2
	D·ª± ph√≤ng YHHƒê	Ph√¢n t√≠ch	Kh√¥ng	1	0.00%	0.00	0
	D·ª± ph√≤ng YHCT	Ph√¢n t√≠ch	Kh√¥ng	1	0.00%	0.00	0

/* ====== D√ÅN TI·∫æP PH·∫¶N C√íN L·∫†I C·ª¶A CLO/BLOOM T·ª™ "B·ªánh h·ªá th·ªëng Ti·∫øt ni·ªáu..." ƒê·∫æN H·∫æT "T·ªîNG C·ªòNG" V√ÄO ƒê√ÇY ====== */
`.trim();

/* =========================================================
   B) H√ÄM TI·ªÜN √çCH
   ========================================================= */

function tsvLines(tsv){
  return tsv.split(/\r?\n/).map(l=>l.replace(/\u00A0/g," ").trimEnd()).filter(l=>l.trim().length>0);
}
function toNum(x){
  if (x == null) return null;
  const s = String(x).trim();
  if (!s) return null;
  const v = Number(s.replaceAll(",", "."));
  return Number.isFinite(v) ? v : null;
}
function yesNoToBool(s){
  const t = (s||"").trim().toLowerCase();
  if (t==="c√≥" || t==="co" || t==="yes" || t==="1") return true;
  if (t==="kh√¥ng" || t==="khong" || t==="no" || t==="0") return false;
  return false;
}
function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }

function largestRemainderAllocate(targetTotal, items, getRaw){
  const raws = items.map(getRaw);
  const floors = raws.map(x => Math.floor(x));
  let sum = floors.reduce((a,b)=>a+b,0);
  let remain = targetTotal - sum;

  const fracs = raws.map((x,i)=>({i, frac: x - floors[i]})).sort((a,b)=>b.frac-a.frac);
  const out = floors.slice();
  let k=0;
  while(remain>0 && fracs.length){
    out[fracs[k].i] += 1;
    remain--;
    k++;
    if (k>=fracs.length) k=0;
  }

  if (remain<0){
    const fracsAsc = raws.map((x,i)=>({i, frac: x - floors[i]})).sort((a,b)=>a.frac-b.frac);
    let kk=0;
    remain = -remain;
    while(remain>0 && fracsAsc.length){
      if(out[fracsAsc[kk].i]>0){ out[fracsAsc[kk].i]-=1; remain--; }
      kk++;
      if (kk>=fracsAsc.length) kk=0;
    }
  }
  return out;
}

function safePctFromWeights(weights){
  const s = weights.reduce((a,b)=>a+b,0);
  return weights.map(w => s>0 ? (w/s) : 0);
}

/* =========================================================
   C) PARSER TSV ‚Üí OBJECT
   ========================================================= */

function parseGroups(tsv){
  const lines = tsvLines(tsv);
  const header = lines[0].split("\t").map(s=>s.trim());
  const idx = (name)=>header.indexOf(name);

  const out = [];
  for (let i=1;i<lines.length;i++){
    const cols = lines[i].split("\t");
    const name = (cols[idx("Ph√¢n nh√≥m")]||"").trim();
    if (!name || name.toLowerCase()==="t·ªïng") continue;

    out.push({
      name,
      credits: toNum(cols[idx("T√≠n ch·ªâ")]) ?? 0,
      coef: toNum(cols[idx("H·ªá s·ªë")]) ?? 0,
      min: null,
      max: null
    });
  }
  return out;
}

function parseVDLS(tsv){
  const lines = tsvLines(tsv);
  const header = lines[0].split("\t").map(s=>s.trim());
  const idx = (name)=>header.indexOf(name);

  const out = [];
  let currentGroup = "";
  for (let i=1;i<lines.length;i++){
    const cols = lines[i].split("\t");
    const groupCell = (cols[idx("Ph√¢n nh√≥m VDLS")]||"").trim();
    const status = (cols[idx("T√¨nh tr·∫°ng")]||"").trim();

    // group header row: has group name but status empty
    if (groupCell && !status){
      currentGroup = groupCell;
      continue;
    }
    if (!groupCell) continue;

    out.push({
      group: currentGroup || "(Ch∆∞a nh√≥m)",
      problem: groupCell,
      include: yesNoToBool(status),
      weight: toNum(cols[idx("T·ª∑ tr·ªçng")]) ?? 1,
      min: null,
      max: null
    });
  }
  return out;
}

function parseCLO(tsv){
  const lines = tsvLines(tsv);
  const header = lines[0].split("\t").map(s=>s.trim());
  const idx = (name)=>header.indexOf(name);

  const out = [];
  let currentGroup = "";
  let currentProblem = "";

  for (let i=1;i<lines.length;i++){
    const cols = lines[i].split("\t");
    const g = (cols[idx("Ph√¢n nh√≥m VDLS")]||"").trim();
    const clo = (cols[idx("CLO")]||"").trim();
    const bloom = (cols[idx("BLOOM")]||"").trim();

    // group header line: first cell has group, the rest empty
    const rest = cols.map((c,j)=> (j===idx("Ph√¢n nh√≥m VDLS") ? "" : (c||"").trim())).join("");
    if (g && !clo && !bloom && rest===""){
      currentGroup = g;
      continue;
    }

    // problem header line: has VDLS problem but CLO/Bloom empty
    if (g && !clo && !bloom){
      currentProblem = g;
      continue;
    }

    if (!clo || !bloom) continue;

    const status = (cols[idx("Tr·∫°ng th√°i")]||"").trim();
    const w = toNum(cols[idx("Tr·ªçng s·ªë")]) ?? 1;

    out.push({
      group: currentGroup || "(Ch∆∞a nh√≥m)",
      problem: currentProblem || "(Ch∆∞a VDLS)",
      clo,
      bloom,
      include: yesNoToBool(status),
      weight: w
    });
  }
  return out;
}

/* =========================================================
   D) APP STATE
   ========================================================= */

const APP = {
  meta: { totalQuestions: 120, durationMinutes: 90, examName: "K·ª≥ thi" },
  bloomDefault: { nho:15, hieu:20, vd:25, pt:20, dg:15, st:5 },
  lockBloom: false,
  lockMinMaxGroup: true,
  lockMinMaxVDLS: true,

  groups: parseGroups(GROUP_TSV),
  vdls: parseVDLS(VDLS_TSV),
  allocations: parseCLO(CLO_TSV),

  computed: null
};

const BLOOM_KEYS = [
  {key:"nho", label:"Nh·ªõ"},
  {key:"hieu", label:"Hi·ªÉu"},
  {key:"vd", label:"V·∫≠n d·ª•ng"},
  {key:"pt", label:"Ph√¢n t√≠ch"},
  {key:"dg", label:"ƒê√°nh gi√°"},
  {key:"st", label:"S√°ng t·∫°o"},
];

function bloomKeyFromLabel(b){
  const t = (b||"").toLowerCase().trim();
  if (t.includes("nh·ªõ")) return "nho";
  if (t.includes("hi·ªÉu")) return "hieu";
  if (t.includes("v.d") || t.includes("v·∫≠n")) return "vd";
  if (t.includes("p.t") || t.includes("ph√¢n")) return "pt";
  if (t.includes("ƒë.") || t.includes("ƒë√°nh")) return "dg";
  if (t.includes("s.") || t.includes("s√°ng")) return "st";
  return null;
}

/* =========================================================
   E) CORE COMPUTE
   ========================================================= */

function computeAll(){
  // 1) group weights
  const gw = APP.groups.map(g => (g.credits||0) * (g.coef||0));
  const gpct = safePctFromWeights(gw); // fraction
  const groupRawQ = gpct.map(fr => fr * APP.meta.totalQuestions);
  let groupQ = largestRemainderAllocate(APP.meta.totalQuestions, APP.groups, (_,i)=>groupRawQ[i]);

  // apply min/max if NOT locked
  if (!APP.lockMinMaxGroup){
    groupQ = applyMinMaxAndRebalance(APP.meta.totalQuestions, groupQ, APP.groups.map(g=>g.min), APP.groups.map(g=>g.max));
  }

  const groupsComputed = APP.groups.map((g,i)=>({
    ...g,
    rawPct: gpct[i]*100,
    q: groupQ[i]
  }));

  // 2) VDLS per group
  const vdlsByGroup = new Map();
  APP.vdls.forEach(v=>{
    if(!vdlsByGroup.has(v.group)) vdlsByGroup.set(v.group, []);
    vdlsByGroup.get(v.group).push(v);
  });

  const vdlsComputed = [];
  const vdlsQMap = new Map(); // key group|||problem -> q

  for (const g of groupsComputed){
    const list = (vdlsByGroup.get(g.name) || []).slice();
    if (list.length===0) continue;

    const included = list.filter(x=>x.include);
    const base = included.length ? included : list; // if none included, fallback all
    const weights = base.map(x=>x.weight || 1);
    const fracs = safePctFromWeights(weights);
    const raw = fracs.map(fr => fr * g.q);
    let qs = largestRemainderAllocate(g.q, base, (_,i)=>raw[i]);

    if (!APP.lockMinMaxVDLS){
      qs = applyMinMaxAndRebalance(g.q, qs, base.map(x=>x.min), base.map(x=>x.max));
    }

    base.forEach((v,i)=>{
      const q = qs[i];
      vdlsComputed.push({...v, q, groupQ: g.q});
      vdlsQMap.set(`${v.group}|||${v.problem}`, q);
    });
  }

  // 3) CLO allocations within each VDLS problem
  const rowsByProblem = new Map();
  APP.allocations.forEach(r=>{
    const k = `${r.group}|||${r.problem}`;
    if(!rowsByProblem.has(k)) rowsByProblem.set(k, []);
    rowsByProblem.get(k).push(r);
  });

  const cloComputed = [];
  const bloomTotals = {nho:0,hieu:0,vd:0,pt:0,dg:0,st:0};
  let totalCLO = 0;

  for (const [k, rows] of rowsByProblem.entries()){
    const [groupName, problem] = k.split("|||");
    const vdlsQ = vdlsQMap.get(`${groupName}|||${problem}`) ?? 0;

    const included = rows.filter(r=>r.include);
    const base = included.length ? included : rows;
    const weights = base.map(r=>r.weight || 1);
    const fracs = safePctFromWeights(weights);
    const raw = fracs.map(fr => fr * vdlsQ);
    const qs = largestRemainderAllocate(vdlsQ, base, (_,i)=>raw[i]);

    base.forEach((r,i)=>{
      const q = qs[i];
      const bk = bloomKeyFromLabel(r.bloom);
      if (bk) bloomTotals[bk] += q;
      totalCLO += q;
      cloComputed.push({...r, q, bloomKey: bk});
    });
  }

  let bloomByDefault = null;
  if (APP.lockBloom){
    bloomByDefault = allocateBloomTotals(APP.meta.totalQuestions, APP.bloomDefault);
  }

  APP.computed = {
    groups: groupsComputed,
    vdls: vdlsComputed,
    clo: cloComputed,
    totals: {
      groups: groupsComputed.reduce((a,b)=>a+b.q,0),
      vdls: vdlsComputed.reduce((a,b)=>a+b.q,0),
      clo: totalCLO,
      bloomTotals,
      bloomByDefault
    }
  };
}

function applyMinMaxAndRebalance(total, qs, mins, maxs){
  const out = qs.slice();
  const n = out.length;
  const minA = mins.map(x => (x==null? null : Math.max(0, Math.floor(x))));
  const maxA = maxs.map(x => (x==null? null : Math.max(0, Math.floor(x))));

  // apply min
  for (let i=0;i<n;i++){
    if (minA[i]!=null && out[i] < minA[i]) out[i]=minA[i];
  }
  // apply max
  for (let i=0;i<n;i++){
    if (maxA[i]!=null && out[i] > maxA[i]) out[i]=maxA[i];
  }

  // rebalance
  let sum = out.reduce((a,b)=>a+b,0);
  let diff = total - sum;

  if (diff>0){
    while(diff>0){
      let changed=false;
      for (let i=0;i<n && diff>0;i++){
        if (maxA[i]==null || out[i] < maxA[i]){
          out[i] += 1; diff -= 1; changed=true;
        }
      }
      if(!changed) break;
    }
  }
  if (diff<0){
    diff = -diff;
    while(diff>0){
      let changed=false;
      for (let i=0;i<n && diff>0;i++){
        if (out[i]>0 && (minA[i]==null || out[i] > minA[i])){
          out[i] -= 1; diff -= 1; changed=true;
        }
      }
      if(!changed) break;
    }
  }
  return out;
}

function allocateBloomTotals(totalQ, bloomDefault){
  const weights = BLOOM_KEYS.map(x => bloomDefault[x.key] || 0);
  const fracs = safePctFromWeights(weights);
  const raw = fracs.map(fr => fr * totalQ);
  const alloc = largestRemainderAllocate(totalQ, BLOOM_KEYS, (_,i)=>raw[i]);
  const out = {};
  BLOOM_KEYS.forEach((b,i)=>out[b.key]=alloc[i]);
  return out;
}

/* =========================================================
   F) RENDER
   ========================================================= */

function fmtPct(x){
  if (!Number.isFinite(x)) return "";
  return `${x.toFixed(2)}%`;
}
function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
}
function badgeYesNo(b){
  return b
    ? `<span class="chip rounded-full px-3 py-1 text-xs font-semibold text-emerald-700 border-emerald-200 bg-emerald-50">C√≥</span>`
    : `<span class="chip rounded-full px-3 py-1 text-xs font-semibold text-slate-600">Kh√¥ng</span>`;
}

function render(){
  computeAll();

  // meta
  document.getElementById("metaLine").textContent =
    `T·ªïng c√¢u: ${APP.meta.totalQuestions} | Th·ªùi gian: ${APP.meta.durationMinutes} ph√∫t | ${APP.meta.examName || ""}`;

  // Overview groups table
  const gbody = document.getElementById("tblGroups");
  gbody.innerHTML = APP.computed.groups.map((g,i)=>`
    <tr>
      <td class="p-3 font-semibold">${escapeHtml(g.name)}</td>
      <td class="p-3 text-right">${g.credits}</td>
      <td class="p-3 text-right">${g.coef}</td>
      <td class="p-3 text-right">${fmtPct(g.rawPct)}</td>
      <td class="p-3 text-right">
        <input data-gmin="${i}" ${APP.lockMinMaxGroup?'disabled':''}
          class="input w-20 rounded-xl px-2 py-1 text-right"
          type="number" min="0" value="${g.min ?? ''}" placeholder="‚Äî">
      </td>
      <td class="p-3 text-right">
        <input data-gmax="${i}" ${APP.lockMinMaxGroup?'disabled':''}
          class="input w-20 rounded-xl px-2 py-1 text-right"
          type="number" min="0" value="${g.max ?? ''}" placeholder="‚Äî">
      </td>
      <td class="p-3 text-right font-bold">${g.q}</td>
    </tr>
  `).join("");

  // VDLS table
  const q = (document.getElementById("searchVDLS").value || "").trim().toLowerCase();
  const vbody = document.getElementById("tblVDLS");
  vbody.innerHTML = APP.computed.vdls
    .filter(v => !q || v.problem.toLowerCase().includes(q) || v.group.toLowerCase().includes(q))
    .map((v)=>`
      <tr>
        <td class="p-3 sticky-left font-semibold">${escapeHtml(v.group)}</td>
        <td class="p-3 sticky-left-2">${escapeHtml(v.problem)}</td>
        <td class="p-3 text-center">${badgeYesNo(v.include)}</td>
        <td class="p-3 text-right">
          <input data-vw="${escapeHtml(v.group)}|||${escapeHtml(v.problem)}" class="input w-20 rounded-xl px-2 py-1 text-right" type="number" min="0" value="${v.weight ?? 1}">
        </td>
        <td class="p-3 text-right">
          <input data-vmin="${escapeHtml(v.group)}|||${escapeHtml(v.problem)}" ${APP.lockMinMaxVDLS?'disabled':''}
            class="input w-20 rounded-xl px-2 py-1 text-right" type="number" min="0" value="${v.min ?? ''}" placeholder="‚Äî">
        </td>
        <td class="p-3 text-right">
          <input data-vmax="${escapeHtml(v.group)}|||${escapeHtml(v.problem)}" ${APP.lockMinMaxVDLS?'disabled':''}
            class="input w-20 rounded-xl px-2 py-1 text-right" type="number" min="0" value="${v.max ?? ''}" placeholder="‚Äî">
        </td>
        <td class="p-3 text-right font-bold">${v.q}</td>
      </tr>
    `).join("");

  // CLO table
  const filterGroup = document.getElementById("filterGroup").value || "";
  const qc = (document.getElementById("searchCLO").value || "").trim().toLowerCase();

  const cbody = document.getElementById("tblCLO");
  cbody.innerHTML = APP.computed.clo
    .filter(r => !filterGroup || r.group === filterGroup)
    .filter(r => !qc || r.problem.toLowerCase().includes(qc) || r.clo.toLowerCase().includes(qc) || r.group.toLowerCase().includes(qc))
    .map(r=>`
      <tr>
        <td class="p-3 sticky-left font-semibold">${escapeHtml(r.group)}</td>
        <td class="p-3 sticky-left-2">${escapeHtml(r.problem)}</td>
        <td class="p-3">${escapeHtml(r.clo)}</td>
        <td class="p-3 text-center"><span class="chip rounded-full px-3 py-1 text-xs font-semibold">${escapeHtml(r.bloom)}</span></td>
        <td class="p-3 text-center">${badgeYesNo(r.include)}</td>
        <td class="p-3 text-right">${r.weight ?? 1}</td>
        <td class="p-3 text-right font-bold">${r.q}</td>
      </tr>
    `).join("");

  // filterGroup options (t·ª´ allocations)
  const sel = document.getElementById("filterGroup");
  const current = sel.value;
  const uniqueGroups = Array.from(new Set(APP.allocations.map(x=>x.group))).filter(Boolean);
  sel.innerHTML = `<option value="">T·∫•t c·∫£ ph√¢n nh√≥m</option>` +
    uniqueGroups.map(g=>`<option ${g===current?'selected':''} value="${escapeHtml(g)}">${escapeHtml(g)}</option>`).join("");

  // Summary
  document.getElementById("sumGroups").textContent = APP.computed.totals.groups;
  document.getElementById("sumVDLS").textContent = APP.computed.totals.vdls;
  document.getElementById("sumCLO").textContent = APP.computed.totals.clo;

  const bt = APP.computed.totals.bloomTotals;
  document.getElementById("t_nho").textContent = bt.nho;
  document.getElementById("t_hieu").textContent = bt.hieu;
  document.getElementById("t_vd").textContent = bt.vd;
  document.getElementById("t_pt").textContent = bt.pt;
  document.getElementById("t_dg").textContent = bt.dg;
  document.getElementById("t_st").textContent = bt.st;

  // bloom sum hint
  const s = BLOOM_KEYS.reduce((a,b)=>a+(APP.bloomDefault[b.key]||0),0);
  document.getElementById("bloomSumHint").textContent = `T·ªïng Bloom hi·ªán t·∫°i = ${s}% (n√™n = 100%)`;

  // badge calc
  const ok = APP.computed.totals.groups === APP.meta.totalQuestions;
  document.getElementById("badgeCalc").textContent = ok ? "OK" : "ƒêang t√≠nh‚Ä¶";

  // keep CLO Add selectors in sync
  syncAddCloSelectors();
}

/* =========================================================
   G) CLO INPUT (ADD) - UI ‚Üí APP.allocations ‚Üí CLO_TSV
   ========================================================= */

function unique(list){ return Array.from(new Set(list)); }

function getGroupOptions(){
  const g1 = APP.groups.map(x=>x.name).filter(Boolean);
  const g2 = APP.allocations.map(x=>x.group).filter(Boolean);
  return unique([...g1, ...g2]);
}

function getProblemOptionsByGroup(group){
  const probs = APP.vdls.filter(x=>x.group===group).map(x=>x.problem).filter(Boolean);
  const probs2 = APP.allocations.filter(x=>x.group===group).map(x=>x.problem).filter(Boolean);
  return unique([...probs, ...probs2]);
}

function syncAddCloSelectors(){
  const selG = document.getElementById("addCloGroup");
  const selP = document.getElementById("addCloProblem");
  if (!selG || !selP) return;

  const groups = getGroupOptions();
  const prevG = selG.value || groups[0] || "";
  selG.innerHTML = groups.map(g=>`<option value="${escapeHtml(g)}">${escapeHtml(g)}</option>`).join("");
  if (prevG) selG.value = prevG;

  const probs = getProblemOptionsByGroup(selG.value);
  const prevP = selP.value || probs[0] || "";
  selP.innerHTML = probs.map(p=>`<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join("");
  if (prevP) selP.value = prevP;
}

function rebuildCLO_TSV_FromAllocations(){
  const header = "Ph√¢n nh√≥m VDLS\tCLO\tBLOOM\tTr·∫°ng th√°i\tTr·ªçng s·ªë\t% th√¥\tS·ªë c√¢u c·∫ßn\tS·ªë c√¢u so·∫°n";
  const lines = [header];

  const groups = unique(APP.allocations.map(x=>x.group).filter(Boolean));
  for(const g of groups){
    lines.push(`${g}\t\t\t\t\t\t\t`);
    const problems = unique(APP.allocations.filter(x=>x.group===g).map(x=>x.problem).filter(Boolean));
    for(const p of problems){
      lines.push(`${p}\t\t\t\t\t\t\t`);
      const rows = APP.allocations.filter(x=>x.group===g && x.problem===p);
      for(const r of rows){
        const st = r.include ? "C√≥" : "Kh√¥ng";
        lines.push(`\t${r.clo}\t${r.bloom}\t${st}\t${r.weight ?? 1}\t\t\t`);
      }
    }
  }
  return lines.join("\n");
}

function addCLO_Row({group, problem, clo, bloom, include, weight}){
  if(!group || !problem || !clo || !bloom) return {ok:false, msg:"‚ùå Thi·∫øu Group/VDLS/CLO/Bloom"};

  APP.allocations.push({
    group,
    problem,
    clo,
    bloom,
    include: yesNoToBool(include),
    weight: toNum(weight) ?? 1
  });

  const txtCLO = document.getElementById("txtCLO");
  const newTSV = rebuildCLO_TSV_FromAllocations();
  if (txtCLO) txtCLO.value = newTSV;
  CLO_TSV = newTSV.trim();

  render();
  return {ok:true, msg:"‚úÖ ƒê√£ th√™m CLO (ƒë√£ c·∫≠p nh·∫≠t CLO_TSV)."};
}

function autoGenerateCLOFromVDLS(){
  const templates = [
    { clo:"Ch·∫©n ƒëo√°n YHHƒê", bloom:"ƒê√°nh gi√°", include:"C√≥", weight:1 },
    { clo:"Ch·∫©n ƒëo√°n YHCT", bloom:"ƒê√°nh gi√°", include:"C√≥", weight:1 },
    { clo:"ƒêi·ªÅu tr·ªã YHHƒê",  bloom:"ƒê√°nh gi√°", include:"C√≥", weight:1 },
    { clo:"ƒêi·ªÅu tr·ªã YHCT",  bloom:"ƒê√°nh gi√°", include:"C√≥", weight:1 },
    { clo:"D·ª± ph√≤ng YHHƒê",  bloom:"Ph√¢n t√≠ch", include:"C√≥", weight:1 },
    { clo:"D·ª± ph√≤ng YHCT",  bloom:"Ph√¢n t√≠ch", include:"Kh√¥ng", weight:1 },
  ];

  // reset allocations
  APP.allocations = [];

  const groups = unique(APP.vdls.map(x=>x.group).filter(Boolean));
  for(const g of groups){
    const probs = unique(APP.vdls.filter(x=>x.group===g && x.include).map(x=>x.problem).filter(Boolean));
    for(const p of probs){
      for(const t of templates){
        APP.allocations.push({
          group: g,
          problem: p,
          clo: t.clo,
          bloom: t.bloom,
          include: yesNoToBool(t.include),
          weight: t.weight
        });
      }
    }
  }

  const txtCLO = document.getElementById("txtCLO");
  const newTSV = rebuildCLO_TSV_FromAllocations();
  if(txtCLO) txtCLO.value = newTSV;
  CLO_TSV = newTSV.trim();

  render();
}

/* =========================================================
   H) EXPORT + UI HELPERS
   ========================================================= */

function csvEscape(v){
  const s = String(v ?? "");
  if (s.includes(",") || s.includes('"') || s.includes("\n")) return `"${s.replaceAll('"','""')}"`;
  return s;
}

function downloadFile(filename, content, mime){
  const blob = new Blob([content], {type: mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* =========================================================
   I) EVENTS
   ========================================================= */

function bind(){
  // inputs
  const inpTotalQ = document.getElementById("inpTotalQ");
  const inpDuration = document.getElementById("inpDuration");
  const inpExamName = document.getElementById("inpExamName");
  const chkLockBloom = document.getElementById("chkLockBloom");
  const chkLockMinMaxGroup = document.getElementById("chkLockMinMaxGroup");
  const chkLockMinMaxVDLS = document.getElementById("chkLockMinMaxVDLS");

  inpTotalQ.value = APP.meta.totalQuestions;
  inpDuration.value = APP.meta.durationMinutes;
  inpExamName.value = APP.meta.examName;

  chkLockBloom.checked = APP.lockBloom;
  chkLockMinMaxGroup.checked = APP.lockMinMaxGroup;
  chkLockMinMaxVDLS.checked = APP.lockMinMaxVDLS;

  // bloom inputs
  document.getElementById("b_nho").value = APP.bloomDefault.nho;
  document.getElementById("b_hieu").value = APP.bloomDefault.hieu;
  document.getElementById("b_vd").value = APP.bloomDefault.vd;
  document.getElementById("b_pt").value = APP.bloomDefault.pt;
  document.getElementById("b_dg").value = APP.bloomDefault.dg;
  document.getElementById("b_st").value = APP.bloomDefault.st;

  inpTotalQ.addEventListener("input", ()=>{
    APP.meta.totalQuestions = Math.max(1, Math.floor(toNum(inpTotalQ.value) || 1));
    render();
  });
  inpDuration.addEventListener("input", ()=>{
    APP.meta.durationMinutes = Math.max(1, Math.floor(toNum(inpDuration.value) || 1));
    render();
  });
  inpExamName.addEventListener("input", ()=>{
    APP.meta.examName = inpExamName.value || "";
    render();
  });

  chkLockBloom.addEventListener("change", ()=>{
    APP.lockBloom = chkLockBloom.checked;
    render();
  });
  chkLockMinMaxGroup.addEventListener("change", ()=>{
    APP.lockMinMaxGroup = chkLockMinMaxGroup.checked;
    render();
  });
  chkLockMinMaxVDLS.addEventListener("change", ()=>{
    APP.lockMinMaxVDLS = chkLockMinMaxVDLS.checked;
    render();
  });

  document.getElementById("btnApplyBloom").addEventListener("click", ()=>{
    APP.bloomDefault.nho = clamp(toNum(document.getElementById("b_nho").value)||0,0,100);
    APP.bloomDefault.hieu = clamp(toNum(document.getElementById("b_hieu").value)||0,0,100);
    APP.bloomDefault.vd = clamp(toNum(document.getElementById("b_vd").value)||0,0,100);
    APP.bloomDefault.pt = clamp(toNum(document.getElementById("b_pt").value)||0,0,100);
    APP.bloomDefault.dg = clamp(toNum(document.getElementById("b_dg").value)||0,0,100);
    APP.bloomDefault.st = clamp(toNum(document.getElementById("b_st").value)||0,0,100);
    render();
  });

  // delegation for min/max + vdls weight
  document.addEventListener("input", (e)=>{
    const t = e.target;

    // group min/max
    if (t.dataset.gmin != null){
      const i = Number(t.dataset.gmin);
      APP.groups[i].min = (t.value==="" ? null : Math.max(0, Math.floor(toNum(t.value)||0)));
      render();
    }
    if (t.dataset.gmax != null){
      const i = Number(t.dataset.gmax);
      APP.groups[i].max = (t.value==="" ? null : Math.max(0, Math.floor(toNum(t.value)||0)));
      render();
    }

    // vdls weight
    if (t.dataset.vw){
      const key = t.dataset.vw;
      const [g,p] = key.split("|||");
      const item = APP.vdls.find(x=>x.group===g && x.problem===p);
      if (item){
        item.weight = Math.max(0, toNum(t.value) ?? 1);
        render();
      }
    }

    // vdls min/max
    if (t.dataset.vmin){
      const key = t.dataset.vmin;
      const [g,p] = key.split("|||");
      const item = APP.vdls.find(x=>x.group===g && x.problem===p);
      if (item){
        item.min = (t.value==="" ? null : Math.max(0, Math.floor(toNum(t.value)||0)));
        render();
      }
    }
    if (t.dataset.vmax){
      const key = t.dataset.vmax;
      const [g,p] = key.split("|||");
      const item = APP.vdls.find(x=>x.group===g && x.problem===p);
      if (item){
        item.max = (t.value==="" ? null : Math.max(0, Math.floor(toNum(t.value)||0)));
        render();
      }
    }
  });

  // search
  document.getElementById("searchVDLS").addEventListener("input", render);
  document.getElementById("searchCLO").addEventListener("input", render);
  document.getElementById("filterGroup").addEventListener("change", render);

  // tabs
  document.querySelectorAll(".tab").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const tabId = btn.dataset.tab;
      document.querySelectorAll(".tabPanel").forEach(p=>p.classList.add("hidden"));
      document.getElementById(tabId).classList.remove("hidden");

      document.querySelectorAll(".tab").forEach(b=>b.classList.remove("tab-active"));
      btn.classList.add("tab-active");
    });
  });

  // export JSON
  document.getElementById("btnExportJson").addEventListener("click", ()=>{
    const payload = {
      meta: APP.meta,
      bloomDefault: APP.bloomDefault,
      lockBloom: APP.lockBloom,
      lockMinMaxGroup: APP.lockMinMaxGroup,
      lockMinMaxVDLS: APP.lockMinMaxVDLS,
      groups: APP.groups,
      vdls: APP.vdls,
      allocations: APP.allocations,
      computed: APP.computed
    };
    downloadFile(`medmatrix_${Date.now()}.json`, JSON.stringify(payload, null, 2), "application/json");
  });

  // export CSV
  document.getElementById("btnExportCsv").addEventListener("click", ()=>{
    const rows = [["Ph√¢n nh√≥m","VDLS","CLO","Bloom","S·ªë c√¢u"]];
    (APP.computed?.clo || []).forEach(r=>{
      rows.push([r.group, r.problem, r.clo, r.bloom, String(r.q)]);
    });
    downloadFile(`medmatrix_export_${Date.now()}.csv`, rows.map(r=>r.map(csvEscape).join(",")).join("\n"), "text/csv;charset=utf-8");
  });

  // Embedded data tab (textarea)
  document.getElementById("txtGroup").value = GROUP_TSV;
  document.getElementById("txtVDLS").value = VDLS_TSV;
  document.getElementById("txtCLO").value = CLO_TSV;

  document.getElementById("btnReloadFromText").addEventListener("click", ()=>{
    GROUP_TSV = document.getElementById("txtGroup").value.trim();
    VDLS_TSV  = document.getElementById("txtVDLS").value.trim();
    CLO_TSV   = document.getElementById("txtCLO").value.trim();

    APP.groups = parseGroups(GROUP_TSV);
    APP.vdls = parseVDLS(VDLS_TSV);
    APP.allocations = parseCLO(CLO_TSV);

    render();
  });

  // ===== CLO ADD FORM =====
  syncAddCloSelectors();

  const selAddG = document.getElementById("addCloGroup");
  const msgAdd = document.getElementById("addCloMsg");

  if (selAddG){
    selAddG.addEventListener("change", ()=>{
      syncAddCloSelectors();
    });
  }

  const btnAdd = document.getElementById("btnAddCLO");
  if (btnAdd){
    btnAdd.addEventListener("click", ()=>{
      const group = document.getElementById("addCloGroup").value;
      const problem = document.getElementById("addCloProblem").value;
      const clo = (document.getElementById("addCloName").value || "").trim();
      const bloom = document.getElementById("addCloBloom").value;
      const include = document.getElementById("addCloInclude").value;
      const weight = document.getElementById("addCloWeight").value;

      const res = addCLO_Row({group, problem, clo, bloom, include, weight});
      if (msgAdd) msgAdd.textContent = res.msg;
      if (res.ok) document.getElementById("addCloName").value = "";
    });
  }

  const btnAuto = document.getElementById("btnAutoCLO");
  if (btnAuto){
    btnAuto.addEventListener("click", ()=>{
      autoGenerateCLOFromVDLS();
      if (msgAdd) msgAdd.textContent = "‚úÖ ƒê√£ t·∫°o khung CLO/Bloom t·ª´ VDLS.";
    });
  }

  const btnRebuild = document.getElementById("btnRebuildCLO_TSV");
  if (btnRebuild){
    btnRebuild.addEventListener("click", ()=>{
      const txtCLO = document.getElementById("txtCLO");
      const tsv = rebuildCLO_TSV_FromAllocations();
      if (txtCLO) txtCLO.value = tsv;
      CLO_TSV = tsv.trim();
      if (msgAdd) msgAdd.textContent = "‚úÖ ƒê√£ xu·∫•t l·∫°i CLO_TSV t·ª´ d·ªØ li·ªáu hi·ªán c√≥.";
      render();
    });
  }
}

/* =========================================================
   J) Splitter init
   ========================================================= */
function initSplitter(){
  const splitter = document.getElementById("splitter");
  const left = document.getElementById("paneLeft");
  let dragging = false;

  splitter.addEventListener("mousedown", (e)=>{
    dragging = true;
    document.body.classList.add("noselect");
    e.preventDefault();
  });

  window.addEventListener("mousemove", (e)=>{
    if(!dragging) return;
    const x = e.clientX;
    const wrapLeft = left.parentElement.getBoundingClientRect().left;
    const newW = Math.max(320, Math.min(700, x - wrapLeft));
    left.style.width = newW + "px";
  });

  window.addEventListener("mouseup", ()=>{
    dragging = false;
    document.body.classList.remove("noselect");
  });
}

/* =========================================================
   INIT
   ========================================================= */
bind();
render();
initSplitter();

</script>
</body>
</html>
