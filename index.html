<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MedMatrix VDLS + Bloom (Editable + Excel + Resize)</title>
  <meta name="theme-color" content="#2563eb" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- SheetJS (Excel export) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --colGroupW: 280px; /* resizable */
      --colVdlsW: 520px;  /* resizable */
    }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .table-scroll::-webkit-scrollbar { height: 10px; width: 10px; }
    .table-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 999px; }
    .sticky-top { position: sticky; top: 0; z-index: 30; }
    .sticky-left { position: sticky; left: 0; z-index: 20; background: white; }
    .sticky-left-2 { position: sticky; left: var(--colGroupW); z-index: 19; background: white; }
    .shadow-soft { box-shadow: 0 10px 30px rgba(2, 6, 23, 0.08); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .chip { border: 1px solid #e2e8f0; background: #f8fafc; }
    .btn { border: 1px solid #e2e8f0; background: white; }
    .btn:hover { background: #f8fafc; }
    .btn-primary { background: #2563eb; color: white; border-color: #2563eb; }
    .btn-primary:hover { filter: brightness(0.95); }
    .btn-green { background: #10b981; color: white; border-color: #10b981; }
    .btn-green:hover { filter: brightness(0.95); }
    .btn-purple { background: #7c3aed; color: white; border-color: #7c3aed; }
    .btn-purple:hover { filter: brightness(0.95); }
    .btn-red { background: #ef4444; color: white; border-color: #ef4444; }
    .btn-red:hover { filter: brightness(0.95); }
    .input { border: 1px solid #e2e8f0; background: white; }
    .input:focus { outline: 2px solid rgba(37,99,235,.25); border-color: #93c5fd; }
    .tab-active { background: #2563eb; color: white; border-color: #2563eb; }
    .editable { outline: none; }
    .editable:focus { box-shadow: 0 0 0 2px rgba(37,99,235,.25); border-radius: 10px; }
    .th-resize { position: relative; }
    .resizer {
      position: absolute;
      top: 0; right: 0;
      width: 10px; height: 100%;
      cursor: col-resize;
      user-select: none;
      touch-action: none;
    }
    .resizer::after{
      content:"";
      position:absolute;
      top: 25%;
      right: 4px;
      width: 2px;
      height: 50%;
      background:#e2e8f0;
      border-radius:999px;
    }
    .modal-backdrop{
      position: fixed; inset:0;
      background: rgba(2,6,23,.5);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 60;
      padding: 16px;
    }
    .modal-backdrop.show{ display:flex; }
  </style>
</head>

<body class="bg-slate-50 text-slate-900">
  <div class="max-w-[1400px] mx-auto p-4 md:p-6">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
      <div>
        <div class="text-2xl font-bold">MedMatrix ‚Äì VDLS & Bloom</div>
        <div class="text-sm text-slate-600">Ch·ªânh s·ª≠a tr·ª±c ti·∫øp ‚Ä¢ L∆∞u t·ª± ƒë·ªông ‚Ä¢ K√©o d√£n c·ªôt ‚Ä¢ Xu·∫•t Excel</div>
      </div>
      <div class="flex flex-wrap gap-2">
        <button id="btnExportJson" class="btn rounded-xl px-4 py-2 text-sm font-semibold">Xu·∫•t JSON</button>
        <button id="btnExportExcel" class="btn-green rounded-xl px-4 py-2 text-sm font-semibold">Xu·∫•t Excel</button>
        <button id="btnResetLocal" class="btn-red rounded-xl px-4 py-2 text-sm font-semibold">Reset ƒë√£ l∆∞u</button>
      </div>
    </div>

    <!-- Tabs -->
    <div class="flex flex-wrap gap-2 mb-4">
      <button data-tab="tabOverview" class="tab btn tab-active rounded-xl px-4 py-2 text-sm font-semibold">T·ªïng quan</button>
      <button data-tab="tabGroups" class="tab btn rounded-xl px-4 py-2 text-sm font-semibold">Ph√¢n nh√≥m & VDLS</button>
      <button data-tab="tabBloom" class="tab btn rounded-xl px-4 py-2 text-sm font-semibold">Chi ti·∫øt CLO & Bloom</button>
      <button data-tab="tabData" class="tab btn rounded-xl px-4 py-2 text-sm font-semibold">D·ªØ li·ªáu nh√∫ng</button>
    </div>

    <!-- Main grid -->
    <div class="grid grid-cols-12 gap-4">
      <!-- Left column controls -->
      <div class="col-span-12 lg:col-span-4 space-y-4">
        <!-- Th√¥ng s·ªë chung -->
        <div class="bg-white rounded-2xl p-4 shadow-soft border border-slate-200">
          <div class="flex items-center gap-2 mb-3">
            <span class="inline-flex w-9 h-9 rounded-xl items-center justify-center bg-slate-100">‚öôÔ∏è</span>
            <div class="font-bold">TH√îNG S·ªê CHUNG</div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-xs text-slate-600">T·ªïng s·ªë c√¢u h·ªèi</label>
              <input id="inpTotalQ" type="number" class="input w-full rounded-xl px-3 py-2 mt-1" min="1" step="1">
            </div>
            <div>
              <label class="text-xs text-slate-600">Th·ªùi gian l√†m b√†i (ph√∫t)</label>
              <input id="inpDuration" type="number" class="input w-full rounded-xl px-3 py-2 mt-1" min="1" step="1">
            </div>
          </div>

          <div class="mt-3">
            <label class="text-xs text-slate-600">K·ª≥ thi</label>
            <input id="inpExamName" type="text" class="input w-full rounded-xl px-3 py-2 mt-1" placeholder="VD: Thi cu·ªëi k·ª≥...">
          </div>

          <div class="mt-4 grid grid-cols-2 gap-3">
            <label class="flex items-center gap-2 text-sm">
              <input id="chkLockMinMaxGroup" type="checkbox" class="w-4 h-4">
              Kh√≥a Min/Max theo Ph√¢n nh√≥m
            </label>
            <label class="flex items-center gap-2 text-sm">
              <input id="chkLockMinMaxVDLS" type="checkbox" class="w-4 h-4">
              Kh√≥a Min/Max theo VDLS
            </label>
          </div>

          <div class="mt-3">
            <label class="flex items-center gap-2 text-sm">
              <input id="chkTeachWeightOnGroups" type="checkbox" class="w-4 h-4">
              D√πng ‚Äúƒê∆∞·ª£c d·∫°y‚Äù VDLS ƒë·ªÉ thay ƒë·ªïi % c√¢u theo Ph√¢n nh√≥m
            </label>
            <div class="text-xs text-slate-500 mt-1">
              N·∫øu b·∫≠t: tr·ªçng s·ªë nh√≥m = (T√≠n ch·ªâ √ó H·ªá s·ªë) √ó (t·ªïng tr·ªçng s·ªë VDLS ‚Äúƒë∆∞·ª£c d·∫°y‚Äù trong nh√≥m).
            </div>
          </div>
        </div>

        <!-- Bloom default -->
        <div class="bg-white rounded-2xl p-4 shadow-soft border border-slate-200">
          <div class="flex items-center gap-2 mb-3">
            <span class="inline-flex w-9 h-9 rounded-xl items-center justify-center bg-slate-100">üß†</span>
            <div class="font-bold">BLOOM M·∫∂C ƒê·ªäNH (%)</div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-xs text-slate-600">Nh·ªõ</label>
              <input id="b_nho" type="number" class="input w-full rounded-xl px-3 py-2 mt-1" min="0" max="100">
            </div>
            <div>
              <label class="text-xs text-slate-600">Hi·ªÉu</label>
              <input id="b_hieu" type="number" class="input w-full rounded-xl px-3 py-2 mt-1" min="0" max="100">
            </div>
            <div>
              <label class="text-xs text-slate-600">V·∫≠n d·ª•ng</label>
              <input id="b_vd" type="number" class="input w-full rounded-xl px-3 py-2 mt-1" min="0" max="100">
            </div>
            <div>
              <label class="text-xs text-slate-600">Ph√¢n t√≠ch</label>
              <input id="b_pt" type="number" class="input w-full rounded-xl px-3 py-2 mt-1" min="0" max="100">
            </div>
            <div>
              <label class="text-xs text-slate-600">ƒê√°nh gi√°</label>
              <input id="b_dg" type="number" class="input w-full rounded-xl px-3 py-2 mt-1" min="0" max="100">
            </div>
            <div>
              <label class="text-xs text-slate-600">S√°ng t·∫°o</label>
              <input id="b_st" type="number" class="input w-full rounded-xl px-3 py-2 mt-1" min="0" max="100">
            </div>
          </div>

          <div class="mt-3 flex items-center justify-between gap-3">
            <label class="flex items-center gap-2 text-sm">
              <input id="chkLockBloom" type="checkbox" class="w-4 h-4">
              Kh√≥a Bloom (ch·ªâ hi·ªÉn th·ªã m·ª•c ti√™u)
            </label>
            <button id="btnApplyBloom" class="btn-purple rounded-xl px-4 py-2 text-sm font-semibold">√Åp d·ª•ng Bloom</button>
          </div>

          <div id="bloomSumHint" class="mt-2 text-xs text-slate-600"></div>
        </div>

        <!-- Summary -->
        <div class="bg-white rounded-2xl p-4 shadow-soft border border-slate-200">
          <div class="flex items-center justify-between mb-2">
            <div class="font-bold">KI·ªÇM TRA T·ªîNG C√ÇU</div>
            <span id="badgeCalc" class="chip rounded-full px-3 py-1 text-xs font-semibold">ƒêang t√≠nh‚Ä¶</span>
          </div>

          <div class="grid grid-cols-3 gap-2 text-sm mt-2">
            <div class="chip rounded-xl p-3">
              <div class="text-xs text-slate-600">T·ªïng nh√≥m</div>
              <div class="text-lg font-bold" id="sumGroups">0</div>
            </div>
            <div class="chip rounded-xl p-3">
              <div class="text-xs text-slate-600">T·ªïng VDLS</div>
              <div class="text-lg font-bold" id="sumVDLS">0</div>
            </div>
            <div class="chip rounded-xl p-3">
              <div class="text-xs text-slate-600">T·ªïng CLO</div>
              <div class="text-lg font-bold" id="sumCLO">0</div>
            </div>
          </div>

          <div class="mt-3 grid grid-cols-6 gap-2 text-xs">
            <div class="chip rounded-xl p-2">
              <div class="text-slate-500">Nh·ªõ</div>
              <div class="font-bold text-base" id="t_nho">0</div>
            </div>
            <div class="chip rounded-xl p-2">
              <div class="text-slate-500">Hi·ªÉu</div>
              <div class="font-bold text-base" id="t_hieu">0</div>
            </div>
            <div class="chip rounded-xl p-2">
              <div class="text-slate-500">V.D·ª•ng</div>
              <div class="font-bold text-base" id="t_vd">0</div>
            </div>
            <div class="chip rounded-xl p-2">
              <div class="text-slate-500">P.T√≠ch</div>
              <div class="font-bold text-base" id="t_pt">0</div>
            </div>
            <div class="chip rounded-xl p-2">
              <div class="text-slate-500">ƒê.Gi√°</div>
              <div class="font-bold text-base" id="t_dg">0</div>
            </div>
            <div class="chip rounded-xl p-2">
              <div class="text-slate-500">S.T·∫°o</div>
              <div class="font-bold text-base" id="t_st">0</div>
            </div>
          </div>

          <div class="mt-2 text-xs text-slate-500">
            Tip: tick ‚Äúƒê∆∞·ª£c d·∫°y‚Äù ·ªü VDLS ƒë·ªÉ thay ƒë·ªïi % c√¢u (n·∫øu b·∫≠t t√πy ch·ªçn b√™n tr√™n).
          </div>
        </div>

        <!-- Column width (quick) -->
        <div class="bg-white rounded-2xl p-4 shadow-soft border border-slate-200">
          <div class="flex items-center gap-2 mb-2">
            <span class="inline-flex w-9 h-9 rounded-xl items-center justify-center bg-slate-100">‚ÜîÔ∏è</span>
            <div class="font-bold">ƒê·ªò R·ªòNG C·ªòT (NHANH)</div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-xs text-slate-600">C·ªôt ‚ÄúPh√¢n nh√≥m‚Äù (px)</label>
              <input id="inpColGroupW" type="number" class="input w-full rounded-xl px-3 py-2 mt-1" min="160" step="10">
            </div>
            <div>
              <label class="text-xs text-slate-600">C·ªôt ‚ÄúVDLS‚Äù (px)</label>
              <input id="inpColVdlsW" type="number" class="input w-full rounded-xl px-3 py-2 mt-1" min="260" step="10">
            </div>
          </div>
          <div class="text-xs text-slate-500 mt-2">
            B·∫°n c≈©ng c√≥ th·ªÉ k√©o thanh nh·ªè ·ªü vi·ªÅn ph·∫£i ti√™u ƒë·ªÅ c·ªôt (drag).
          </div>
        </div>
      </div>

      <!-- Right column content -->
      <div class="col-span-12 lg:col-span-8">
        <!-- Tab: Overview -->
        <div id="tabOverview" class="tabPanel bg-white rounded-2xl shadow-soft border border-slate-200 p-4">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-lg font-bold">T·ªïng quan ph√¢n b·ªï</div>
              <div class="text-sm text-slate-600">T√≠nh theo T√≠n ch·ªâ √ó H·ªá s·ªë ‚Üí % th√¥ ‚Üí ph√¢n b·ªï s·ªë c√¢u</div>
            </div>
            <div class="text-xs text-slate-500 mono" id="metaLine"></div>
          </div>

          <div class="mt-4 table-scroll overflow-auto border border-slate-200 rounded-2xl">
            <table class="min-w-[980px] w-full text-sm">
              <thead class="sticky-top bg-slate-50 border-b border-slate-200">
                <tr>
                  <th class="text-left p-3 w-[280px]">Ph√¢n nh√≥m</th>
                  <th class="text-right p-3">T√≠n ch·ªâ</th>
                  <th class="text-right p-3">H·ªá s·ªë</th>
                  <th class="text-right p-3">% th√¥</th>
                  <th class="text-right p-3">Min</th>
                  <th class="text-right p-3">Max</th>
                  <th class="text-right p-3">S·ªë c√¢u</th>
                </tr>
              </thead>
              <tbody id="tblGroups" class="divide-y divide-slate-100"></tbody>
            </table>
          </div>

          <div class="mt-3 text-xs text-slate-500">
            ‚Ä¢ Min/Max tr·ªëng = kh√¥ng r√†ng bu·ªôc. ‚Ä¢ L√†m tr√≤n theo ‚Äúlargest remainder‚Äù ƒë·ªÉ t·ªïng ƒë√∫ng.
          </div>
        </div>

        <!-- Tab: Groups & VDLS -->
        <div id="tabGroups" class="tabPanel hidden bg-white rounded-2xl shadow-soft border border-slate-200 p-4">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div>
              <div class="text-lg font-bold">Ph√¢n nh√≥m & VDLS</div>
              <div class="text-sm text-slate-600">Ch·ªânh tr·ª±c ti·∫øp: ‚Äúƒê∆∞·ª£c d·∫°y‚Äù, tr·ªçng s·ªë, n·ªôi dung VDLS</div>
            </div>
            <div class="flex gap-2 flex-wrap justify-end">
              <input id="searchVDLS" class="input rounded-xl px-3 py-2 text-sm w-[280px]" placeholder="T√¨m VDLS...">
              <button id="btnAddVDLS" class="btn-primary rounded-xl px-4 py-2 text-sm font-semibold">+ Th√™m VDLS</button>
            </div>
          </div>

          <div class="mt-4 table-scroll overflow-auto border border-slate-200 rounded-2xl">
            <table class="min-w-[1200px] w-full text-sm">
              <thead class="sticky-top bg-slate-50 border-b border-slate-200">
                <tr>
                  <th class="text-left p-3 sticky-left th-resize" style="width: var(--colGroupW);">
                    Ph√¢n nh√≥m
                    <span class="resizer" data-resize-col="group"></span>
                  </th>
                  <th class="text-left p-3 sticky-left-2 th-resize" style="width: var(--colVdlsW);">
                    VDLS (v·∫•n ƒë·ªÅ l√¢m s√†ng)
                    <span class="resizer" data-resize-col="vdls"></span>
                  </th>
                  <th class="text-center p-3">ƒê∆∞·ª£c d·∫°y</th>
                  <th class="text-right p-3">Tr·ªçng s·ªë</th>
                  <th class="text-right p-3">Min</th>
                  <th class="text-right p-3">Max</th>
                  <th class="text-right p-3">S·ªë c√¢u</th>
                  <th class="text-center p-3">X√≥a</th>
                </tr>
              </thead>
              <tbody id="tblVDLS" class="divide-y divide-slate-100"></tbody>
            </table>
          </div>

          <div class="mt-3 text-xs text-slate-500">
            ‚Ä¢ B·∫°n c√≥ th·ªÉ click v√†o text VDLS ƒë·ªÉ s·ª≠a. ‚Ä¢ X√≥a VDLS s·∫Ω ƒë·ªìng th·ªùi x√≥a c√°c d√≤ng CLO li√™n quan.
          </div>
        </div>

        <!-- Tab: CLO & Bloom -->
        <div id="tabBloom" class="tabPanel hidden bg-white rounded-2xl shadow-soft border border-slate-200 p-4">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div>
              <div class="text-lg font-bold">Chi ti·∫øt CLO & Bloom</div>
              <div class="text-sm text-slate-600">Ch·ªânh tr·ª±c ti·∫øp: ‚Äúƒê∆∞·ª£c d·∫°y‚Äù, Bloom, tr·ªçng s·ªë, n·ªôi dung CLO</div>
            </div>
            <div class="flex flex-wrap gap-2 items-center justify-end">
              <select id="filterGroup" class="input rounded-xl px-3 py-2 text-sm">
                <option value="">T·∫•t c·∫£ ph√¢n nh√≥m</option>
              </select>
              <input id="searchCLO" class="input rounded-xl px-3 py-2 text-sm w-[260px]" placeholder="T√¨m CLO / VDLS...">
              <button id="btnAddCLO" class="btn-primary rounded-xl px-4 py-2 text-sm font-semibold">+ Th√™m CLO</button>
            </div>
          </div>

          <div class="mt-4 table-scroll overflow-auto border border-slate-200 rounded-2xl">
            <table class="min-w-[1600px] w-full text-sm">
              <thead class="sticky-top bg-slate-50 border-b border-slate-200">
                <tr>
                  <th class="text-left p-3 sticky-left th-resize" style="width: var(--colGroupW);">
                    Ph√¢n nh√≥m
                    <span class="resizer" data-resize-col="group"></span>
                  </th>
                  <th class="text-left p-3 sticky-left-2 th-resize" style="width: var(--colVdlsW);">
                    VDLS
                    <span class="resizer" data-resize-col="vdls"></span>
                  </th>
                  <th class="text-left p-3">CLO</th>
                  <th class="text-center p-3">Bloom</th>
                  <th class="text-center p-3">ƒê∆∞·ª£c d·∫°y</th>
                  <th class="text-right p-3">Tr·ªçng s·ªë</th>
                  <th class="text-right p-3">S·ªë c√¢u</th>
                  <th class="text-center p-3">X√≥a</th>
                </tr>
              </thead>
              <tbody id="tblCLO" class="divide-y divide-slate-100"></tbody>
            </table>
          </div>

          <div class="mt-3 text-xs text-slate-500">
            ‚Ä¢ Bloom l√† dropdown. ‚Ä¢ Tick ‚Äúƒê∆∞·ª£c d·∫°y‚Äù ƒë·ªÉ ƒë∆∞a v√†o ph√¢n b·ªï. ‚Ä¢ S·ªë c√¢u = ph√¢n b·ªï theo VDLS ‚Üí CLO.
          </div>
        </div>

        <!-- Tab: Embedded data -->
        <div id="tabData" class="tabPanel hidden bg-white rounded-2xl shadow-soft border border-slate-200 p-4">
          <div class="text-lg font-bold">D·ªØ li·ªáu nh√∫ng (TSV)</div>
          <div class="text-sm text-slate-600">B·∫°n c√≥ th·ªÉ d√°n/s·ª≠a TSV v√† b·∫•m ‚ÄúN·∫°p l·∫°i‚Äù. App s·∫Ω parse + t√≠nh l·∫°i.</div>

          <div class="grid grid-cols-1 gap-4 mt-4">
            <div>
              <div class="text-sm font-semibold mb-2">GROUP_TSV</div>
              <textarea id="txtGroup" class="input w-full rounded-2xl p-3 h-[220px] mono text-xs"></textarea>
            </div>
            <div>
              <div class="text-sm font-semibold mb-2">VDLS_TSV</div>
              <textarea id="txtVDLS" class="input w-full rounded-2xl p-3 h-[260px] mono text-xs"></textarea>
            </div>
            <div>
              <div class="text-sm font-semibold mb-2">CLO_TSV</div>
              <textarea id="txtCLO" class="input w-full rounded-2xl p-3 h-[320px] mono text-xs"></textarea>
            </div>
            <div class="flex gap-2 flex-wrap">
              <button id="btnReloadFromText" class="btn-primary rounded-xl px-4 py-2 text-sm font-semibold">N·∫°p l·∫°i d·ªØ li·ªáu t·ª´ textarea</button>
              <button id="btnSaveToLocal" class="btn rounded-xl px-4 py-2 text-sm font-semibold">L∆∞u TSV v√†o tr√¨nh duy·ªát</button>
              <button id="btnLoadFromLocal" class="btn rounded-xl px-4 py-2 text-sm font-semibold">N·∫°p TSV ƒë√£ l∆∞u</button>
              <div class="text-xs text-slate-500 self-center">* L∆∞u TSV ƒë·ªÉ l·∫ßn sau m·ªü l·∫°i kh√¥ng m·∫•t.</div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Modal: Add VDLS -->
  <div id="modalVDLS" class="modal-backdrop">
    <div class="bg-white w-full max-w-[640px] rounded-2xl border border-slate-200 shadow-soft p-4">
      <div class="flex items-center justify-between">
        <div class="font-bold text-lg">Th√™m VDLS (V·∫•n ƒë·ªÅ l√¢m s√†ng)</div>
        <button class="btn rounded-xl px-3 py-2 text-sm" data-close-modal="modalVDLS">ƒê√≥ng</button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4">
        <div>
          <label class="text-xs text-slate-600">Ph√¢n nh√≥m</label>
          <select id="addVdlsGroup" class="input w-full rounded-xl px-3 py-2 mt-1"></select>
        </div>
        <div>
          <label class="text-xs text-slate-600">Tr·ªçng s·ªë</label>
          <input id="addVdlsWeight" type="number" min="0" step="0.1" class="input w-full rounded-xl px-3 py-2 mt-1" value="1">
        </div>
        <div class="md:col-span-2">
          <label class="text-xs text-slate-600">N·ªôi dung VDLS</label>
          <textarea id="addVdlsText" class="input w-full rounded-xl px-3 py-2 mt-1 h-[90px]" placeholder="VD: YHHƒê: M√†y ƒëay."></textarea>
        </div>
        <div class="md:col-span-2 flex items-center justify-between gap-3">
          <label class="flex items-center gap-2 text-sm">
            <input id="addVdlsInclude" type="checkbox" class="w-4 h-4" checked>
            ƒê∆∞·ª£c d·∫°y
          </label>
          <button id="btnConfirmAddVDLS" class="btn-primary rounded-xl px-4 py-2 text-sm font-semibold">Th√™m</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Add CLO -->
  <div id="modalCLO" class="modal-backdrop">
    <div class="bg-white w-full max-w-[760px] rounded-2xl border border-slate-200 shadow-soft p-4">
      <div class="flex items-center justify-between">
        <div class="font-bold text-lg">Th√™m CLO</div>
        <button class="btn rounded-xl px-3 py-2 text-sm" data-close-modal="modalCLO">ƒê√≥ng</button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4">
        <div>
          <label class="text-xs text-slate-600">Ph√¢n nh√≥m</label>
          <select id="addCloGroup" class="input w-full rounded-xl px-3 py-2 mt-1"></select>
        </div>
        <div>
          <label class="text-xs text-slate-600">VDLS</label>
          <select id="addCloProblem" class="input w-full rounded-xl px-3 py-2 mt-1"></select>
        </div>
        <div class="md:col-span-2">
          <label class="text-xs text-slate-600">CLO</label>
          <input id="addCloText" type="text" class="input w-full rounded-xl px-3 py-2 mt-1" placeholder="VD: Ch·∫©n ƒëo√°n YHHƒê">
        </div>
        <div>
          <label class="text-xs text-slate-600">Bloom</label>
          <select id="addCloBloom" class="input w-full rounded-xl px-3 py-2 mt-1">
            <option>Nh·ªõ</option>
            <option>Hi·ªÉu</option>
            <option>V·∫≠n d·ª•ng</option>
            <option>Ph√¢n t√≠ch</option>
            <option>ƒê√°nh gi√°</option>
            <option>S√°ng t·∫°o</option>
          </select>
        </div>
        <div>
          <label class="text-xs text-slate-600">Tr·ªçng s·ªë</label>
          <input id="addCloWeight" type="number" min="0" step="0.1" class="input w-full rounded-xl px-3 py-2 mt-1" value="1">
        </div>
        <div class="md:col-span-2 flex items-center justify-between gap-3">
          <label class="flex items-center gap-2 text-sm">
            <input id="addCloInclude" type="checkbox" class="w-4 h-4" checked>
            ƒê∆∞·ª£c d·∫°y
          </label>
          <button id="btnConfirmAddCLO" class="btn-primary rounded-xl px-4 py-2 text-sm font-semibold">Th√™m</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================================================
   A) D·ªÆ LI·ªÜU NH√öNG (TSV) ‚Äî B·∫†N C√ì TH·ªÇ D√ÅN/S·ª¨A TRONG TAB ‚ÄúD·ªÆ LI·ªÜU NH√öNG‚Äù
   ========================================================= */

let GROUP_TSV = `
Ph√¢n nh√≥m	T√≠n ch·ªâ	H·ªá s·ªë	% th√¥	T·ª∑ l·ªá (%) min	T·ª∑ l·ªá (%) max	S·ªë c√¢u	S·ªë VDLS
B·ªánh T·∫°ng ph·ªß	4	2	9.09%			11	4
B·ªánh h·ªá th·ªëng Tim m·∫°ch ‚Äì h√¥ h·∫•p 	6	2	13.64%			16	5
B·ªánh h·ªá th·ªëng Ti·∫øt ni·ªáu ‚Äì N·ªôi ti·∫øt - Huy·∫øt h·ªçc	5	2	11.36%			14	5
B·ªánh h·ªá th·ªëng Ti√™u h√≥a - gan m·∫≠t	5	2	11.36%			14	5
B·ªánh h·ªá th·ªëng Ng≈© quan ‚Äì L√£o khoa	4	1	4.55%			5	2
B·ªánh h·ªá th·ªëng C∆° - x∆∞∆°ng ‚Äì kh·ªõp	4	3	13.64%			16	5
B·ªánh h·ªá th·ªëng Th·∫ßn kinh	4	3	13.64%			16	5
B·ªánh h·ªá th·ªëng Nhi·ªÖm ‚Äì Ph·ª•	8	1	9.09%			11	4
B·ªánh h·ªá th·ªëng Nhi khoa	4	1	4.55%			5	2
B·ªánh h·ªá th·ªëng Ngo·∫°i khoa - Da li·ªÖu	8	1	9.09%			11	4
T·ªïng	52	18	100%			120	40
`.trim();

let VDLS_TSV = `
Ph√¢n nh√≥m VDLS	T√¨nh tr·∫°ng	T·ª∑ tr·ªçng	% th√¥	T·ª∑ l·ªá (%) min	T·ª∑ l·ªá (%) max	S·ªë c√¢u
B·ªánh T·∫°ng ph·ªß			9.09%	0%	0%
Bi·ªán ch·ª©ng t·∫°ng ph·ªß	C√≥	1	9.09%			11
B·ªánh h·ªá th·ªëng Tim m·∫°ch ‚Äì h√¥ h·∫•p 			13.64%	0%	0%
YHHƒê: B·ªánh m·∫°ch v√†nh m·∫°n. YHCT: T√¢m th·ªëng.	C√≥	1	2.73%			3
YHHƒê: TƒÉng huy·∫øt √°p. YHCT: Huy·ªÖn v·ª±ng.	C√≥	1	2.73%			3
YHHƒê: Suy tƒ©nh m·∫°ch m·∫°n t√≠nh.	C√≥	1	2.73%			3
YHHƒê: COPD. 	C√≥	1	2.73%			3
YHHƒê: Hen ph·∫ø qu·∫£n. YHCT: H√°o ch·ª©ng, suy·ªÖn ch·ª©ng.	C√≥	1	2.73%			3
B·ªánh h·ªá th·ªëng Ti·∫øt ni·ªáu ‚Äì N·ªôi ti·∫øt - Huy·∫øt h·ªçc			11.36%	0%	0%
YHHƒê: Nhi·ªÖm khu·∫©n ti·∫øt ni·ªáu. YHCT: L√¢m ch·ª©ng. 	C√≥	1	2.84%			3
YHHƒê: B√©o ph√¨. YHCT: Ph√¨ b·∫°ng.	C√≥	1	2.84%			3
YHHƒê: ƒê√°i th√°o ƒë∆∞·ªùng. YHCT: Ti√™u kh√°t.	C√≥	1	2.84%			3
YHHƒê: Thi·∫øu m√°u m·∫°n.	C√≥	1	2.84%			3
B·ªánh h·ªá th·ªëng Ti√™u h√≥a - gan m·∫≠t			11.36%	0%	0%
YHHƒê: Vi√™m lo√©t d·∫° d√†y t√° tr√†ng. YHCT: V·ªã qu·∫£n th·ªëng, Ph√∫c m√£n, Bƒ© m√£n, Ch·ª©ng tr∆∞·ªõng.	C√≥	1	2.27%			3
YHHƒê: GERD. YHCT: Hung th·ªëng, √Åi kh√≠. 	C√≥	1	2.27%			3
YHHƒê: H·ªôi ch·ª©ng ru·ªôt k√≠ch th√≠ch. YHCT: Ti·∫øt t·∫£, Ph√∫c m√£n, Ti·ªán b√≠.	C√≥	1	2.27%			3
YHHƒê: Vi√™m gan m·∫°n. YHCT: Ho√†ng ƒë·∫£n, ch·ª©ng tr∆∞·ªõng.	C√≥	1	2.27%			3
YHHƒê: X∆° gan. YHCT: Ho√†ng ƒë·∫£n, C·ªï tr∆∞·ªõng.	C√≥	1	2.27%			3
B·ªánh h·ªá th·ªëng Ng≈© quan ‚Äì L√£o khoa			4.55%	0%	0%
YHHƒê: B·ªánh th·∫≠n m·∫°n. YHCT: H∆∞ lao. 	C√≥	1	2.27%			3
YHHƒê: Vi√™m m≈©i d·ªã ·ª©ng.	C√≥	1	2.27%			3
B·ªánh h·ªá th·ªëng C∆° - x∆∞∆°ng ‚Äì kh·ªõp			13.64%	0%	0%
YHHƒê: Tho√°i h√≥a c·ªôt s·ªëng th·∫Øt l∆∞ng. YHCT: T√Ω ch·ª©ng, Y√™u th·ªëng.	C√≥	1	2.73%			3
YHHƒê: Tho√°i h√≥a kh·ªõp g·ªëi. YHCT: T√Ω ch·ª©ng, H·∫°c t·∫•t phong.	C√≥	1	2.73%			3
YHHƒê: Lo√£ng x∆∞∆°ng.	C√≥	1	2.73%			3
YHHƒê: Vi√™m kh·ªõp d·∫°ng th·∫•p. YHCT: T√Ω ch·ª©ng.	C√≥	1	2.73%			3
YHHƒê: Vi√™m kh·ªõp gout. YHCT: T√Ω ch·ª©ng, Th·ªëng phong.	C√≥	1	2.73%			3
B·ªánh h·ªá th·ªëng Th·∫ßn kinh			13.64%	0%	0%
YHHƒê: Di ch·ª©ng tai bi·∫øn m·∫°ch m√°u n√£o. YHCT: B√°n th√¢n b·∫•t to·∫°i.	C√≥	1	2.73%			3
YHHƒê: ƒêau ƒë·∫ßu. YHCT: ƒê·∫ßu th·ªëng, ƒê√†m ch·ª©ng.	C√≥	1	2.73%			3
YHHƒê: ƒêau th·∫ßn kinh t·ªça. YHCT: Y√™u th·ªëng, Y√™u c∆∞·ªõc th·ªëng, T·ªça c·ªët phong, Ma m·ªôc b·∫•t nh√¢n.	C√≥	1	2.73%			3
YHHƒê: Li·ªát m·∫∑t. YHCT: Kh·∫©u nh√£n oa t√†.	C√≥	1	2.73%			3
YHHƒê: M·∫•t ng·ªß. YHCT: Th·∫•t mi√™n.	C√≥	1	2.73%			3
B·ªánh h·ªá th·ªëng Nhi·ªÖm ‚Äì Ph·ª•			9.09%	0%	0%
YHHƒê: Vi√™m gan si√™u vi. YHCT: Ho√†ng ƒë·∫£n.	C√≥	1	2.27%			3
YHHƒê: S·ªët xu·∫•t huy·∫øt Dengue. YHCT: √în b·ªánh.	C√≥	1	2.27%			3
YHHƒê: ƒêau b·ª•ng kinh nguy√™n ph√°t. YHCT: Th·ªëng kinh.	C√≥	1	2.27%			3
YHHƒê: R·ªëi lo·∫°n m√£n kinh v√† chu m√£n kinh.	C√≥	1	2.27%			3
B·ªánh h·ªá th·ªëng Nhi khoa			4.55%	0%	0%
YHHƒê: Suy dinh d∆∞·ª°ng ·ªü tr·∫ª em. YHCT: Cam t√≠ch.	C√≥	1	2.27%			3
YHHƒê: ƒê√°i d·∫ßm ·ªü tr·∫ª em. YHCT: D·∫° ni·ªáu.	C√≥	1	2.27%			3
B·ªánh h·ªá th·ªëng Ngo·∫°i khoa - Da li·ªÖu			9.09%	0%	0%
YHHƒê: Trƒ©. YHCT: H·∫° trƒ©.	C√≥	1	2.27%			3
YHHƒê: S·ªèi ƒë∆∞·ªùng ni·ªáu. YHCT: L√¢m ch·ª©ng.	C√≥	1	2.27%			3
YHHƒê: M√†y ƒëay.	C√≥	1	2.27%			3
YHHƒê: M·ª•n tr·ª©ng c√°.	C√≥	1	2.27%			3
`.trim();

let CLO_TSV = `
Ph√¢n nh√≥m VDLS	CLO	BLOOM	Tr·∫°ng th√°i	Tr·ªçng s·ªë	% th√¥	S·ªë c√¢u c·∫ßn	S·ªë c√¢u so·∫°n
B·ªánh T·∫°ng ph·ªß
Bi·ªán ch·ª©ng t·∫°ng ph·ªß
	Ch·∫©n ƒëo√°n	Ph√¢n t√≠ch	C√≥	1
	ƒêi·ªÅu tr·ªã	Ph√¢n t√≠ch	C√≥	1
B·ªánh h·ªá th·ªëng Tim m·∫°ch ‚Äì h√¥ h·∫•p
YHHƒê: B·ªánh m·∫°ch v√†nh m·∫°n. YHCT: T√¢m th·ªëng.
	Ch·∫©n ƒëo√°n YHHƒê	ƒê√°nh gi√°	C√≥	1
	Ch·∫©n ƒëo√°n YHCT	ƒê√°nh gi√°	Kh√¥ng	1
	ƒêi·ªÅu tr·ªã YHHƒê	ƒê√°nh gi√°	C√≥	1
	ƒêi·ªÅu tr·ªã YHCT	ƒê√°nh gi√°	Kh√¥ng	1
	D·ª± ph√≤ng YHHƒê	Ph√¢n t√≠ch	C√≥	1
	D·ª± ph√≤ng YHCT	Ph√¢n t√≠ch	Kh√¥ng	1
YHHƒê: TƒÉng huy·∫øt √°p. YHCT: Huy·ªÖn v·ª±ng.
	Ch·∫©n ƒëo√°n YHHƒê	ƒê√°nh gi√°	Kh√¥ng	1
	Ch·∫©n ƒëo√°n YHCT	ƒê√°nh gi√°	Kh√¥ng	1
	ƒêi·ªÅu tr·ªã YHHƒê	ƒê√°nh gi√°	C√≥	1
	ƒêi·ªÅu tr·ªã YHCT	ƒê√°nh gi√°	C√≥	1
	D·ª± ph√≤ng YHHƒê	Ph√¢n t√≠ch	C√≥	1
	D·ª± ph√≤ng YHCT	Ph√¢n t√≠ch	Kh√¥ng	1
YHHƒê: Suy tƒ©nh m·∫°ch m·∫°n t√≠nh.
	Ch·∫©n ƒëo√°n YHHƒê	ƒê√°nh gi√°	Kh√¥ng	1
	Ch·∫©n ƒëo√°n YHCT	ƒê√°nh gi√°	Kh√¥ng	1
	ƒêi·ªÅu tr·ªã YHHƒê	ƒê√°nh gi√°	C√≥	1
	ƒêi·ªÅu tr·ªã YHCT	ƒê√°nh gi√°	C√≥	1
	D·ª± ph√≤ng YHHƒê	Ph√¢n t√≠ch	C√≥	1
	D·ª± ph√≤ng YHCT	Ph√¢n t√≠ch	C√≥	1
YHHƒê: COPD.
	Ch·∫©n ƒëo√°n YHHƒê	ƒê√°nh gi√°	Kh√¥ng	1
	Ch·∫©n ƒëo√°n YHCT	ƒê√°nh gi√°	Kh√¥ng	1
	ƒêi·ªÅu tr·ªã YHHƒê	ƒê√°nh gi√°	C√≥	1
	ƒêi·ªÅu tr·ªã YHCT	ƒê√°nh gi√°	C√≥	1
	D·ª± ph√≤ng YHHƒê	Ph√¢n t√≠ch	C√≥	1
	D·ª± ph√≤ng YHCT	Ph√¢n t√≠ch	Kh√¥ng	1
YHHƒê: Hen ph·∫ø qu·∫£n. YHCT: H√°o ch·ª©ng, suy·ªÖn ch·ª©ng.
	Ch·∫©n ƒëo√°n YHHƒê	ƒê√°nh gi√°	C√≥	1
	Ch·∫©n ƒëo√°n YHCT	ƒê√°nh gi√°	Kh√¥ng	1
	ƒêi·ªÅu tr·ªã YHHƒê	ƒê√°nh gi√°	C√≥	1
	ƒêi·ªÅu tr·ªã YHCT	ƒê√°nh gi√°	C√≥	1
	D·ª± ph√≤ng YHHƒê	Ph√¢n t√≠ch	Kh√¥ng	1
	D·ª± ph√≤ng YHCT	Ph√¢n t√≠ch	Kh√¥ng	1
B·ªánh h·ªá th·ªëng Ti·∫øt ni·ªáu ‚Äì N·ªôi ti·∫øt - Huy·∫øt h·ªçc
YHHƒê: Nhi·ªÖm khu·∫©n ti·∫øt ni·ªáu. YHCT: L√¢m ch·ª©ng.
	Ch·∫©n ƒëo√°n YHHƒê	ƒê√°nh gi√°	C√≥	1
	Ch·∫©n ƒëo√°n YHCT	ƒê√°nh gi√°	C√≥	1
	ƒêi·ªÅu tr·ªã YHHƒê	ƒê√°nh gi√°	C√≥	1
	ƒêi·ªÅu tr·ªã YHCT	ƒê√°nh gi√°	Kh√¥ng	1
	D·ª± ph√≤ng YHHƒê	Ph√¢n t√≠ch	Kh√¥ng	1
	D·ª± ph√≤ng YHCT	Ph√¢n t√≠ch	Kh√¥ng	1
YHHƒê: B√©o ph√¨. YHCT: Ph√¨ b·∫°ng.
	Ch·∫©n ƒëo√°n YHHƒê	ƒê√°nh gi√°	Kh√¥ng	1
	Ch·∫©n ƒëo√°n YHCT	ƒê√°nh gi√°	C√≥	1
	ƒêi·ªÅu tr·ªã YHHƒê	ƒê√°nh gi√°	C√≥	1
	ƒêi·ªÅu tr·ªã YHCT	ƒê√°nh gi√°	C√≥	1
	D·ª± ph√≤ng YHHƒê	Ph√¢n t√≠ch	C√≥	1
	D·ª± ph√≤ng YHCT	Ph√¢n t√≠ch	C√≥	1
YHHƒê: ƒê√°i th√°o ƒë∆∞·ªùng. YHCT: Ti√™u kh√°t.
	Ch·∫©n ƒëo√°n YHHƒê	ƒê√°nh gi√°	Kh√¥ng	1
	Ch·∫©n ƒëo√°n YHCT	ƒê√°nh gi√°	C√≥	1
	ƒêi·ªÅu tr·ªã YHHƒê	ƒê√°nh gi√°	C√≥	1
	ƒêi·ªÅu tr·ªã YHCT	ƒê√°nh gi√°	C√≥	1
	D·ª± ph√≤ng YHHƒê	Ph√¢n t√≠ch	Kh√¥ng	1
	D·ª± ph√≤ng YHCT	Ph√¢n t√≠ch	Kh√¥ng	1
YHHƒê: Thi·∫øu m√°u m·∫°n.
	Ch·∫©n ƒëo√°n YHHƒê	ƒê√°nh gi√°	C√≥	1
	Ch·∫©n ƒëo√°n YHCT	ƒê√°nh gi√°	C√≥	1
	ƒêi·ªÅu tr·ªã YHHƒê	ƒê√°nh gi√°	Kh√¥ng	1
	ƒêi·ªÅu tr·ªã YHCT	ƒê√°nh gi√°	C√≥	1
	D·ª± ph√≤ng YHHƒê	Ph√¢n t√≠ch	Kh√¥ng	1
	D·ª± ph√≤ng YHCT	Ph√¢n t√≠ch	Kh√¥ng	1
`.trim();

/* =========================================================
   B) H√ÄM TI·ªÜN √çCH
   ========================================================= */

function tsvLines(tsv){
  return tsv.split(/\r?\n/).map(l=>l.replace(/\u00A0/g," ").trimEnd()).filter(l=>l.trim().length>0);
}
function toNum(x){
  if (x == null) return null;
  const s = String(x).trim();
  if (!s) return null;
  const v = Number(s.replaceAll(",", "."));
  return Number.isFinite(v) ? v : null;
}
function yesNoToBool(s){
  const t = (s||"").trim().toLowerCase();
  if (t==="c√≥" || t==="co" || t==="yes" || t==="1") return true;
  if (t==="kh√¥ng" || t==="khong" || t==="no" || t==="0") return false;
  return false;
}
function boolToYesNo(b){ return b ? "C√≥" : "Kh√¥ng"; }
function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }

function safePctFromWeights(weights){
  const s = weights.reduce((a,b)=>a+b,0);
  return weights.map(w => s>0 ? (w/s) : 0);
}

function largestRemainderAllocate(targetTotal, items, getRaw){
  const raws = items.map(getRaw);
  const floors = raws.map(x => Math.floor(x));
  let sum = floors.reduce((a,b)=>a+b,0);
  let remain = targetTotal - sum;

  const fracs = raws.map((x,i)=>({i, frac: x - floors[i]})).sort((a,b)=>b.frac-a.frac);
  const out = floors.slice();

  let k=0;
  while(remain>0 && fracs.length){
    out[fracs[k].i] += 1;
    remain--;
    k++;
    if (k>=fracs.length) k=0;
  }

  if (remain<0){
    const fracsAsc = raws.map((x,i)=>({i, frac: x - floors[i]})).sort((a,b)=>a.frac-b.frac);
    let kk=0;
    remain = -remain;
    while(remain>0 && fracsAsc.length){
      const idx = fracsAsc[kk].i;
      if(out[idx]>0){ out[idx]-=1; remain--; }
      kk++;
      if (kk>=fracsAsc.length) kk=0;
    }
  }
  return out;
}

function applyMinMaxAndRebalance(total, qs, mins, maxs){
  const out = qs.slice();
  const n = out.length;
  const minA = mins.map(x => (x==null? null : Math.max(0, Math.floor(x))));
  const maxA = maxs.map(x => (x==null? null : Math.max(0, Math.floor(x))));

  for (let i=0;i<n;i++){
    if (minA[i]!=null && out[i] < minA[i]) out[i]=minA[i];
  }
  for (let i=0;i<n;i++){
    if (maxA[i]!=null && out[i] > maxA[i]) out[i]=maxA[i];
  }

  let sum = out.reduce((a,b)=>a+b,0);
  let diff = total - sum;

  if (diff>0){
    while(diff>0){
      let changed=false;
      for (let i=0;i<n && diff>0;i++){
        if (maxA[i]==null || out[i] < maxA[i]){
          out[i] += 1;
          diff -= 1;
          changed=true;
        }
      }
      if(!changed) break;
    }
  }
  if (diff<0){
    diff = -diff;
    while(diff>0){
      let changed=false;
      for (let i=0;i<n && diff>0;i++){
        if (out[i]>0 && (minA[i]==null || out[i] > minA[i])){
          out[i] -= 1;
          diff -= 1;
          changed=true;
        }
      }
      if(!changed) break;
    }
  }
  return out;
}

function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
}
function fmtPct(x){
  if (!Number.isFinite(x)) return "";
  return `${x.toFixed(2)}%`;
}

/* =========================================================
   C) PARSER TSV ‚Üí OBJECT
   ========================================================= */

function parseGroups(tsv){
  const lines = tsvLines(tsv);
  const header = lines[0].split("\t").map(s=>s.trim());
  const idx = (name)=>header.indexOf(name);

  const out = [];
  for (let i=1;i<lines.length;i++){
    const cols = lines[i].split("\t");
    const name = (cols[idx("Ph√¢n nh√≥m")]||"").trim();
    if (!name || name.toLowerCase()==="t·ªïng") continue;
    out.push({
      name,
      credits: toNum(cols[idx("T√≠n ch·ªâ")]) ?? 0,
      coef: toNum(cols[idx("H·ªá s·ªë")]) ?? 0,
      min: null,
      max: null
    });
  }
  return out;
}

function parseVDLS(tsv){
  const lines = tsvLines(tsv);
  const header = lines[0].split("\t").map(s=>s.trim());
  const idx = (name)=>header.indexOf(name);

  const out = [];
  let currentGroup = "";
  for (let i=1;i<lines.length;i++){
    const cols = lines[i].split("\t");
    const groupCell = (cols[idx("Ph√¢n nh√≥m VDLS")]||"").trim();
    const status = (cols[idx("T√¨nh tr·∫°ng")]||"").trim();

    // group header row: has group name but status empty
    if (groupCell && !status){
      currentGroup = groupCell;
      continue;
    }
    if (!groupCell) continue;

    out.push({
      group: currentGroup || "(Ch∆∞a nh√≥m)",
      problem: groupCell,
      include: yesNoToBool(status),
      weight: toNum(cols[idx("T·ª∑ tr·ªçng")]) ?? 1,
      min: null,
      max: null
    });
  }
  return out;
}

/* NOTE:
   FIX NH·∫¶M L·∫™N GROUP/VDLS:
   - D√≤ng "Ph√¢n nh√≥m" = ph·∫£i tr√πng GROUP_NAME_SET
   - D√≤ng "VDLS" = c√≥ text nh∆∞ng CLO/Bloom r·ªóng, kh√¥ng thu·ªôc GROUP_NAME_SET
   - D√≤ng CLO th·∫≠t = clo + bloom c√≥ d·ªØ li·ªáu
*/
let GROUP_NAME_SET = new Set(); // s·∫Ω set sau khi parse groups

function parseCLO(tsv){
  const lines = tsvLines(tsv);
  const header = lines[0].split("\t").map(s=>s.trim());
  const idx = (name)=>header.indexOf(name);

  const out = [];
  let currentGroup = "";
  let currentProblem = "";

  for (let i=1;i<lines.length;i++){
    const cols = lines[i].split("\t");
    const first = (cols[idx("Ph√¢n nh√≥m VDLS")]||"").trim();
    const clo   = (cols[idx("CLO")]||"").trim();
    const bloom = (cols[idx("BLOOM")]||"").trim();
    const status= (cols[idx("Tr·∫°ng th√°i")]||"").trim();
    const w     = toNum(cols[idx("Tr·ªçng s·ªë")]) ?? 1;

    // Group header line: only when first matches a real group name
    if (first && !clo && !bloom && GROUP_NAME_SET.has(first)){
      currentGroup = first;
      currentProblem = "";
      continue;
    }

    // Problem header line (VDLS): text in first, clo/bloom empty, and NOT a group name
    if (first && !clo && !bloom){
      currentProblem = first;
      continue;
    }

    // CLO row: clo + bloom exist
    if (clo && bloom){
      out.push({
        group: currentGroup || "(Ch∆∞a nh√≥m)",
        problem: currentProblem || "(Ch∆∞a VDLS)",
        clo,
        bloom,
        include: yesNoToBool(status),
        weight: w
      });
    }
  }
  return out;
}

/* =========================================================
   D) APP STATE
   ========================================================= */

const BLOOM_KEYS = [
  {key:"nho", label:"Nh·ªõ"},
  {key:"hieu", label:"Hi·ªÉu"},
  {key:"vd", label:"V·∫≠n d·ª•ng"},
  {key:"pt", label:"Ph√¢n t√≠ch"},
  {key:"dg", label:"ƒê√°nh gi√°"},
  {key:"st", label:"S√°ng t·∫°o"},
];

function bloomKeyFromLabel(b){
  const t = (b||"").toLowerCase().trim();
  if (t.includes("nh·ªõ")) return "nho";
  if (t.includes("hi·ªÉu")) return "hieu";
  if (t.includes("v·∫≠n") || t.includes("v.d")) return "vd";
  if (t.includes("ph√¢n") || t.includes("p.t")) return "pt";
  if (t.includes("ƒë√°nh") || t.includes("ƒë.")) return "dg";
  if (t.includes("s√°ng") || t.includes("s.")) return "st";
  return null;
}

const APP = {
  meta: { totalQuestions: 120, durationMinutes: 90, examName: "K·ª≥ thi" },
  bloomDefault: { nho:15, hieu:20, vd:25, pt:20, dg:15, st:5 },
  lockBloom: false,
  lockMinMaxGroup: true,
  lockMinMaxVDLS: true,
  teachWeightOnGroups: true,

  groups: [],
  vdls: [],
  allocations: [],

  computed: null
};

function rebuildSets(){
  GROUP_NAME_SET = new Set(APP.groups.map(g => (g.name||"").trim()));
}

/* =========================================================
   E) CORE COMPUTE
   ========================================================= */

function computeAll(){
  // build map VDLS by group
  const vdlsByGroup = new Map();
  APP.vdls.forEach(v=>{
    if(!vdlsByGroup.has(v.group)) vdlsByGroup.set(v.group, []);
    vdlsByGroup.get(v.group).push(v);
  });

  // 1) group weights
  const gw = APP.groups.map(g=>{
    const base = (g.credits||0) * (g.coef||0);
    if(!APP.teachWeightOnGroups) return base;

    const list = vdlsByGroup.get(g.name) || [];
    if(list.length===0) return base;

    const taught = list.filter(x=>x.include);
    const used = taught.length ? taught : list;
    const teachFactor = used.reduce((s,x)=> s + (x.weight||1), 0);
    return base * (teachFactor>0 ? teachFactor : 1);
  });

  const gpct = safePctFromWeights(gw);
  const groupRawQ = gpct.map(fr => fr * APP.meta.totalQuestions);
  let groupQ = largestRemainderAllocate(APP.meta.totalQuestions, APP.groups, (_,i)=>groupRawQ[i]);

  if (!APP.lockMinMaxGroup){
    groupQ = applyMinMaxAndRebalance(APP.meta.totalQuestions, groupQ, APP.groups.map(g=>g.min), APP.groups.map(g=>g.max));
  }

  const groupsComputed = APP.groups.map((g,i)=>({
    ...g,
    rawPct: gpct[i]*100,
    q: groupQ[i]
  }));

  // 2) VDLS per group
  const vdlsComputed = [];
  const vdlsQMap = new Map(); // key group|problem -> q

  for (const g of groupsComputed){
    const list = (vdlsByGroup.get(g.name) || []).slice();
    if (list.length===0) continue;

    const included = list.filter(x=>x.include);
    const base = included.length ? included : list;
    const weights = base.map(x=>x.weight || 1);
    const fracs = safePctFromWeights(weights);
    const raw = fracs.map(fr => fr * g.q);
    let qs = largestRemainderAllocate(g.q, base, (_,i)=>raw[i]);

    if (!APP.lockMinMaxVDLS){
      qs = applyMinMaxAndRebalance(g.q, qs, base.map(x=>x.min), base.map(x=>x.max));
    }

    base.forEach((v,i)=>{
      const q = qs[i];
      vdlsComputed.push({ ...v, q, groupQ: g.q });
      vdlsQMap.set(`${v.group}|||${v.problem}`, q);
    });
  }

  // 3) CLO allocations within each VDLS problem
  const rowsByProblem = new Map();
  APP.allocations.forEach(r=>{
    const k = `${r.group}|||${r.problem}`;
    if(!rowsByProblem.has(k)) rowsByProblem.set(k, []);
    rowsByProblem.get(k).push(r);
  });

  const cloComputed = [];
  const bloomTotals = {nho:0,hieu:0,vd:0,pt:0,dg:0,st:0};
  let totalCLO = 0;

  for (const [k, rows] of rowsByProblem.entries()){
    const [groupName, problem] = k.split("|||");
    const vdlsQ = vdlsQMap.get(`${groupName}|||${problem}`) ?? 0;

    const included = rows.filter(r=>r.include);
    const base = included.length ? included : rows;
    const weights = base.map(r=>r.weight || 1);
    const fracs = safePctFromWeights(weights);
    const raw = fracs.map(fr => fr * vdlsQ);
    const qs = largestRemainderAllocate(vdlsQ, base, (_,i)=>raw[i]);

    base.forEach((r,i)=>{
      const q = qs[i];
      const bk = bloomKeyFromLabel(r.bloom);
      if (bk) bloomTotals[bk] += q;
      totalCLO += q;
      cloComputed.push({ ...r, q, bloomKey: bk });
    });
  }

  APP.computed = {
    groups: groupsComputed,
    vdls: vdlsComputed,
    clo: cloComputed,
    totals: {
      groups: groupsComputed.reduce((a,b)=>a+b.q,0),
      vdls: vdlsComputed.reduce((a,b)=>a+b.q,0),
      clo: totalCLO,
      bloomTotals
    }
  };
}

/* =========================================================
   F) RENDER
   ========================================================= */

function bloomDropdown(selected){
  const opts = ["Nh·ªõ","Hi·ªÉu","V·∫≠n d·ª•ng","Ph√¢n t√≠ch","ƒê√°nh gi√°","S√°ng t·∫°o"];
  return `
    <select class="input rounded-xl px-2 py-1 text-xs" data-cbloom>
      ${opts.map(o=>`<option ${o===selected?'selected':''}>${escapeHtml(o)}</option>`).join("")}
    </select>
  `;
}

function render(){
  computeAll();

  // meta line
  document.getElementById("metaLine").textContent =
    `T·ªïng c√¢u: ${APP.meta.totalQuestions} | Th·ªùi gian: ${APP.meta.durationMinutes} ph√∫t | ${APP.meta.examName || ""}`;

  // Overview groups table
  const gbody = document.getElementById("tblGroups");
  gbody.innerHTML = APP.computed.groups.map((g,i)=>`
    <tr>
      <td class="p-3 font-semibold">${escapeHtml(g.name)}</td>
      <td class="p-3 text-right">${g.credits}</td>
      <td class="p-3 text-right">${g.coef}</td>
      <td class="p-3 text-right">${fmtPct(g.rawPct)}</td>
      <td class="p-3 text-right">
        <input data-gmin="${i}" ${APP.lockMinMaxGroup?'disabled':''}
          class="input w-20 rounded-xl px-2 py-1 text-right"
          type="number" min="0" value="${g.min ?? ''}" placeholder="‚Äî">
      </td>
      <td class="p-3 text-right">
        <input data-gmax="${i}" ${APP.lockMinMaxGroup?'disabled':''}
          class="input w-20 rounded-xl px-2 py-1 text-right"
          type="number" min="0" value="${g.max ?? ''}" placeholder="‚Äî">
      </td>
      <td class="p-3 text-right font-bold">${g.q}</td>
    </tr>
  `).join("");

  // VDLS table
  const q = (document.getElementById("searchVDLS").value || "").trim().toLowerCase();
  const vbody = document.getElementById("tblVDLS");

  vbody.innerHTML = APP.computed.vdls
    .filter(v => !q || v.problem.toLowerCase().includes(q) || v.group.toLowerCase().includes(q))
    .map((v)=>`
      <tr>
        <td class="p-3 sticky-left font-semibold" style="width: var(--colGroupW);">${escapeHtml(v.group)}</td>
        <td class="p-3 sticky-left-2" style="width: var(--colVdlsW);">
          <div class="editable px-2 py-1"
               contenteditable="true"
               data-vedit="${escapeHtml(v.group)}|||${escapeHtml(v.problem)}"
               spellcheck="false">${escapeHtml(v.problem)}</div>
          <div class="text-[11px] text-slate-500 mt-1">Click ƒë·ªÉ s·ª≠a n·ªôi dung</div>
        </td>
        <td class="p-3 text-center">
          <label class="inline-flex items-center gap-2">
            <input type="checkbox" class="w-4 h-4"
              data-vinclude="${escapeHtml(v.group)}|||${escapeHtml(v.problem)}"
              ${v.include ? "checked" : ""}>
            <span class="text-xs text-slate-600">ƒê∆∞·ª£c d·∫°y</span>
          </label>
        </td>
        <td class="p-3 text-right">
          <input data-vw="${escapeHtml(v.group)}|||${escapeHtml(v.problem)}"
                 class="input w-20 rounded-xl px-2 py-1 text-right"
                 type="number" min="0" step="0.1" value="${v.weight ?? 1}">
        </td>
        <td class="p-3 text-right">
          <input data-vmin="${escapeHtml(v.group)}|||${escapeHtml(v.problem)}" ${APP.lockMinMaxVDLS?'disabled':''}
            class="input w-20 rounded-xl px-2 py-1 text-right" type="number" min="0" value="${v.min ?? ''}" placeholder="‚Äî">
        </td>
        <td class="p-3 text-right">
          <input data-vmax="${escapeHtml(v.group)}|||${escapeHtml(v.problem)}" ${APP.lockMinMaxVDLS?'disabled':''}
            class="input w-20 rounded-xl px-2 py-1 text-right" type="number" min="0" value="${v.max ?? ''}" placeholder="‚Äî">
        </td>
        <td class="p-3 text-right font-bold">${v.q}</td>
        <td class="p-3 text-center">
          <button class="btn rounded-xl px-3 py-1 text-xs font-semibold"
                  data-vdel="${escapeHtml(v.group)}|||${escapeHtml(v.problem)}">X√≥a</button>
        </td>
      </tr>
    `).join("");

  // CLO table
  const filterGroup = document.getElementById("filterGroup").value || "";
  const qc = (document.getElementById("searchCLO").value || "").trim().toLowerCase();

  const cbody = document.getElementById("tblCLO");
  cbody.innerHTML = APP.computed.clo
    .filter(r => !filterGroup || r.group === filterGroup)
    .filter(r => !qc || r.problem.toLowerCase().includes(qc) || r.clo.toLowerCase().includes(qc) || r.group.toLowerCase().includes(qc))
    .map(r=>{
      const key = `${r.group}|||${r.problem}|||${r.clo}|||${r.bloom}`;
      return `
      <tr>
        <td class="p-3 sticky-left font-semibold" style="width: var(--colGroupW);">${escapeHtml(r.group)}</td>
        <td class="p-3 sticky-left-2" style="width: var(--colVdlsW);">${escapeHtml(r.problem)}</td>

        <td class="p-3">
          <div class="editable px-2 py-1"
               contenteditable="true"
               data-cedit="${escapeHtml(key)}"
               spellcheck="false">${escapeHtml(r.clo)}</div>
          <div class="text-[11px] text-slate-500 mt-1">Click ƒë·ªÉ s·ª≠a CLO</div>
        </td>

        <td class="p-3 text-center">
          <select class="input rounded-xl px-2 py-1 text-xs"
                  data-cbloom="${escapeHtml(key)}">
            ${["Nh·ªõ","Hi·ªÉu","V·∫≠n d·ª•ng","Ph√¢n t√≠ch","ƒê√°nh gi√°","S√°ng t·∫°o"].map(o=>`<option ${o===r.bloom?'selected':''}>${escapeHtml(o)}</option>`).join("")}
          </select>
        </td>

        <td class="p-3 text-center">
          <input type="checkbox" class="w-4 h-4"
                 data-cinclude="${escapeHtml(key)}"
                 ${r.include ? "checked" : ""}>
        </td>

        <td class="p-3 text-right">
          <input class="input w-20 rounded-xl px-2 py-1 text-right"
                 type="number" min="0" step="0.1"
                 data-cw="${escapeHtml(key)}"
                 value="${r.weight ?? 1}">
        </td>

        <td class="p-3 text-right font-bold">${r.q}</td>

        <td class="p-3 text-center">
          <button class="btn rounded-xl px-3 py-1 text-xs font-semibold"
                  data-cdel="${escapeHtml(key)}">X√≥a</button>
        </td>
      </tr>
    `}).join("");

  // filterGroup options
  const sel = document.getElementById("filterGroup");
  const current = sel.value;
  const uniqueGroups = Array.from(new Set(APP.allocations.map(x=>x.group))).filter(Boolean);
  sel.innerHTML = `<option value="">T·∫•t c·∫£ ph√¢n nh√≥m</option>` + uniqueGroups.map(g=>`<option ${g===current?'selected':''} value="${escapeHtml(g)}">${escapeHtml(g)}</option>`).join("");

  // Summary
  document.getElementById("sumGroups").textContent = APP.computed.totals.groups;
  document.getElementById("sumVDLS").textContent = APP.computed.totals.vdls;
  document.getElementById("sumCLO").textContent = APP.computed.totals.clo;

  const bt = APP.computed.totals.bloomTotals;
  document.getElementById("t_nho").textContent = bt.nho;
  document.getElementById("t_hieu").textContent = bt.hieu;
  document.getElementById("t_vd").textContent = bt.vd;
  document.getElementById("t_pt").textContent = bt.pt;
  document.getElementById("t_dg").textContent = bt.dg;
  document.getElementById("t_st").textContent = bt.st;

  const s = BLOOM_KEYS.reduce((a,b)=>a+(APP.bloomDefault[b.key]||0),0);
  document.getElementById("bloomSumHint").textContent = `T·ªïng Bloom hi·ªán t·∫°i = ${s}% (n√™n = 100%)`;

  const ok = APP.computed.totals.groups === APP.meta.totalQuestions;
  document.getElementById("badgeCalc").textContent = ok ? "OK" : "ƒêang t√≠nh‚Ä¶";

  // sync quick width inputs
  const cg = parseInt(getComputedStyle(document.documentElement).getPropertyValue("--colGroupW")) || 280;
  const cv = parseInt(getComputedStyle(document.documentElement).getPropertyValue("--colVdlsW")) || 520;
  document.getElementById("inpColGroupW").value = cg;
  document.getElementById("inpColVdlsW").value = cv;

  // Update add CLO dropdowns (group/problem)
  refreshAddForms();
}

/* =========================================================
   G) SAVE / LOAD (LOCAL STORAGE)
   ========================================================= */

const LS_KEYS = {
  meta: "medmatrix_meta_v1",
  bloom: "medmatrix_bloom_v1",
  flags: "medmatrix_flags_v1",
  groups: "medmatrix_groups_v1",
  vdls: "medmatrix_vdls_v1",
  clo: "medmatrix_clo_v1",
  tsv: "medmatrix_tsv_v1",
  widths: "medmatrix_widths_v1",
};

function saveAllToLocal(){
  try{
    localStorage.setItem(LS_KEYS.meta, JSON.stringify(APP.meta));
    localStorage.setItem(LS_KEYS.bloom, JSON.stringify(APP.bloomDefault));
    localStorage.setItem(LS_KEYS.flags, JSON.stringify({
      lockBloom: APP.lockBloom,
      lockMinMaxGroup: APP.lockMinMaxGroup,
      lockMinMaxVDLS: APP.lockMinMaxVDLS,
      teachWeightOnGroups: APP.teachWeightOnGroups
    }));
    localStorage.setItem(LS_KEYS.groups, JSON.stringify(APP.groups));
    localStorage.setItem(LS_KEYS.vdls, JSON.stringify(APP.vdls));
    localStorage.setItem(LS_KEYS.clo, JSON.stringify(APP.allocations));
  }catch(err){}
}

function loadAllFromLocal(){
  try{
    const meta = JSON.parse(localStorage.getItem(LS_KEYS.meta) || "null");
    const bloom= JSON.parse(localStorage.getItem(LS_KEYS.bloom)|| "null");
    const flags= JSON.parse(localStorage.getItem(LS_KEYS.flags)|| "null");
    const groups=JSON.parse(localStorage.getItem(LS_KEYS.groups)||"null");
    const vdls  =JSON.parse(localStorage.getItem(LS_KEYS.vdls)||"null");
    const clo   =JSON.parse(localStorage.getItem(LS_KEYS.clo)||"null");

    if(meta) APP.meta = meta;
    if(bloom) APP.bloomDefault = bloom;
    if(flags){
      APP.lockBloom = !!flags.lockBloom;
      APP.lockMinMaxGroup = !!flags.lockMinMaxGroup;
      APP.lockMinMaxVDLS = !!flags.lockMinMaxVDLS;
      APP.teachWeightOnGroups = (flags.teachWeightOnGroups !== false);
    }
    if(Array.isArray(groups) && groups.length) APP.groups = groups;
    if(Array.isArray(vdls) && vdls.length) APP.vdls = vdls;
    if(Array.isArray(clo) && clo.length) APP.allocations = clo;

    // widths
    const widths = JSON.parse(localStorage.getItem(LS_KEYS.widths) || "null");
    if(widths){
      if(widths.colGroupW) document.documentElement.style.setProperty("--colGroupW", widths.colGroupW);
      if(widths.colVdlsW) document.documentElement.style.setProperty("--colVdlsW", widths.colVdlsW);
    }
  }catch(err){}
}

function resetLocal(){
  Object.values(LS_KEYS).forEach(k=>{
    try{ localStorage.removeItem(k); }catch(e){}
  });
}

/* =========================================================
   H) EXCEL / JSON EXPORT
   ========================================================= */

function exportToJson(){
  const payload = {
    meta: APP.meta,
    bloomDefault: APP.bloomDefault,
    lockBloom: APP.lockBloom,
    lockMinMaxGroup: APP.lockMinMaxGroup,
    lockMinMaxVDLS: APP.lockMinMaxVDLS,
    teachWeightOnGroups: APP.teachWeightOnGroups,
    groups: APP.groups,
    vdls: APP.vdls,
    allocations: APP.allocations,
    computed: APP.computed
  };
  downloadFile(`medmatrix_${Date.now()}.json`, JSON.stringify(payload, null, 2), "application/json");
}

function exportToExcel(){
  // ensure computed fresh
  computeAll();

  const wb = XLSX.utils.book_new();

  const sheetGroups = (APP.computed?.groups || []).map(g=>({
    "Ph√¢n nh√≥m": g.name,
    "T√≠n ch·ªâ": g.credits,
    "H·ªá s·ªë": g.coef,
    "% th√¥": Number.isFinite(g.rawPct) ? g.rawPct.toFixed(2) : "",
    "Min": g.min ?? "",
    "Max": g.max ?? "",
    "S·ªë c√¢u": g.q
  }));
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(sheetGroups), "Groups");

  const sheetVDLS = (APP.computed?.vdls || []).map(v=>({
    "Ph√¢n nh√≥m": v.group,
    "VDLS": v.problem,
    "ƒê∆∞·ª£c d·∫°y": boolToYesNo(v.include),
    "Tr·ªçng s·ªë": v.weight ?? 1,
    "Min": v.min ?? "",
    "Max": v.max ?? "",
    "S·ªë c√¢u": v.q ?? 0
  }));
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(sheetVDLS), "VDLS");

  const sheetCLO = (APP.computed?.clo || []).map(r=>({
    "Ph√¢n nh√≥m": r.group,
    "VDLS": r.problem,
    "CLO": r.clo,
    "Bloom": r.bloom,
    "ƒê∆∞·ª£c d·∫°y": boolToYesNo(r.include),
    "Tr·ªçng s·ªë": r.weight ?? 1,
    "S·ªë c√¢u": r.q ?? 0
  }));
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(sheetCLO), "CLO");

  XLSX.writeFile(wb, `MedMatrix_${Date.now()}.xlsx`);
}

/* =========================================================
   I) TSV SAVE/LOAD (TAB DATA)
   ========================================================= */

function saveTSVToLocal(){
  try{
    localStorage.setItem(LS_KEYS.tsv, JSON.stringify({
      GROUP_TSV,
      VDLS_TSV,
      CLO_TSV
    }));
  }catch(e){}
}
function loadTSVFromLocal(){
  try{
    const s = JSON.parse(localStorage.getItem(LS_KEYS.tsv) || "null");
    if(s && s.GROUP_TSV && s.VDLS_TSV && s.CLO_TSV){
      GROUP_TSV = String(s.GROUP_TSV);
      VDLS_TSV  = String(s.VDLS_TSV);
      CLO_TSV   = String(s.CLO_TSV);
      document.getElementById("txtGroup").value = GROUP_TSV;
      document.getElementById("txtVDLS").value  = VDLS_TSV;
      document.getElementById("txtCLO").value   = CLO_TSV;
      // reload
      APP.groups = parseGroups(GROUP_TSV);
      rebuildSets();
      APP.vdls = parseVDLS(VDLS_TSV);
      APP.allocations = parseCLO(CLO_TSV);
      saveAllToLocal();
      render();
    }
  }catch(e){}
}

/* =========================================================
   J) INLINE EDIT / DELETE HELPERS
   ========================================================= */

function updateVDLSText(group, oldProblem, newProblem){
  newProblem = (newProblem||"").trim();
  if(!newProblem) return;

  const item = APP.vdls.find(x=>x.group===group && x.problem===oldProblem);
  if(!item) return;

  // prevent duplicates in same group
  const dup = APP.vdls.find(x=>x.group===group && x.problem===newProblem);
  if(dup && dup!==item) return;

  item.problem = newProblem;

  // update CLO allocations that point to old problem
  APP.allocations.forEach(a=>{
    if(a.group===group && a.problem===oldProblem){
      a.problem = newProblem;
    }
  });

  saveAllToLocal();
}

function deleteVDLS(group, problem){
  // remove VDLS
  APP.vdls = APP.vdls.filter(v=> !(v.group===group && v.problem===problem));
  // remove CLO under it
  APP.allocations = APP.allocations.filter(a=> !(a.group===group && a.problem===problem));
  saveAllToLocal();
}

function updateCLOText(group, problem, oldClo, bloom, newClo){
  newClo = (newClo||"").trim();
  if(!newClo) return;
  const item = APP.allocations.find(x=>x.group===group && x.problem===problem && x.clo===oldClo && x.bloom===bloom);
  if(!item) return;
  item.clo = newClo;
  saveAllToLocal();
}

function updateCLOBloom(group, problem, clo, oldBloom, newBloom){
  const item = APP.allocations.find(x=>x.group===group && x.problem===problem && x.clo===clo && x.bloom===oldBloom);
  if(!item) return;
  item.bloom = newBloom;
  saveAllToLocal();
}

function deleteCLO(group, problem, clo, bloom){
  APP.allocations = APP.allocations.filter(x=> !(x.group===group && x.problem===problem && x.clo===clo && x.bloom===bloom));
  saveAllToLocal();
}

/* =========================================================
   K) RESIZABLE COLUMNS (drag on header)
   ========================================================= */

function setColWidth(which, px){
  const v = clamp(px, which==="group" ? 160 : 260, 1400);
  const css = `${Math.floor(v)}px`;
  if(which==="group") document.documentElement.style.setProperty("--colGroupW", css);
  if(which==="vdls")  document.documentElement.style.setProperty("--colVdlsW", css);

  try{
    const widths = JSON.parse(localStorage.getItem(LS_KEYS.widths) || "{}");
    if(which==="group") widths.colGroupW = css;
    if(which==="vdls")  widths.colVdlsW  = css;
    localStorage.setItem(LS_KEYS.widths, JSON.stringify(widths));
  }catch(e){}
}

function initResizers(){
  let dragging = null;

  document.querySelectorAll(".resizer").forEach(handle=>{
    handle.addEventListener("pointerdown", (e)=>{
      const which = handle.dataset.resizeCol;
      const startX = e.clientX;

      const startVal = parseInt(getComputedStyle(document.documentElement).getPropertyValue(which==="group" ? "--colGroupW" : "--colVdlsW")) || (which==="group"?280:520);
      dragging = { which, startX, startVal };
      handle.setPointerCapture(e.pointerId);
      e.preventDefault();
    });
  });

  window.addEventListener("pointermove", (e)=>{
    if(!dragging) return;
    const dx = e.clientX - dragging.startX;
    setColWidth(dragging.which, dragging.startVal + dx);
    render(); // keep sticky offsets consistent
  });

  window.addEventListener("pointerup", ()=>{
    dragging = null;
  });
}

/* =========================================================
   L) ADD FORMS
   ========================================================= */

function openModal(id){
  document.getElementById(id).classList.add("show");
}
function closeModal(id){
  document.getElementById(id).classList.remove("show");
}

function refreshAddForms(){
  // VDLS group options
  const selG = document.getElementById("addVdlsGroup");
  if(selG){
    selG.innerHTML = APP.groups.map(g=>`<option value="${escapeHtml(g.name)}">${escapeHtml(g.name)}</option>`).join("");
  }

  // CLO group + problem
  const selCG = document.getElementById("addCloGroup");
  const selCP = document.getElementById("addCloProblem");

  if(selCG){
    selCG.innerHTML = APP.groups.map(g=>`<option value="${escapeHtml(g.name)}">${escapeHtml(g.name)}</option>`).join("");
  }
  if(selCG && selCP){
    const g = selCG.value || (APP.groups[0]?.name || "");
    const problems = APP.vdls.filter(v=>v.group===g).map(v=>v.problem);
    selCP.innerHTML = problems.length
      ? problems.map(p=>`<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join("")
      : `<option value="">(Ch∆∞a c√≥ VDLS trong nh√≥m)</option>`;
  }
}

/* =========================================================
   M) EVENTS / BIND
   ========================================================= */

function bind(){
  // Init base data from TSV
  APP.groups = parseGroups(GROUP_TSV);
  rebuildSets();
  APP.vdls = parseVDLS(VDLS_TSV);
  APP.allocations = parseCLO(CLO_TSV);

  // Load from local if any
  loadAllFromLocal();
  rebuildSets();

  // Fill textarea
  document.getElementById("txtGroup").value = GROUP_TSV;
  document.getElementById("txtVDLS").value = VDLS_TSV;
  document.getElementById("txtCLO").value  = CLO_TSV;

  // inputs
  const inpTotalQ = document.getElementById("inpTotalQ");
  const inpDuration = document.getElementById("inpDuration");
  const inpExamName = document.getElementById("inpExamName");
  const chkLockBloom = document.getElementById("chkLockBloom");
  const chkLockMinMaxGroup = document.getElementById("chkLockMinMaxGroup");
  const chkLockMinMaxVDLS = document.getElementById("chkLockMinMaxVDLS");
  const chkTeach = document.getElementById("chkTeachWeightOnGroups");

  inpTotalQ.value = APP.meta.totalQuestions;
  inpDuration.value = APP.meta.durationMinutes;
  inpExamName.value = APP.meta.examName;

  chkLockBloom.checked = APP.lockBloom;
  chkLockMinMaxGroup.checked = APP.lockMinMaxGroup;
  chkLockMinMaxVDLS.checked = APP.lockMinMaxVDLS;
  chkTeach.checked = APP.teachWeightOnGroups;

  // bloom inputs
  document.getElementById("b_nho").value = APP.bloomDefault.nho;
  document.getElementById("b_hieu").value = APP.bloomDefault.hieu;
  document.getElementById("b_vd").value = APP.bloomDefault.vd;
  document.getElementById("b_pt").value = APP.bloomDefault.pt;
  document.getElementById("b_dg").value = APP.bloomDefault.dg;
  document.getElementById("b_st").value = APP.bloomDefault.st;

  inpTotalQ.addEventListener("input", ()=>{
    APP.meta.totalQuestions = Math.max(1, Math.floor(toNum(inpTotalQ.value) || 1));
    saveAllToLocal();
    render();
  });
  inpDuration.addEventListener("input", ()=>{
    APP.meta.durationMinutes = Math.max(1, Math.floor(toNum(inpDuration.value) || 1));
    saveAllToLocal();
    render();
  });
  inpExamName.addEventListener("input", ()=>{
    APP.meta.examName = inpExamName.value || "";
    saveAllToLocal();
    render();
  });

  chkLockBloom.addEventListener("change", ()=>{
    APP.lockBloom = chkLockBloom.checked;
    saveAllToLocal();
    render();
  });
  chkLockMinMaxGroup.addEventListener("change", ()=>{
    APP.lockMinMaxGroup = chkLockMinMaxGroup.checked;
    saveAllToLocal();
    render();
  });
  chkLockMinMaxVDLS.addEventListener("change", ()=>{
    APP.lockMinMaxVDLS = chkLockMinMaxVDLS.checked;
    saveAllToLocal();
    render();
  });
  chkTeach.addEventListener("change", ()=>{
    APP.teachWeightOnGroups = chkTeach.checked;
    saveAllToLocal();
    render();
  });

  document.getElementById("btnApplyBloom").addEventListener("click", ()=>{
    APP.bloomDefault.nho = clamp(toNum(document.getElementById("b_nho").value)||0,0,100);
    APP.bloomDefault.hieu = clamp(toNum(document.getElementById("b_hieu").value)||0,0,100);
    APP.bloomDefault.vd = clamp(toNum(document.getElementById("b_vd").value)||0,0,100);
    APP.bloomDefault.pt = clamp(toNum(document.getElementById("b_pt").value)||0,0,100);
    APP.bloomDefault.dg = clamp(toNum(document.getElementById("b_dg").value)||0,0,100);
    APP.bloomDefault.st = clamp(toNum(document.getElementById("b_st").value)||0,0,100);
    saveAllToLocal();
    render();
  });

  // search/filter
  document.getElementById("searchVDLS").addEventListener("input", render);
  document.getElementById("searchCLO").addEventListener("input", render);
  document.getElementById("filterGroup").addEventListener("change", render);

  // tabs
  document.querySelectorAll(".tab").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const tabId = btn.dataset.tab;
      document.querySelectorAll(".tabPanel").forEach(p=>p.classList.add("hidden"));
      document.getElementById(tabId).classList.remove("hidden");

      document.querySelectorAll(".tab").forEach(b=>b.classList.remove("tab-active"));
      btn.classList.add("tab-active");
    });
  });

  // export buttons
  document.getElementById("btnExportJson").addEventListener("click", exportToJson);
  document.getElementById("btnExportExcel").addEventListener("click", exportToExcel);

  // reset local
  document.getElementById("btnResetLocal").addEventListener("click", ()=>{
    resetLocal();
    location.reload();
  });

  // TSV reload
  document.getElementById("btnReloadFromText").addEventListener("click", ()=>{
    GROUP_TSV = document.getElementById("txtGroup").value.trim();
    VDLS_TSV  = document.getElementById("txtVDLS").value.trim();
    CLO_TSV   = document.getElementById("txtCLO").value.trim();

    APP.groups = parseGroups(GROUP_TSV);
    rebuildSets();
    APP.vdls = parseVDLS(VDLS_TSV);
    APP.allocations = parseCLO(CLO_TSV);

    saveAllToLocal();
    render();
  });

  document.getElementById("btnSaveToLocal").addEventListener("click", ()=>{
    GROUP_TSV = document.getElementById("txtGroup").value.trim();
    VDLS_TSV  = document.getElementById("txtVDLS").value.trim();
    CLO_TSV   = document.getElementById("txtCLO").value.trim();
    saveTSVToLocal();
    alert("ƒê√£ l∆∞u TSV v√†o tr√¨nh duy·ªát.");
  });

  document.getElementById("btnLoadFromLocal").addEventListener("click", ()=>{
    loadTSVFromLocal();
  });

  // quick width inputs
  document.getElementById("inpColGroupW").addEventListener("input", (e)=>{
    setColWidth("group", toNum(e.target.value) || 280);
    render();
  });
  document.getElementById("inpColVdlsW").addEventListener("input", (e)=>{
    setColWidth("vdls", toNum(e.target.value) || 520);
    render();
  });

  // modals open
  document.getElementById("btnAddVDLS").addEventListener("click", ()=>{
    refreshAddForms();
    openModal("modalVDLS");
  });
  document.getElementById("btnAddCLO").addEventListener("click", ()=>{
    refreshAddForms();
    openModal("modalCLO");
  });

  // modal close buttons
  document.querySelectorAll("[data-close-modal]").forEach(b=>{
    b.addEventListener("click", ()=>{
      closeModal(b.dataset.closeModal);
    });
  });
  // click backdrop to close
  ["modalVDLS","modalCLO"].forEach(id=>{
    const el = document.getElementById(id);
    el.addEventListener("click", (e)=>{
      if(e.target === el) closeModal(id);
    });
  });

  // Add VDLS confirm
  document.getElementById("btnConfirmAddVDLS").addEventListener("click", ()=>{
    const group = document.getElementById("addVdlsGroup").value || "";
    const text = (document.getElementById("addVdlsText").value || "").trim();
    const weight = Math.max(0, toNum(document.getElementById("addVdlsWeight").value) ?? 1);
    const include = !!document.getElementById("addVdlsInclude").checked;

    if(!group || !text){
      alert("Vui l√≤ng ch·ªçn nh√≥m v√† nh·∫≠p n·ªôi dung VDLS.");
      return;
    }
    // prevent duplicates
    if(APP.vdls.some(v=>v.group===group && v.problem===text)){
      alert("VDLS n√†y ƒë√£ t·ªìn t·∫°i trong nh√≥m.");
      return;
    }
    APP.vdls.push({ group, problem: text, include, weight, min: null, max: null });
    saveAllToLocal();
    closeModal("modalVDLS");
    document.getElementById("addVdlsText").value = "";
    render();
  });

  // Add CLO confirm
  document.getElementById("addCloGroup").addEventListener("change", ()=>{
    refreshAddForms();
  });

  document.getElementById("btnConfirmAddCLO").addEventListener("click", ()=>{
    const group = document.getElementById("addCloGroup").value || "";
    const problem = document.getElementById("addCloProblem").value || "";
    const clo = (document.getElementById("addCloText").value || "").trim();
    const bloom = document.getElementById("addCloBloom").value || "Nh·ªõ";
    const weight = Math.max(0, toNum(document.getElementById("addCloWeight").value) ?? 1);
    const include = !!document.getElementById("addCloInclude").checked;

    if(!group || !problem || !clo){
      alert("Vui l√≤ng ch·ªçn nh√≥m/VDLS v√† nh·∫≠p CLO.");
      return;
    }
    // ensure VDLS exists
    if(!APP.vdls.some(v=>v.group===group && v.problem===problem)){
      alert("VDLS ch∆∞a t·ªìn t·∫°i trong nh√≥m. H√£y th√™m VDLS tr∆∞·ªõc.");
      return;
    }
    APP.allocations.push({ group, problem, clo, bloom, include, weight });
    saveAllToLocal();
    closeModal("modalCLO");
    document.getElementById("addCloText").value = "";
    render();
  });

  // delegation for inputs/checkbox/blur/delete
  document.addEventListener("input", (e)=>{
    const t = e.target;

    // group min/max
    if (t.dataset.gmin != null){
      const i = Number(t.dataset.gmin);
      APP.groups[i].min = (t.value==="" ? null : Math.max(0, Math.floor(toNum(t.value)||0)));
      saveAllToLocal();
      render();
    }
    if (t.dataset.gmax != null){
      const i = Number(t.dataset.gmax);
      APP.groups[i].max = (t.value==="" ? null : Math.max(0, Math.floor(toNum(t.value)||0)));
      saveAllToLocal();
      render();
    }

    // VDLS weight
    if (t.dataset.vw){
      const [g,p] = t.dataset.vw.split("|||");
      const item = APP.vdls.find(x=>x.group===g && x.problem===p);
      if(item){
        item.weight = Math.max(0, toNum(t.value) ?? 1);
        saveAllToLocal();
        render();
      }
    }

    // VDLS min/max
    if (t.dataset.vmin){
      const [g,p] = t.dataset.vmin.split("|||");
      const item = APP.vdls.find(x=>x.group===g && x.problem===p);
      if(item){
        item.min = (t.value==="" ? null : Math.max(0, Math.floor(toNum(t.value)||0)));
        saveAllToLocal();
        render();
      }
    }
    if (t.dataset.vmax){
      const [g,p] = t.dataset.vmax.split("|||");
      const item = APP.vdls.find(x=>x.group===g && x.problem===p);
      if(item){
        item.max = (t.value==="" ? null : Math.max(0, Math.floor(toNum(t.value)||0)));
        saveAllToLocal();
        render();
      }
    }

    // CLO weight
    if (t.dataset.cw){
      const [g,p,clo,bloom] = t.dataset.cw.split("|||");
      const item = APP.allocations.find(x=>x.group===g && x.problem===p && x.clo===clo && x.bloom===bloom);
      if(item){
        item.weight = Math.max(0, toNum(t.value) ?? 1);
        saveAllToLocal();
        render();
      }
    }
  });

  document.addEventListener("change", (e)=>{
    const t = e.target;

    // VDLS include
    if (t.dataset.vinclude){
      const [g,p] = t.dataset.vinclude.split("|||");
      const item = APP.vdls.find(x=>x.group===g && x.problem===p);
      if(item){
        item.include = !!t.checked;
        saveAllToLocal();
        render();
      }
    }

    // CLO include
    if (t.dataset.cinclude){
      const [g,p,clo,bloom] = t.dataset.cinclude.split("|||");
      const item = APP.allocations.find(x=>x.group===g && x.problem===p && x.clo===clo && x.bloom===bloom);
      if(item){
        item.include = !!t.checked;
        saveAllToLocal();
        render();
      }
    }

    // CLO bloom change
    if (t.dataset.cbloom){
      const [g,p,clo,oldBloom] = t.dataset.cbloom.split("|||");
      const newBloom = t.value;
      updateCLOBloom(g,p,clo,oldBloom,newBloom);
      render();
    }
  });

  // blur handlers for contenteditable
  document.addEventListener("blur", (e)=>{
    const t = e.target;

    // edit VDLS text
    if(t.dataset && t.dataset.vedit){
      const [g,oldP] = t.dataset.vedit.split("|||");
      const newP = t.textContent || "";
      if(newP.trim() && newP.trim() !== oldP){
        updateVDLSText(g, oldP, newP.trim());
        // update dataset to new key (avoid future mismatch)
        t.dataset.vedit = `${g}|||${newP.trim()}`;
        render();
      }
    }

    // edit CLO text
    if(t.dataset && t.dataset.cedit){
      const [g,p,oldClo,bloom] = t.dataset.cedit.split("|||");
      const newClo = t.textContent || "";
      if(newClo.trim() && newClo.trim() !== oldClo){
        updateCLOText(g,p,oldClo,bloom,newClo.trim());
        // update dataset to new key
        t.dataset.cedit = `${g}|||${p}|||${newClo.trim()}|||${bloom}`;
        render();
      }
    }
  }, true);

  // delete buttons (VDLS/CLO)
  document.addEventListener("click", (e)=>{
    const t = e.target;

    if(t.dataset && t.dataset.vdel){
      const [g,p] = t.dataset.vdel.split("|||");
      if(confirm("X√≥a VDLS n√†y v√† to√†n b·ªô CLO li√™n quan?")){
        deleteVDLS(g,p);
        render();
      }
    }

    if(t.dataset && t.dataset.cdel){
      const [g,p,clo,bloom] = t.dataset.cdel.split("|||");
      if(confirm("X√≥a d√≤ng CLO n√†y?")){
        deleteCLO(g,p,clo,bloom);
        render();
      }
    }
  });

  // init resizers
  initResizers();
}

/* =========================================================
   UTIL: DOWNLOAD
   ========================================================= */

function downloadFile(filename, content, mime){
  const blob = new Blob([content], {type: mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* =========================================================
   INIT
   ========================================================= */
bind();
render();
</script>

</body>
</html>
