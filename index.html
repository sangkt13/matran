<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MedExam Graduation - Công cụ Thiết kế Ma trận Đề thi</title>
  <meta name="theme-color" content="#2563eb" />

  <!-- UI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Export Excel/Word -->
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.js"></script>

  <style>
    body { font-family: 'Inter', sans-serif; background:#f8fafc; }
    .table-container::-webkit-scrollbar { height: 8px; width: 8px; }
    .table-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

    .modal { opacity: 0; visibility: hidden; transition: all 0.25s ease-in-out; }
    .modal.active { opacity: 1; visibility: visible; }
    .modal.active .modal-content { transform: scale(1); }
    .modal .modal-content { transform: scale(0.97); transition: all 0.25s ease-in-out; }

    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      z-index:9999;background:#0f172a;color:#fff;padding:10px 14px;border-radius:10px;
      font-size:13px;box-shadow:0 10px 20px rgba(0,0,0,.2);
      opacity:0;pointer-events:none;transition:opacity .2s ease;
    }
    .toast.show{opacity:1}

    .resizable-y{resize:vertical;overflow:auto;min-height:140px;max-height:70vh;}
    .resize-hint{position:sticky;bottom:0;background:linear-gradient(to top, rgba(255,255,255,0.95), rgba(255,255,255,0));padding-top:10px;margin-top:10px;pointer-events:none;}
    .suffix-wrap{position:relative;}
    .suffix{position:absolute;right:10px;top:50%;transform:translateY(-50%);font-size:11px;color:#94a3b8;pointer-events:none;}
    .num-input{padding-right:44px !important;text-align:right;}
    .group-header{
      position:sticky;top:0;z-index:5;background:#f1f5f9;border:1px solid #e2e8f0;border-radius:12px;
      padding:10px 12px;display:flex;justify-content:space-between;align-items:center;
      box-shadow:0 1px 0 rgba(0,0,0,0.03);
    }
  </style>
</head>

<body class="flex flex-col min-h-screen text-slate-800">

  <!-- Navbar -->
  <nav class="bg-white shadow-sm sticky top-0 z-50 border-b border-gray-200">
    <div class="max-w-[1920px] mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex items-center">
          <div class="flex-shrink-0 flex items-center cursor-pointer" onclick="window.location.reload()">
            <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center text-white mr-3 shadow-lg shadow-blue-200">
              <i class="fa-solid fa-user-doctor text-xl"></i>
            </div>
            <div>
              <span class="text-xl font-bold text-slate-800 block leading-none">Med<span class="text-blue-600">Exam</span></span>
              <span class="text-xs text-gray-500 font-medium tracking-wider">GRADUATION TOOL</span>
            </div>
          </div>

          <div class="hidden sm:ml-10 sm:flex sm:space-x-8">
            <a href="#" class="border-blue-500 text-gray-900 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
              Thiết kế Ma trận
            </a>

            <button onclick="toggleCLOModal(true)" class="border-transparent text-gray-500 hover:text-blue-600 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium transition-colors">
              <i class="fa-solid fa-list-check mr-2"></i> Quản lý CLO
            </button>

            <button onclick="toggleSpecialtyLibrary(true)" class="border-transparent text-gray-500 hover:text-blue-600 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium transition-colors">
              <i class="fa-solid fa-book mr-2"></i> Thư viện Phân môn
            </button>

            <button onclick="toggleSystemsModal(true)" class="border-transparent text-gray-500 hover:text-blue-600 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium transition-colors">
              <i class="fa-solid fa-diagram-project mr-2"></i> Hệ cơ quan
            </button>
          </div>
        </div>

        <div class="flex items-center space-x-2 sm:space-x-3">
          <div class="text-right mr-2 hidden lg:block">
            <div id="examTitleTop" class="text-sm font-medium text-gray-900"></div>
            <div id="examYearTop" class="text-xs text-gray-500"></div>
          </div>

          <button onclick="toggleExamSettings(true)" class="bg-white hover:bg-blue-50 text-blue-700 border border-blue-200 px-3 py-2 rounded-md text-sm font-medium shadow-sm transition flex items-center">
            <i class="fa-solid fa-pen-to-square mr-2"></i> Tùy chỉnh kỳ thi
          </button>

          <button onclick="loadBlueprint()" class="bg-slate-700 hover:bg-slate-800 text-white px-4 py-2 rounded-md text-sm font-medium shadow-sm transition flex items-center">
            <i class="fa-solid fa-cloud-arrow-down mr-2"></i> Tải (Local)
          </button>

          <button onclick="saveBlueprint()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium shadow-sm transition flex items-center">
            <i class="fa-solid fa-floppy-disk mr-2"></i> Lưu (Local)
          </button>

          <button onclick="openExportChooser()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-md text-sm font-medium shadow-sm transition flex items-center">
            <i class="fa-solid fa-file-export mr-2"></i> Xuất báo cáo
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main -->
  <main class="flex-grow w-full px-4 sm:px-6 lg:px-8 py-6 max-w-[1920px] mx-auto">
    <div class="grid grid-cols-12 gap-6 h-[calc(100vh-140px)]">

      <!-- Left -->
      <div class="col-span-12 lg:col-span-4 xl:col-span-3 flex flex-col gap-6 overflow-hidden h-full">

        <!-- General -->
        <div id="cardGeneral" class="bg-white rounded-xl shadow-sm border border-gray-200 p-5 shrink-0 resizable-y">
          <h3 class="text-sm font-bold text-slate-900 uppercase tracking-wide mb-4 flex items-center">
            <i class="fa-solid fa-sliders mr-2 text-blue-500"></i> Thông số chung
          </h3>

          <div class="space-y-4">
            <div class="flex justify-between items-center gap-3">
              <label class="text-sm text-slate-600 font-medium">Tổng số câu hỏi</label>
              <div class="suffix-wrap w-[120px]">
                <input
                  type="number" id="totalQuestions" value="100" min="0"
                  onchange="updateCalculations()"
                  class="num-input w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm font-bold text-blue-600"
                />
                <span class="suffix">câu</span>
              </div>
            </div>

            <div class="flex justify-between items-center gap-3">
              <label class="text-sm text-slate-600 font-medium">Thời gian làm bài</label>
              <div class="suffix-wrap w-[120px]">
                <input
                  type="number" id="durationMinutes" value="90" min="0"
                  onchange="persistExamSettingsFromQuick()"
                  class="num-input w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm font-semibold text-slate-700"
                />
                <span class="suffix">phút</span>
              </div>
            </div>

            <div class="pt-2 border-t border-gray-100">
              <div class="text-xs text-gray-500">Kỳ thi</div>
              <div id="examTitleLeft" class="text-sm font-bold text-slate-800"></div>
              <div id="examYearLeft" class="text-xs text-gray-500 mt-0.5"></div>
            </div>
          </div>

          <div class="resize-hint text-[11px] text-slate-400">
            <i class="fa-solid fa-up-down-left-right mr-1"></i> Kéo góc phải-dưới để đổi chiều cao khung
          </div>
        </div>

        <!-- Bloom -->
        <div id="cardBloom" class="bg-white rounded-xl shadow-sm border border-gray-200 p-5 shrink-0 resizable-y">
          <h3 class="text-sm font-bold text-slate-900 uppercase tracking-wide mb-4 flex items-center">
            <i class="fa-solid fa-sitemap mr-2 text-purple-500"></i> BLOOM MẶC ĐỊNH (%)
          </h3>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="text-xs text-gray-500 font-semibold">Nhớ</label>
              <input id="bloomRecall" type="number" min="0" max="100" class="mt-1 w-full border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 text-sm font-bold" value="30" onchange="onBloomChange()">
            </div>
            <div>
              <label class="text-xs text-gray-500 font-semibold">Hiểu</label>
              <input id="bloomUnderstand" type="number" min="0" max="100" class="mt-1 w-full border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 text-sm font-bold" value="30" onchange="onBloomChange()">
            </div>
            <div>
              <label class="text-xs text-gray-500 font-semibold">Vận dụng</label>
              <input id="bloomApply" type="number" min="0" max="100" class="mt-1 w-full border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 text-sm font-bold" value="25" onchange="onBloomChange()">
            </div>
            <div>
              <label class="text-xs text-gray-500 font-semibold">Phân tích</label>
              <input id="bloomAnalyze" type="number" min="0" max="100" class="mt-1 w-full border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 text-sm font-bold" value="15" onchange="onBloomChange()">
            </div>
          </div>

          <div class="mt-4 flex items-center justify-between gap-3">
            <label class="flex items-center text-sm text-slate-600 select-none">
              <input id="lockBloom" type="checkbox" class="mr-2" onchange="updateCalculations()">
              Khóa Bloom (tự phân bổ)
            </label>
            <button onclick="applyBloomToAll()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-semibold shadow-sm transition">
              Áp dụng Bloom
            </button>
          </div>

          <p id="bloomHint" class="text-[11px] text-gray-500 mt-3"></p>

          <div class="resize-hint text-[11px] text-slate-400">
            <i class="fa-solid fa-up-down-left-right mr-1"></i> Kéo góc phải-dưới để đổi chiều cao khung
          </div>
        </div>

        <!-- Problems -->
        <div id="cardProblems" class="bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col flex-grow overflow-hidden resizable-y">
          <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
            <div>
              <h3 class="text-sm font-bold text-slate-900 uppercase tracking-wide">
                <i class="fa-solid fa-stethoscope mr-2 text-rose-500"></i> Vấn đề Lâm sàng
              </h3>
              <p class="text-[11px] text-gray-500 mt-0.5">Phân bổ % trọng số (nhóm theo hệ cơ quan)</p>
            </div>
            <div class="flex items-center gap-2">
              <button onclick="toggleSystemsModal(true)"
                class="text-xs bg-white border border-gray-300 hover:bg-indigo-50 hover:text-indigo-700 hover:border-indigo-200 text-gray-700 px-3 py-1.5 rounded shadow-sm transition font-medium">
                <i class="fa-solid fa-diagram-project"></i> Hệ cơ quan
              </button>
              <button onclick="addProblem()"
                class="text-xs bg-white border border-gray-300 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-200 text-gray-700 px-3 py-1.5 rounded shadow-sm transition font-medium">
                <i class="fa-solid fa-plus"></i> Thêm
              </button>
            </div>
          </div>

          <div class="overflow-y-auto p-3 space-y-3 flex-grow bg-slate-50/50" id="problemsList"></div>

          <div class="p-4 border-t border-gray-200 bg-white">
            <div class="flex justify-between items-center">
              <span class="text-sm font-medium text-gray-700">Tổng trọng số:</span>
              <span id="totalWeightDisplay" class="text-lg font-bold text-orange-500">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2 mt-2 overflow-hidden">
              <div id="weightProgressBar" class="bg-orange-400 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
          </div>
        </div>

      </div>

      <!-- Right -->
      <div class="col-span-12 lg:col-span-8 xl:col-span-9 flex flex-col h-full bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gray-50 shrink-0">
          <div>
            <h2 class="text-lg font-bold text-slate-800 flex items-center">
              <i class="fa-solid fa-table-cells mr-2 text-gray-400"></i> Chi tiết Phân môn & Bloom
            </h2>
            <p class="text-xs text-gray-500 mt-1">Phân chia câu hỏi theo CLO và mức độ nhận thức. Có thể xuất file theo từng phân môn (riêng lẻ).</p>
          </div>
          <div class="flex items-center space-x-3">
            <div class="hidden md:flex items-center space-x-4 text-xs bg-white px-3 py-2 rounded-lg border border-gray-200 shadow-sm">
              <span class="flex items-center text-gray-600 font-medium"><span class="w-2.5 h-2.5 rounded-full bg-blue-500 mr-1.5"></span> Nhớ (1)</span>
              <span class="flex items-center text-gray-600 font-medium"><span class="w-2.5 h-2.5 rounded-full bg-cyan-500 mr-1.5"></span> Hiểu (2)</span>
              <span class="flex items-center text-gray-600 font-medium"><span class="w-2.5 h-2.5 rounded-full bg-indigo-500 mr-1.5"></span> V.Dụng (3)</span>
              <span class="flex items-center text-gray-600 font-medium"><span class="w-2.5 h-2.5 rounded-full bg-purple-500 mr-1.5"></span> P.Tích (4)</span>
            </div>

            <button onclick="exportSpecialtyChooser()"
              class="bg-emerald-50 hover:bg-emerald-100 text-emerald-700 border border-emerald-200 px-3 py-2 rounded-lg text-sm font-semibold transition flex items-center">
              <i class="fa-solid fa-download mr-2"></i> Xuất theo phân môn
            </button>
          </div>
        </div>

        <div class="overflow-auto table-container flex-grow relative bg-white">
          <table class="min-w-full divide-y divide-gray-200 relative">
            <thead class="bg-gray-100 sticky top-0 z-20 shadow-sm ring-1 ring-gray-200">
              <tr>
                <th class="px-6 py-3.5 text-left text-xs font-bold text-gray-600 uppercase w-[30%] tracking-wider">Vấn đề & Phân môn</th>
                <th class="px-3 py-3.5 text-left text-xs font-bold text-gray-600 uppercase w-[22%] tracking-wider">
                  Chuẩn đầu ra (CLO)
                  <button onclick="toggleCLOModal(true)" class="ml-1 text-blue-500 hover:text-blue-700"><i class="fa-solid fa-gear"></i></button>
                </th>
                <th class="px-2 py-3.5 text-center text-xs font-bold text-blue-600 uppercase tracking-wider">Nhớ</th>
                <th class="px-2 py-3.5 text-center text-xs font-bold text-cyan-600 uppercase tracking-wider">Hiểu</th>
                <th class="px-2 py-3.5 text-center text-xs font-bold text-indigo-600 uppercase tracking-wider">V.Dụng</th>
                <th class="px-2 py-3.5 text-center text-xs font-bold text-purple-600 uppercase tracking-wider">P.Tích</th>
                <th class="px-4 py-3.5 text-center text-xs font-bold text-gray-800 uppercase bg-gray-200 border-l border-gray-300">Tổng</th>
                <th class="px-2 py-3.5 text-center text-xs font-bold text-gray-600 uppercase">Xuất</th>
                <th class="px-2 py-3.5"></th>
              </tr>
            </thead>
            <tbody id="matrixBody" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
          </table>
        </div>

        <div class="bg-white border-t border-gray-200 px-6 py-4 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] shrink-0">
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-2">
              <span class="text-xs font-bold uppercase text-slate-500 mr-2">Trạng thái Kiểm tra:</span>
              <span id="validationStatus" class="text-xs font-bold px-3 py-1.5 rounded-full bg-yellow-100 text-yellow-800 border border-yellow-200">
                <i class="fa-solid fa-spinner fa-spin mr-1"></i> Đang tính toán
              </span>
            </div>

            <div class="flex items-center space-x-8">
              <div class="text-center">
                <div class="text-[10px] uppercase font-bold text-gray-400 tracking-wider mb-1">Recall</div>
                <div id="sumRecall" class="font-bold text-lg text-blue-600 leading-none">0</div>
              </div>
              <div class="text-center">
                <div class="text-[10px] uppercase font-bold text-gray-400 tracking-wider mb-1">Understand</div>
                <div id="sumUnderstand" class="font-bold text-lg text-cyan-600 leading-none">0</div>
              </div>
              <div class="text-center">
                <div class="text-[10px] uppercase font-bold text-gray-400 tracking-wider mb-1">App/Ana</div>
                <div id="sumAdvanced" class="font-bold text-lg text-indigo-600 leading-none">0</div>
              </div>
              <div class="pl-8 border-l border-gray-200 text-center">
                <div class="text-[10px] uppercase font-bold text-gray-500 tracking-wider mb-1">Tổng cộng</div>
                <div id="grandTotal" class="font-black text-2xl text-slate-800 leading-none">0</div>
              </div>
            </div>
          </div>
        </div>

      </div><!-- /Right -->
    </div>
  </main>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <!-- Export chooser modal -->
  <div id="exportModal" class="modal fixed inset-0 z-[80] flex items-center justify-center">
    <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="toggleExportModal(false)"></div>
    <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-md relative z-10 flex flex-col">
      <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center">
        <h3 class="text-lg font-bold text-slate-800">Xuất báo cáo</h3>
        <button onclick="toggleExportModal(false)" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
      </div>
      <div class="p-6 bg-slate-50">
        <p class="text-sm text-slate-700 mb-4">Chọn định dạng bạn muốn xuất:</p>
        <div class="grid grid-cols-2 gap-3">
          <button onclick="exportReportExcel()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-3 rounded-lg font-semibold flex items-center justify-center">
            <i class="fa-solid fa-file-excel mr-2"></i> Excel (.xlsx)
          </button>
          <button onclick="exportReportWord()" class="bg-slate-800 hover:bg-slate-900 text-white px-4 py-3 rounded-lg font-semibold flex items-center justify-center">
            <i class="fa-solid fa-file-word mr-2"></i> Word (.docx)
          </button>
        </div>
        <div class="mt-4 text-[12px] text-slate-500">
          Gợi ý: Excel phù hợp tổng hợp/đếm số câu; Word phù hợp in báo cáo.
        </div>
      </div>
      <div class="px-6 py-4 border-t border-gray-100 flex justify-end bg-white rounded-b-xl">
        <button onclick="toggleExportModal(false)" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-5 py-2 rounded-lg font-medium transition">Đóng</button>
      </div>
    </div>
  </div>

  <!-- Exam settings modal -->
  <div id="examModal" class="modal fixed inset-0 z-[70] flex items-center justify-center">
    <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="toggleExamSettings(false)"></div>
    <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-2xl relative z-10 flex flex-col max-h-[85vh]">
      <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center">
        <h3 class="text-lg font-bold text-slate-800">Tùy chỉnh thông tin kỳ thi</h3>
        <button onclick="toggleExamSettings(false)" class="text-gray-400 hover:text-gray-600">
          <i class="fa-solid fa-xmark text-xl"></i>
        </button>
      </div>

      <div class="p-6 overflow-y-auto flex-grow bg-slate-50">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="text-xs font-semibold text-gray-600">Tên kỳ thi</label>
            <input id="examTitleInput" type="text" class="mt-1 w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm" placeholder="VD: Kỳ thi Tốt nghiệp Bác sĩ Đa khoa">
          </div>
          <div>
            <label class="text-xs font-semibold text-gray-600">Niên khóa / Năm</label>
            <input id="examYearInput" type="text" class="mt-1 w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm" placeholder="VD: 2023-2024">
          </div>
          <div>
            <label class="text-xs font-semibold text-gray-600">Thời gian làm bài (phút)</label>
            <input id="examDurationInput" type="number" min="0" class="mt-1 w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm" placeholder="90">
          </div>
          <div class="bg-white border border-gray-200 rounded-lg p-3">
            <div class="text-xs text-gray-500 font-semibold mb-1">Lưu ý</div>
            <div class="text-sm text-slate-700">Thông tin này hiển thị trên navbar và trong báo cáo xuất.</div>
          </div>
        </div>
      </div>

      <div class="px-6 py-4 border-t border-gray-100 flex justify-end bg-white rounded-b-xl">
        <button onclick="toggleExamSettings(false)" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-5 py-2 rounded-lg font-medium transition mr-3">Đóng</button>
        <button onclick="saveExamSettings()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg font-medium shadow-sm transition">
          <i class="fa-solid fa-save mr-2"></i> Lưu
        </button>
      </div>
    </div>
  </div>

  <!-- CLO modal -->
  <div id="cloModal" class="modal fixed inset-0 z-[60] flex items-center justify-center">
    <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="toggleCLOModal(false)"></div>
    <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-2xl relative z-10 flex flex-col max-h-[85vh]">
      <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center">
        <h3 class="text-lg font-bold text-slate-800">Quản lý Chuẩn đầu ra (CLO)</h3>
        <button onclick="toggleCLOModal(false)" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
      </div>

      <div class="p-6 overflow-y-auto flex-grow bg-slate-50">
        <div id="cloListContainer" class="space-y-3"></div>
        <button onclick="addCLO()" class="mt-4 w-full py-2.5 border-2 border-dashed border-blue-300 rounded-lg text-blue-600 font-medium hover:bg-blue-50 hover:border-blue-400 transition-colors flex items-center justify-center">
          <i class="fa-solid fa-plus mr-2"></i> Thêm Chuẩn đầu ra mới
        </button>
      </div>

      <div class="px-6 py-4 border-t border-gray-100 flex justify-end bg-white rounded-b-xl">
        <button onclick="toggleCLOModal(false)" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-5 py-2 rounded-lg font-medium transition mr-3">Đóng</button>
        <button onclick="saveCLOs()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg font-medium shadow-sm transition">
          <i class="fa-solid fa-save mr-2"></i> Lưu thay đổi
        </button>
      </div>
    </div>
  </div>

  <!-- Specialty library modal -->
  <div id="specModal" class="modal fixed inset-0 z-[65] flex items-center justify-center">
    <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="toggleSpecialtyLibrary(false)"></div>
    <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-2xl relative z-10 flex flex-col max-h-[85vh]">
      <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center">
        <h3 class="text-lg font-bold text-slate-800">Thư viện Phân môn</h3>
        <button onclick="toggleSpecialtyLibrary(false)" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
      </div>
      <div class="p-6 overflow-y-auto flex-grow bg-slate-50">
        <div class="text-sm text-slate-700 mb-3">Nhập sẵn danh sách phân môn để chọn nhanh trong từng vấn đề.</div>
        <div id="specListContainer" class="space-y-2"></div>
        <button onclick="addSpecItem()" class="mt-4 w-full py-2.5 border-2 border-dashed border-emerald-300 rounded-lg text-emerald-700 font-medium hover:bg-emerald-50 hover:border-emerald-400 transition-colors flex items-center justify-center">
          <i class="fa-solid fa-plus mr-2"></i> Thêm phân môn
        </button>
      </div>
      <div class="px-6 py-4 border-t border-gray-100 flex justify-end bg-white rounded-b-xl">
        <button onclick="toggleSpecialtyLibrary(false)" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-5 py-2 rounded-lg font-medium transition mr-3">Đóng</button>
        <button onclick="saveSpecLibrary()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-2 rounded-lg font-medium shadow-sm transition">
          <i class="fa-solid fa-save mr-2"></i> Lưu
        </button>
      </div>
    </div>
  </div>

  <!-- Systems modal -->
  <div id="systemsModal" class="modal fixed inset-0 z-[66] flex items-center justify-center">
    <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="toggleSystemsModal(false)"></div>
    <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-2xl relative z-10 flex flex-col max-h-[85vh]">
      <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center">
        <h3 class="text-lg font-bold text-slate-800">Nhóm Hệ cơ quan</h3>
        <button onclick="toggleSystemsModal(false)" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
      </div>
      <div class="p-6 overflow-y-auto flex-grow bg-slate-50">
        <div class="text-sm text-slate-700 mb-3">Tạo/đổi tên hệ cơ quan để nhóm “Vấn đề lâm sàng”.</div>
        <div id="systemsListContainer" class="space-y-2"></div>
        <button onclick="addSystem()" class="mt-4 w-full py-2.5 border-2 border-dashed border-indigo-300 rounded-lg text-indigo-700 font-medium hover:bg-indigo-50 hover:border-indigo-400 transition-colors flex items-center justify-center">
          <i class="fa-solid fa-plus mr-2"></i> Thêm hệ cơ quan
        </button>
      </div>
      <div class="px-6 py-4 border-t border-gray-100 flex justify-end bg-white rounded-b-xl">
        <button onclick="toggleSystemsModal(false)" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-5 py-2 rounded-lg font-medium transition mr-3">Đóng</button>
        <button onclick="saveSystems()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-lg font-medium shadow-sm transition">
          <i class="fa-solid fa-save mr-2"></i> Lưu
        </button>
      </div>
    </div>
  </div>

  <script>
    // =========================
    //  DATA MODEL
    // =========================
    let examSettings = {
      title: "Kỳ thi Tốt nghiệp Bác sĩ Đa khoa",
      year: "Niên khóa 2023-2024",
      durationMinutes: 90
    };

    let bloomDefault = { recall: 30, understand: 30, apply: 25, analyze: 15 };

    let CLOs = [
      { id: 'clo1', code: 'CLO1', name: 'Chẩn đoán xác định & phân biệt' },
      { id: 'clo2', code: 'CLO2', name: 'Điều trị & Xử trí cấp cứu' },
      { id: 'clo3', code: 'CLO3', name: 'Dự phòng & Giáo dục sức khỏe' },
      { id: 'clo4', code: 'CLO4', name: 'Cơ chế bệnh sinh & Sinh lý bệnh' }
    ];

    let specialtyLibrary = [
      "Nội Tim mạch", "Nội Hô hấp", "Cấp cứu", "Nội Tiêu hóa", "Ngoại Tiêu hóa"
    ];

    let organSystems = [
      { id: "sys1", name: "Tim mạch" },
      { id: "sys2", name: "Hô hấp" },
      { id: "sys3", name: "Tiêu hóa" },
      { id: "sys4", name: "Thần kinh" },
      { id: "sys5", name: "Khác" }
    ];

    let problems = [
      {
        id: 1, systemId: "sys1", name: "Đau ngực cấp", weight: 20,
        specialties: [
          { name: "Nội Tim mạch", cloId: "clo1", levels: [2, 3, 2, 1] },
          { name: "Nội Hô hấp", cloId: "clo1", levels: [1, 2, 1, 0] },
          { name: "Cấp cứu", cloId: "clo2", levels: [1, 2, 3, 2] }
        ]
      },
      {
        id: 2, systemId: "sys2", name: "Khó thở", weight: 15,
        specialties: [
          { name: "Nội Hô hấp", cloId: "clo1", levels: [2, 3, 1, 0] },
          { name: "Nội Tim mạch", cloId: "clo4", levels: [1, 2, 0, 0] }
        ]
      },
      {
        id: 3, systemId: "sys3", name: "Đau bụng cấp", weight: 25,
        specialties: [
          { name: "Nội Tiêu hóa", cloId: "clo1", levels: [3, 4, 2, 1] },
          { name: "Ngoại Tiêu hóa", cloId: "clo2", levels: [2, 3, 3, 2] }
        ]
      }
    ];

    // =========================
    //  TOAST
    // =========================
    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 2200);
    }

    // =========================
    //  CARD HEIGHTS
    // =========================
    function persistCardHeights() {
      const ids = ["cardGeneral", "cardBloom", "cardProblems"];
      const heights = {};
      ids.forEach(id => {
        const el = document.getElementById(id);
        if (el) heights[id] = el.style.height || "";
      });
      localStorage.setItem("leftCardHeights", JSON.stringify(heights));
    }
    function restoreCardHeights() {
      try {
        const raw = localStorage.getItem("leftCardHeights");
        if (!raw) return;
        const heights = JSON.parse(raw);
        Object.keys(heights).forEach(id => {
          const el = document.getElementById(id);
          if (el && heights[id]) el.style.height = heights[id];
        });
      } catch {}
    }
    function attachResizeObservers() {
      const ids = ["cardGeneral", "cardBloom", "cardProblems"];
      ids.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener("mouseup", () => persistCardHeights());
        el.addEventListener("touchend", () => persistCardHeights());
      });
    }

    // =========================
    //  EXAM SETTINGS
    // =========================
    function syncExamUI() {
      document.getElementById("examTitleTop").textContent = examSettings.title || "";
      document.getElementById("examYearTop").textContent = examSettings.year || "";
      document.getElementById("examTitleLeft").textContent = examSettings.title || "";
      document.getElementById("examYearLeft").textContent = examSettings.year || "";
      const dur = document.getElementById("durationMinutes");
      if (dur) dur.value = examSettings.durationMinutes ?? 0;
    }

    function toggleExamSettings(show) {
      const modal = document.getElementById('examModal');
      if (show) {
        document.getElementById("examTitleInput").value = examSettings.title || "";
        document.getElementById("examYearInput").value = examSettings.year || "";
        document.getElementById("examDurationInput").value = examSettings.durationMinutes ?? 0;
        modal.classList.add('active');
      } else modal.classList.remove('active');
    }

    function saveExamSettings() {
      examSettings.title = document.getElementById("examTitleInput").value.trim() || "Kỳ thi";
      examSettings.year = document.getElementById("examYearInput").value.trim() || "";
      examSettings.durationMinutes = parseInt(document.getElementById("examDurationInput").value || "0", 10) || 0;
      document.getElementById("durationMinutes").value = examSettings.durationMinutes;
      persistAllLocal();
      syncExamUI();
      showToast("✅ Đã lưu thông tin kỳ thi");
      toggleExamSettings(false);
    }

    function persistExamSettingsFromQuick() {
      examSettings.durationMinutes = parseInt(document.getElementById("durationMinutes").value || "0", 10) || 0;
      persistAllLocal();
      syncExamUI();
    }

    // =========================
    //  BLOOM
    // =========================
    function clampPercent(v) {
      let n = parseInt(v || "0", 10) || 0;
      if (n < 0) n = 0;
      if (n > 100) n = 100;
      return n;
    }

    function onBloomChange() {
      bloomDefault.recall = clampPercent(document.getElementById("bloomRecall").value);
      bloomDefault.understand = clampPercent(document.getElementById("bloomUnderstand").value);
      bloomDefault.apply = clampPercent(document.getElementById("bloomApply").value);
      bloomDefault.analyze = clampPercent(document.getElementById("bloomAnalyze").value);
      persistAllLocal();
      updateBloomHint();
    }

    function updateBloomHint() {
      const total = bloomDefault.recall + bloomDefault.understand + bloomDefault.apply + bloomDefault.analyze;
      const hint = document.getElementById("bloomHint");
      if (total === 100) {
        hint.className = "text-[11px] text-green-600 mt-3";
        hint.textContent = "✅ Tổng Bloom = 100%. Có thể khóa Bloom để tự phân bổ.";
      } else {
        hint.className = "text-[11px] text-orange-600 mt-3";
        hint.textContent = "⚠️ Tổng Bloom hiện = " + total + "%. Nên chỉnh về 100% để phân bổ chính xác.";
      }
    }

    function distributeByBloom(total) {
      const p = bloomDefault;
      const parts = [
        Math.round(total * (p.recall/100)),
        Math.round(total * (p.understand/100)),
        Math.round(total * (p.apply/100)),
        Math.round(total * (p.analyze/100))
      ];
      let sum = parts.reduce((a,b)=>a+b,0);
      let diff = total - sum;
      const order = [1,0,2,3];
      let idx = 0;
      while (diff !== 0) {
        const k = order[idx % order.length];
        parts[k] += diff > 0 ? 1 : -1;
        diff += diff > 0 ? -1 : 1;
        idx++;
        parts.forEach((x,i)=>{ if (x<0) parts[i]=0; });
        sum = parts.reduce((a,b)=>a+b,0);
        diff = total - sum;
      }
      return parts;
    }

    function applyBloomToAll() {
      problems.forEach(p => {
        p.specialties.forEach(s => {
          const sTotal = s.levels.reduce((a,b)=>a+b,0);
          if (sTotal <= 0) return;
          s.levels = distributeByBloom(sTotal);
        });
      });
      updateCalculations();
      showToast("✅ Đã áp Bloom cho các phân môn");
    }

    // =========================
    //  SAVE / LOAD LOCAL
    // =========================
    function persistAllLocal() {
      const payload = {
        examSettings,
        bloomDefault,
        organSystems,
        specialtyLibrary,
        CLOs,
        problems,
        totalQuestions: parseInt(document.getElementById('totalQuestions')?.value || "0", 10),
        savedAt: new Date().toISOString()
      };
      localStorage.setItem("medexam_blueprint_local", JSON.stringify(payload));
    }

    function restoreAllLocal() {
      try {
        const raw = localStorage.getItem("medexam_blueprint_local");
        if (!raw) return;
        const data = JSON.parse(raw);

        if (data.examSettings) examSettings = data.examSettings;
        if (data.bloomDefault) bloomDefault = data.bloomDefault;
        if (Array.isArray(data.organSystems)) organSystems = data.organSystems;
        if (Array.isArray(data.specialtyLibrary)) specialtyLibrary = data.specialtyLibrary;
        if (Array.isArray(data.CLOs)) CLOs = data.CLOs;
        if (Array.isArray(data.problems)) problems = data.problems;

        if (data.totalQuestions != null) document.getElementById('totalQuestions').value = data.totalQuestions;

        document.getElementById("bloomRecall").value = bloomDefault.recall ?? 30;
        document.getElementById("bloomUnderstand").value = bloomDefault.understand ?? 30;
        document.getElementById("bloomApply").value = bloomDefault.apply ?? 25;
        document.getElementById("bloomAnalyze").value = bloomDefault.analyze ?? 15;
      } catch {}
    }

    function saveBlueprint() {
      persistAllLocal();
      showToast("✅ Đã lưu Local");
    }

    function loadBlueprint() {
      restoreAllLocal();
      syncExamUI();
      updateBloomHint();
      updateCalculations();
      showToast("✅ Đã tải Local");
    }

    // =========================
    //  MODALS
    // =========================
    function toggleExportModal(show){
      const modal = document.getElementById('exportModal');
      if(show) modal.classList.add('active'); else modal.classList.remove('active');
    }
    function openExportChooser(){ toggleExportModal(true); }

    function toggleCLOModal(show) {
      const modal = document.getElementById('cloModal');
      if (show) {
        renderCLOManager();
        modal.classList.add('active');
      } else {
        modal.classList.remove('active');
        updateCalculations();
      }
    }

    function toggleSpecialtyLibrary(show) {
      const modal = document.getElementById('specModal');
      if (show) { renderSpecLibrary(); modal.classList.add('active'); }
      else modal.classList.remove('active');
    }

    function toggleSystemsModal(show) {
      const modal = document.getElementById('systemsModal');
      if (show) { renderSystems(); modal.classList.add('active'); }
      else modal.classList.remove('active');
    }

    // =========================
    //  CLO MANAGER
    // =========================
    function renderCLOManager() {
      const container = document.getElementById('cloListContainer');
      container.innerHTML = '';
      CLOs.forEach((clo, index) => {
        const div = document.createElement('div');
        div.className = "bg-white p-3 rounded-lg border border-gray-200 shadow-sm flex items-center gap-3 group hover:border-blue-300 transition";
        div.innerHTML = `
          <div class="flex-none">
            <span class="block text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">Mã CLO</span>
            <input type="text" value="${escapeHtml(clo.code)}" onchange="updateCLOData(${index}, 'code', this.value)"
              class="w-20 text-sm font-bold text-blue-700 bg-blue-50 border-transparent rounded focus:border-blue-500 focus:ring-0 text-center px-1">
          </div>
          <div class="flex-grow">
            <span class="block text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">Nội dung năng lực</span>
            <input type="text" value="${escapeHtml(clo.name)}" onchange="updateCLOData(${index}, 'name', this.value)"
              class="w-full text-sm text-slate-700 border-b border-gray-200 focus:border-blue-500 border-t-0 border-x-0 bg-transparent focus:ring-0 px-0 py-1"
              placeholder="Mô tả chuẩn đầu ra...">
          </div>
          <div class="flex-none pt-4">
            <button onclick="removeCLO(${index})" class="text-gray-300 hover:text-red-500 transition p-2" title="Xóa">
              <i class="fa-solid fa-trash-can"></i>
            </button>
          </div>
        `;
        container.appendChild(div);
      });
    }

    function addCLO() {
      const newId = 'clo' + Date.now();
      CLOs.push({ id: newId, code: 'NEW', name: 'Chuẩn đầu ra mới' });
      renderCLOManager();
    }

    function removeCLO(index) {
      if (CLOs.length <= 1) { alert("Cần ít nhất 1 chuẩn đầu ra!"); return; }
      if (confirm("Xóa CLO này? Các câu hỏi liên quan sẽ bị ảnh hưởng.")) {
        const removed = CLOs[index].id;
        CLOs.splice(index, 1);
        problems.forEach(p => p.specialties.forEach(s => { if (s.cloId === removed) s.cloId = CLOs[0].id; }));
        renderCLOManager();
      }
    }

    function updateCLOData(index, field, value) { CLOs[index][field] = value; }
    function saveCLOs() { persistAllLocal(); toggleCLOModal(false); }

    // =========================
    //  SPECIALTY LIBRARY
    // =========================
    function renderSpecLibrary() {
      const c = document.getElementById("specListContainer");
      c.innerHTML = "";
      specialtyLibrary.forEach((name, idx) => {
        const row = document.createElement("div");
        row.className = "bg-white border border-gray-200 rounded-lg p-3 flex items-center gap-3 hover:border-emerald-300 transition";
        row.innerHTML = `
          <div class="flex-grow">
            <input type="text" value="${escapeHtml(name)}" class="w-full text-sm border-gray-200 rounded-md focus:ring-emerald-500 focus:border-emerald-500"
              onchange="updateSpecItem(${idx}, this.value)" placeholder="Tên phân môn">
          </div>
          <button class="text-gray-300 hover:text-red-500 p-2" onclick="removeSpecItem(${idx})" title="Xóa">
            <i class="fa-solid fa-trash-can"></i>
          </button>
        `;
        c.appendChild(row);
      });
    }
    function addSpecItem() { specialtyLibrary.push("Phân môn mới"); renderSpecLibrary(); }
    function updateSpecItem(idx, val) { specialtyLibrary[idx] = val.trim() || "Phân môn"; }
    function removeSpecItem(idx) { specialtyLibrary.splice(idx, 1); renderSpecLibrary(); }

    function saveSpecLibrary() {
      specialtyLibrary = specialtyLibrary.map(x => x.trim()).filter(Boolean);
      specialtyLibrary = [...new Set(specialtyLibrary)];
      persistAllLocal();
      showToast("✅ Đã lưu thư viện phân môn");
      toggleSpecialtyLibrary(false);
      updateCalculations();
    }

    // =========================
    //  SYSTEMS
    // =========================
    function renderSystems() {
      const c = document.getElementById("systemsListContainer");
      c.innerHTML = "";
      organSystems.forEach((sys, idx) => {
        const row = document.createElement("div");
        row.className = "bg-white border border-gray-200 rounded-lg p-3 flex items-center gap-3 hover:border-indigo-300 transition";
        row.innerHTML = `
          <div class="w-24 text-xs font-bold text-indigo-700 bg-indigo-50 border border-indigo-100 rounded-md px-2 py-1 text-center">
            ${escapeHtml(sys.id)}
          </div>
          <div class="flex-grow">
            <input type="text" value="${escapeHtml(sys.name)}" class="w-full text-sm border-gray-200 rounded-md focus:ring-indigo-500 focus:border-indigo-500"
              onchange="updateSystem(${idx}, this.value)" placeholder="Tên hệ cơ quan">
          </div>
          <button class="text-gray-300 hover:text-red-500 p-2" onclick="removeSystem(${idx})" title="Xóa">
            <i class="fa-solid fa-trash-can"></i>
          </button>
        `;
        c.appendChild(row);
      });
    }

    function addSystem() {
      const newId = "sys" + Date.now();
      organSystems.push({ id: newId, name: "Hệ cơ quan mới" });
      renderSystems();
    }
    function updateSystem(idx, val) { organSystems[idx].name = val.trim() || "Hệ cơ quan"; }

    function removeSystem(idx) {
      if (organSystems.length <= 1) { alert("Cần ít nhất 1 hệ cơ quan!"); return; }
      const removedId = organSystems[idx].id;
      if (!confirm("Xóa hệ cơ quan này? Các vấn đề đang thuộc hệ này sẽ chuyển sang 'Khác' (nếu có) hoặc hệ đầu tiên.")) return;

      organSystems.splice(idx, 1);
      const fallback = organSystems.find(s => s.name.toLowerCase().includes("khác"))?.id || organSystems[0].id;
      problems.forEach(p => { if (p.systemId === removedId) p.systemId = fallback; });
      renderSystems();
      updateCalculations();
    }

    function saveSystems() {
      persistAllLocal();
      showToast("✅ Đã lưu hệ cơ quan");
      toggleSystemsModal(false);
      updateCalculations();
    }

    // =========================
    //  MAIN RENDER
    // =========================
    function renderProblemsList() {
      const container = document.getElementById('problemsList');
      const totalQ = parseInt(document.getElementById('totalQuestions').value) || 0;
      container.innerHTML = '';

      const sysMap = new Map(organSystems.map(s => [s.id, s.name]));
      const grouped = {};
      problems.forEach((p, idx) => {
        const sid = p.systemId || "unknown";
        if (!grouped[sid]) grouped[sid] = [];
        grouped[sid].push({ p, idx });
      });

      const orderedSysIds = organSystems.map(s => s.id);
      const extraSysIds = Object.keys(grouped).filter(k => !orderedSysIds.includes(k));
      const finalSysIds = [...orderedSysIds, ...extraSysIds];

      let totalWeight = 0;

      finalSysIds.forEach(sid => {
        const list = grouped[sid];
        if (!list || list.length === 0) return;

        const header = document.createElement("div");
        header.className = "group-header";
        header.innerHTML = `
          <div class="flex items-center gap-2">
            <span class="text-xs font-bold text-slate-700">${escapeHtml(sysMap.get(sid) || "Chưa phân nhóm")}</span>
            <span class="text-[11px] text-slate-500">(${list.length} vấn đề)</span>
          </div>
          <button class="text-xs bg-white border border-gray-300 hover:bg-indigo-50 hover:text-indigo-700 hover:border-indigo-200 text-gray-700 px-3 py-1.5 rounded shadow-sm transition font-medium"
            onclick="toggleSystemsModal(true)">
            <i class="fa-solid fa-pen"></i> Sửa nhóm
          </button>
        `;
        container.appendChild(header);

        list.forEach(({p, idx}) => {
          totalWeight += p.weight;

          const targetQ = Math.round((p.weight / 100) * totalQ);
          let currentActual = 0;
          p.specialties.forEach(s => currentActual += s.levels.reduce((a, b) => a + b, 0));

          const el = document.createElement('div');
          el.className = "bg-white border border-gray-200 rounded-lg p-3 hover:shadow-md transition-shadow group relative";

          const systemOptions = organSystems.map(os =>
            `<option value="${os.id}" ${os.id === (p.systemId || "") ? "selected" : ""}>${escapeHtml(os.name)}</option>`
          ).join("");

          el.innerHTML = `
            <div class="flex justify-between items-start mb-2 gap-2">
              <div class="flex-grow">
                <input type="text" value="${escapeHtml(p.name)}" onchange="updateProblemName(${idx}, this.value)"
                  class="font-bold text-sm text-slate-800 bg-transparent border-0 border-b border-transparent hover:border-gray-300 focus:border-blue-500 focus:ring-0 p-0 w-full transition-colors"
                  placeholder="Tên vấn đề...">
              </div>
              <button onclick="removeProblem(${idx})" class="text-gray-300 hover:text-red-500 transition opacity-0 group-hover:opacity-100">
                <i class="fa-solid fa-times"></i>
              </button>
            </div>

            <div class="flex items-center justify-between gap-3 mb-3">
              <div class="flex items-center gap-2">
                <span class="text-[11px] text-gray-500 font-semibold">Hệ:</span>
                <select onchange="updateProblemSystem(${idx}, this.value)" class="text-xs border-gray-200 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 py-1 px-2 bg-white">
                  ${systemOptions}
                </select>
              </div>
              <button onclick="addSpecialty(${idx})"
                class="text-xs bg-white border border-blue-200 text-blue-600 hover:bg-blue-600 hover:text-white px-3 py-1.5 rounded-md font-medium transition shadow-sm flex items-center">
                <i class="fa-solid fa-plus mr-1.5"></i> Thêm phân môn
              </button>
            </div>

            <div class="flex items-center space-x-3 mb-3">
              <div class="flex-grow relative pt-1">
                <input type="range" min="0" max="100" value="${p.weight}" oninput="updateProblemWeight(${idx}, this.value)"
                  class="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
              </div>
              <div class="flex items-center bg-blue-50 px-2 py-1 rounded border border-blue-100">
                <input type="number" value="${p.weight}" onchange="updateProblemWeight(${idx}, this.value)"
                  class="w-10 bg-transparent text-right text-xs font-bold text-blue-700 focus:outline-none p-0 border-none">
                <span class="text-xs text-blue-600 ml-0.5">%</span>
              </div>
            </div>

            <div class="flex justify-between text-[11px] text-gray-500 bg-gray-50 rounded px-2 py-1.5">
              <span>Mục tiêu: <span class="font-bold text-slate-700">${targetQ} câu</span></span>
              <span class="${currentActual === targetQ ? 'text-green-600 font-bold' : 'text-orange-500 font-semibold'}">Hiện tại: ${currentActual}</span>
            </div>
          `;
          container.appendChild(el);
        });

        const divider = document.createElement("div");
        divider.className = "h-2";
        container.appendChild(divider);
      });

      const weightDisplay = document.getElementById('totalWeightDisplay');
      const weightBar = document.getElementById('weightProgressBar');
      weightDisplay.innerText = totalWeight + '%';
      weightBar.style.width = Math.min(totalWeight, 100) + '%';

      if (totalWeight === 100) {
        weightDisplay.className = "text-lg font-bold text-green-600";
        weightBar.className = "bg-green-500 h-2 rounded-full transition-all duration-300";
      } else if (totalWeight > 100) {
        weightDisplay.className = "text-lg font-bold text-red-600";
        weightBar.className = "bg-red-500 h-2 rounded-full transition-all duration-300";
      } else {
        weightDisplay.className = "text-lg font-bold text-orange-500";
        weightBar.className = "bg-orange-400 h-2 rounded-full transition-all duration-300";
      }
    }

    function renderMatrix() {
      const tbody = document.getElementById('matrixBody');
      tbody.innerHTML = '';
      const totalQ = parseInt(document.getElementById('totalQuestions').value) || 0;
      const lockBloom = document.getElementById("lockBloom").checked;

      let grandTotal = 0;
      let sumR = 0, sumU = 0, sumAp = 0, sumAn = 0;

      problems.forEach((p, pIndex) => {
        const targetQ = Math.round((p.weight / 100) * totalQ);
        let currentProblemTotal = 0;
        p.specialties.forEach(s => currentProblemTotal += s.levels.reduce((a, b) => a + b, 0));

        const trHeader = document.createElement('tr');
        trHeader.className = "bg-slate-50/80 hover:bg-slate-100 transition-colors border-b border-gray-200";
        trHeader.innerHTML = `
          <td colspan="9" class="px-6 py-2.5">
            <div class="flex items-center justify-between gap-4">
              <div class="flex items-center">
                <div class="w-1.5 h-8 bg-blue-500 rounded-sm mr-3"></div>
                <div>
                  <div class="text-sm font-bold text-slate-800">${escapeHtml(p.name)}</div>
                  <div class="text-[11px] text-slate-500 mt-0.5">
                    Trọng số: <span class="font-semibold text-blue-600">${p.weight}%</span> (${targetQ} câu)
                    <span class="ml-2 text-[11px] text-slate-400">• Hệ: ${escapeHtml(getSystemName(p.systemId))}</span>
                  </div>
                </div>
              </div>

              <div class="flex items-center gap-3">
                <span class="text-[11px] font-bold uppercase tracking-wider ${currentProblemTotal === targetQ ? 'text-green-600' : 'text-orange-500'}">
                  Đã phân bổ: ${currentProblemTotal}/${targetQ}
                </span>

                <select class="text-xs border-gray-200 rounded-md shadow-sm focus:border-emerald-500 focus:ring-emerald-500 py-1.5 px-2 bg-white"
                  onchange="quickAddSpecialtyFromLibrary(${pIndex}, this.value)">
                  <option value="">+ Chọn phân môn từ thư viện</option>
                  ${specialtyLibrary.map(n => `<option value="${escapeHtml(n)}">${escapeHtml(n)}</option>`).join("")}
                </select>

                <button onclick="addSpecialty(${pIndex})" class="text-xs bg-white border border-blue-200 text-blue-600 hover:bg-blue-600 hover:text-white px-3 py-1.5 rounded-md font-medium transition shadow-sm flex items-center">
                  <i class="fa-solid fa-plus mr-1.5"></i> Thêm
                </button>

                <button onclick="exportProblemSummaryExcel(${pIndex})"
                  class="text-xs bg-white border border-slate-200 text-slate-700 hover:bg-slate-800 hover:text-white px-3 py-1.5 rounded-md font-medium transition shadow-sm flex items-center"
                  title="Xuất tổng hợp theo vấn đề (Excel)">
                  <i class="fa-solid fa-file-excel mr-1.5"></i> Vấn đề
                </button>
              </div>
            </div>
          </td>
        `;
        tbody.appendChild(trHeader);

        p.specialties.forEach((s, sIndex) => {
          const sTotal = s.levels.reduce((a, b) => a + b, 0);

          grandTotal += sTotal;
          sumR += s.levels[0];
          sumU += s.levels[1];
          sumAp += s.levels[2];
          sumAn += s.levels[3];

          const tr = document.createElement('tr');
          tr.className = "group hover:bg-blue-50/30 transition-colors";

          const cloOptions = CLOs.map(c =>
            `<option value="${c.id}" ${c.id === s.cloId ? 'selected' : ''}>${escapeHtml(c.code)}: ${escapeHtml(c.name)}</option>`
          ).join('');

          tr.innerHTML = `
            <td class="px-6 py-2 pl-12">
              <div class="flex items-center gap-2">
                <i class="fa-solid fa-turn-up rotate-90 text-gray-300 text-xs"></i>
                <input type="text" value="${escapeHtml(s.name)}" onchange="updateSpecialtyName(${pIndex}, ${sIndex}, this.value)"
                  class="w-full text-sm font-semibold text-slate-700 bg-transparent border-0 border-b border-transparent focus:border-blue-500 focus:ring-0 p-0 placeholder-gray-400 hover:border-gray-200 transition-colors"
                  placeholder="Nhập tên phân môn...">
              </div>
              <div class="mt-1 flex items-center gap-2">
                <button class="text-[11px] px-2 py-1 rounded border border-emerald-200 text-emerald-700 hover:bg-emerald-50"
                  onclick="exportSpecialtyExcel('${escapeJs(s.name)}')"
                  title="Xuất riêng phân môn này (Excel)">
                  <i class="fa-solid fa-file-excel mr-1"></i> Excel
                </button>
                <button class="text-[11px] px-2 py-1 rounded border border-slate-200 text-slate-700 hover:bg-slate-50"
                  onclick="exportSpecialtyWord('${escapeJs(s.name)}')"
                  title="Xuất riêng phân môn này (Word)">
                  <i class="fa-solid fa-file-word mr-1"></i> Word
                </button>
                ${lockBloom ? `<span class="text-[11px] text-purple-600 font-semibold"><i class="fa-solid fa-lock mr-1"></i>Khóa Bloom</span>` : ``}
              </div>
            </td>

            <td class="px-3 py-2">
              <select onchange="updateSpecialtyCLO(${pIndex}, ${sIndex}, this.value)"
                class="block w-full text-xs text-slate-600 border-gray-200 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500 py-1.5">
                ${cloOptions}
              </select>
            </td>

            <td class="px-2 py-2 text-center">
              <input type="number" min="0" value="${s.levels[0]}" onchange="updateLevel(${pIndex}, ${sIndex}, 0, this.value)"
                class="w-12 text-center text-sm font-bold border border-gray-200 rounded-md py-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-blue-50/30 text-blue-700">
            </td>
            <td class="px-2 py-2 text-center">
              <input type="number" min="0" value="${s.levels[1]}" onchange="updateLevel(${pIndex}, ${sIndex}, 1, this.value)"
                class="w-12 text-center text-sm font-bold border border-gray-200 rounded-md py-1 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 bg-cyan-50/30 text-cyan-700">
            </td>
            <td class="px-2 py-2 text-center">
              <input type="number" min="0" value="${s.levels[2]}" onchange="updateLevel(${pIndex}, ${sIndex}, 2, this.value)"
                class="w-12 text-center text-sm font-bold border border-gray-200 rounded-md py-1 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-indigo-50/30 text-indigo-700">
            </td>
            <td class="px-2 py-2 text-center">
              <input type="number" min="0" value="${s.levels[3]}" onchange="updateLevel(${pIndex}, ${sIndex}, 3, this.value)"
                class="w-12 text-center text-sm font-bold border border-gray-200 rounded-md py-1 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 bg-purple-50/30 text-purple-700">
            </td>

            <td class="px-4 py-2 text-center font-black text-slate-800 bg-gray-50 border-l border-gray-100">${sTotal}</td>

            <td class="px-2 py-2 text-center">
              <button onclick="exportSpecialtyOnlyRowExcel(${pIndex}, ${sIndex})"
                class="text-emerald-700 hover:text-emerald-900 hover:bg-emerald-50 w-9 h-9 rounded-full inline-flex items-center justify-center transition"
                title="Xuất riêng dòng (Excel)">
                <i class="fa-solid fa-file-arrow-down"></i>
              </button>
            </td>

            <td class="px-2 py-2 text-center">
              <button onclick="removeSpecialty(${pIndex}, ${sIndex})"
                class="text-gray-300 hover:text-red-500 hover:bg-red-50 w-8 h-8 rounded-full flex items-center justify-center transition opacity-0 group-hover:opacity-100">
                <i class="fa-solid fa-trash-can"></i>
              </button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      });

      animateValue("sumRecall", parseInt(document.getElementById('sumRecall').innerText), sumR, 350);
      animateValue("sumUnderstand", parseInt(document.getElementById('sumUnderstand').innerText), sumU, 350);
      animateValue("sumAdvanced", parseInt(document.getElementById('sumAdvanced').innerText), sumAp + sumAn, 350);
      animateValue("grandTotal", parseInt(document.getElementById('grandTotal').innerText), grandTotal, 350);

      const statusEl = document.getElementById('validationStatus');
      const diff = grandTotal - totalQ;

      if (grandTotal === totalQ) {
        statusEl.className = "text-xs font-bold px-3 py-1.5 rounded-full bg-green-100 text-green-700 border border-green-200";
        statusEl.innerHTML = '<i class="fa-solid fa-circle-check mr-1"></i> Hợp lệ';
      } else if (diff > 0) {
        statusEl.className = "text-xs font-bold px-3 py-1.5 rounded-full bg-red-100 text-red-700 border border-red-200";
        statusEl.innerHTML = `<i class="fa-solid fa-circle-exclamation mr-1"></i> Dư ${diff} câu`;
      } else {
        statusEl.className = "text-xs font-bold px-3 py-1.5 rounded-full bg-orange-100 text-orange-700 border border-orange-200";
        statusEl.innerHTML = `<i class="fa-solid fa-triangle-exclamation mr-1"></i> Thiếu ${Math.abs(diff)} câu`;
      }
    }

    function animateValue(id, start, end, duration) {
      if (start === end) return;
      const range = end - start;
      let current = start;
      const increment = end > start ? 1 : -1;
      const stepTime = Math.abs(Math.floor(duration / (range || 1)));
      const obj = document.getElementById(id);
      const timer = setInterval(function () {
        current += increment;
        obj.innerHTML = current;
        if (current == end) clearInterval(timer);
      }, stepTime < 10 ? 10 : stepTime);
      setTimeout(() => { obj.innerHTML = end; clearInterval(timer); }, duration);
    }

    // =========================
    //  LOGIC UPDATES
    // =========================
    function updateCalculations() {
      if (document.getElementById("lockBloom").checked) {
        problems.forEach(p => {
          p.specialties.forEach(s => {
            const total = s.levels.reduce((a,b)=>a+b,0);
            if (total > 0) s.levels = distributeByBloom(total);
          });
        });
      }
      renderProblemsList();
      renderMatrix();
      persistAllLocal();
    }

    function updateProblemWeight(index, val) { problems[index].weight = parseInt(val) || 0; updateCalculations(); }
    function updateProblemName(index, val) { problems[index].name = val; updateCalculations(); }
    function updateProblemSystem(index, systemId) { problems[index].systemId = systemId; updateCalculations(); }

    function addProblem() {
      const fallback = organSystems[0]?.id || "sys";
      problems.push({
        id: Date.now(),
        systemId: fallback,
        name: "Vấn đề mới",
        weight: 0,
        specialties: [{ name: "", cloId: CLOs[0].id, levels: [0, 0, 0, 0] }]
      });
      updateCalculations();
      setTimeout(() => {
        const list = document.getElementById('problemsList');
        list.scrollTop = list.scrollHeight;
      }, 60);
    }

    function removeProblem(index) {
      if (confirm("Xóa vấn đề lâm sàng này sẽ xóa tất cả phân môn liên quan?")) {
        problems.splice(index, 1);
        updateCalculations();
      }
    }

    function addSpecialty(pIndex) {
      problems[pIndex].specialties.push({ name: "", cloId: CLOs[0].id, levels: [0, 0, 0, 0] });
      updateCalculations();
    }

    function quickAddSpecialtyFromLibrary(pIndex, name) {
      if (!name) return;
      problems[pIndex].specialties.push({ name, cloId: CLOs[0].id, levels: [0,0,0,0] });
      updateCalculations();
    }

    function removeSpecialty(pIndex, sIndex) {
      problems[pIndex].specialties.splice(sIndex, 1);
      updateCalculations();
    }

    function updateSpecialtyName(pIndex, sIndex, val) { problems[pIndex].specialties[sIndex].name = val; persistAllLocal(); }
    function updateSpecialtyCLO(pIndex, sIndex, val) { problems[pIndex].specialties[sIndex].cloId = val; persistAllLocal(); }

    function updateLevel(pIndex, sIndex, levelIndex, val) {
      const parsed = parseInt(val) || 0;
      if (parsed >= 0) {
        problems[pIndex].specialties[sIndex].levels[levelIndex] = parsed;
        updateCalculations();
      }
    }

    // =========================
    //  EXPORTS (EXCEL / WORD)
    // =========================
    async function exportExcelWorkbook(filename, sheets) {
      const wb = new ExcelJS.Workbook();
      wb.creator = "MedExam Graduation Tool";
      wb.created = new Date();

      sheets.forEach(sh => {
        const ws = wb.addWorksheet(sh.name || "Sheet");
        (sh.rows || []).forEach(r => ws.addRow(r));

        ws.columns.forEach(col => {
          let max = 10;
          col.eachCell({ includeEmpty: true }, (cell) => {
            const v = cell.value == null ? "" : String(cell.value);
            max = Math.max(max, Math.min(60, v.length + 2));
          });
          col.width = max;
        });

        if ((sh.rows || []).length >= 1) {
          ws.getRow(1).font = { bold: true };
        }
      });

      const buf = await wb.xlsx.writeBuffer();
      saveAs(new Blob([buf], {
        type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
      }), filename);

      showToast("✅ Đã xuất: " + filename);
    }

    async function exportWordDoc(filename, title, rows) {
      const { Document, Packer, Paragraph, TextRun, Table, TableRow, TableCell, WidthType } = docx;

      const doc = new Document({
        sections: [{
          children: [
            new Paragraph({
              children: [new TextRun({ text: title || "MedExam Report", bold: true, size: 32 })],
              spacing: { after: 300 }
            }),
            new Table({
              width: { size: 100, type: WidthType.PERCENTAGE },
              rows: (rows || []).map((r, idx) => new TableRow({
                children: (r || []).map(cell => new TableCell({
                  children: [new Paragraph({
                    children: [new TextRun({ text: String(cell ?? ""), bold: idx === 0 })]
                  })]
                }))
              }))
            })
          ]
        }]
      });

      const blob = await Packer.toBlob(doc);
      saveAs(blob, filename);
      showToast("✅ Đã xuất: " + filename);
    }

    function buildFullReportRows() {
      const rows = [];
      rows.push(["ExamTitle", examSettings.title]);
      rows.push(["ExamYear", examSettings.year]);
      rows.push(["DurationMinutes", String(examSettings.durationMinutes ?? 0)]);
      rows.push([]);
      rows.push(["System","Problem","Weight%","Specialty","CLO","Recall","Understand","Apply","Analyze","Total"]);

      problems.forEach(p => {
        const sysName = getSystemName(p.systemId);
        p.specialties.forEach(s => {
          const clo = CLOs.find(c => c.id === s.cloId);
          rows.push([
            sysName,
            p.name,
            String(p.weight),
            s.name,
            clo ? `${clo.code}: ${clo.name}` : "",
            String(s.levels[0]||0),
            String(s.levels[1]||0),
            String(s.levels[2]||0),
            String(s.levels[3]||0),
            String((s.levels||[]).reduce((a,b)=>a+b,0))
          ]);
        });
      });

      return rows;
    }

    async function exportReportExcel(){
      const rows = buildFullReportRows();
      await exportExcelWorkbook("MedExam_FullReport.xlsx", [{ name: "FullReport", rows }]);
      toggleExportModal(false);
    }

    async function exportReportWord(){
      const rows = buildFullReportRows();
      await exportWordDoc("MedExam_FullReport.docx", "MedExam Full Report", rows);
      toggleExportModal(false);
    }

    function exportSpecialtyChooser() {
      const allSpecs = listAllSpecialtiesUnique();
      if (allSpecs.length === 0) { alert("Chưa có phân môn nào."); return; }

      const pick = prompt("Nhập đúng tên phân môn cần xuất (copy/paste):\n\n" + allSpecs.map(x => "• " + x).join("\n"));
      if (!pick) return;

      // mặc định xuất Excel; bạn muốn Word thì đổi sang exportSpecialtyWord(pick.trim())
      exportSpecialtyExcel(pick.trim());
    }

    function buildSpecialtyExportRows(specialtyName) {
      const target = specialtyName.trim().toLowerCase();
      const matches = [];

      problems.forEach(p => {
        p.specialties.forEach(s => {
          if ((s.name||"").trim().toLowerCase() === target) {
            const clo = CLOs.find(c => c.id === s.cloId);
            matches.push({ p, s, clo });
          }
        });
      });

      if (matches.length === 0) return null;

      const rows = [];
      rows.push(["ExamTitle", examSettings.title]);
      rows.push(["ExamYear", examSettings.year]);
      rows.push(["Specialty", specialtyName]);
      rows.push([]);
      rows.push(["System","Problem","Weight%","CLO","Recall","Understand","Apply","Analyze","Total"]);

      matches.forEach(m => {
        rows.push([
          getSystemName(m.p.systemId),
          m.p.name,
          String(m.p.weight),
          m.clo ? `${m.clo.code}: ${m.clo.name}` : "",
          String(m.s.levels[0]||0),
          String(m.s.levels[1]||0),
          String(m.s.levels[2]||0),
          String(m.s.levels[3]||0),
          String(m.s.levels.reduce((a,b)=>a+b,0))
        ]);
      });

      rows.push([]);
      const tot = matches.reduce((acc, m) => {
        acc.recall += (m.s.levels[0]||0);
        acc.understand += (m.s.levels[1]||0);
        acc.apply += (m.s.levels[2]||0);
        acc.analyze += (m.s.levels[3]||0);
        return acc;
      }, {recall:0, understand:0, apply:0, analyze:0});
      const sum = tot.recall + tot.understand + tot.apply + tot.analyze;
      rows.push(["TOTAL","","","",String(tot.recall),String(tot.understand),String(tot.apply),String(tot.analyze),String(sum)]);
      return rows;
    }

    async function exportSpecialtyExcel(specialtyName) {
      const rows = buildSpecialtyExportRows(specialtyName);
      if (!rows) { alert("Không tìm thấy phân môn: " + specialtyName); return; }
      const safe = filenameSafe(specialtyName);
      await exportExcelWorkbook(`PhanMon_${safe}.xlsx`, [{ name: "Specialty", rows }]);
    }

    async function exportSpecialtyWord(specialtyName) {
      const rows = buildSpecialtyExportRows(specialtyName);
      if (!rows) { alert("Không tìm thấy phân môn: " + specialtyName); return; }
      const safe = filenameSafe(specialtyName);
      await exportWordDoc(`PhanMon_${safe}.docx`, `Phân môn: ${specialtyName}`, rows);
    }

    async function exportSpecialtyOnlyRowExcel(pIndex, sIndex) {
      const p = problems[pIndex];
      const s = p?.specialties?.[sIndex];
      if (!p || !s) return;

      const clo = CLOs.find(c => c.id === s.cloId);
      const rows = [];
      rows.push(["ExamTitle", examSettings.title]);
      rows.push(["ExamYear", examSettings.year]);
      rows.push(["System", getSystemName(p.systemId)]);
      rows.push(["Problem", p.name]);
      rows.push([]);
      rows.push(["Specialty","CLO","Recall","Understand","Apply","Analyze","Total"]);
      rows.push([
        s.name,
        clo ? `${clo.code}: ${clo.name}` : "",
        String(s.levels[0]||0),
        String(s.levels[1]||0),
        String(s.levels[2]||0),
        String(s.levels[3]||0),
        String(s.levels.reduce((a,b)=>a+b,0))
      ]);

      await exportExcelWorkbook(`Row_${filenameSafe(s.name)}_${filenameSafe(p.name)}.xlsx`, [
        { name: "Row", rows }
      ]);
    }

    async function exportProblemSummaryExcel(pIndex) {
      const p = problems[pIndex];
      if (!p) return;

      const rows = [];
      rows.push(["ExamTitle", examSettings.title]);
      rows.push(["ExamYear", examSettings.year]);
      rows.push(["System", getSystemName(p.systemId)]);
      rows.push(["Problem", p.name]);
      rows.push(["Weight%", String(p.weight)]);
      rows.push([]);
      rows.push(["Specialty","TotalQuestions","Recall","Understand","Apply","Analyze","CLO"]);

      p.specialties.forEach(s => {
        const clo = CLOs.find(c => c.id === s.cloId);
        rows.push([
          s.name,
          String(s.levels.reduce((a,b)=>a+b,0)),
          String(s.levels[0]||0),
          String(s.levels[1]||0),
          String(s.levels[2]||0),
          String(s.levels[3]||0),
          clo ? `${clo.code}: ${clo.name}` : ""
        ]);
      });

      await exportExcelWorkbook(`VanDe_${filenameSafe(p.name)}.xlsx`, [
        { name: "Problem", rows }
      ]);
    }

    function listAllSpecialtiesUnique() {
      const set = new Set();
      problems.forEach(p => p.specialties.forEach(s => {
        const n = (s.name || "").trim();
        if (n) set.add(n);
      }));
      return Array.from(set).sort((a,b)=>a.localeCompare(b,'vi'));
    }

    // =========================
    //  HELPERS
    // =========================
    function getSystemName(systemId) {
      const s = organSystems.find(x => x.id === systemId);
      return s ? s.name : "Chưa phân nhóm";
    }

    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function escapeJs(str) { return String(str ?? "").replaceAll("\\", "\\\\").replaceAll("'", "\\'"); }

    function filenameSafe(str) {
      return String(str ?? "export")
        .trim()
        .replace(/[\\\/:*?"<>|]+/g, "_")
        .replace(/\s+/g, "_")
        .slice(0, 80);
    }

    // =========================
    //  INIT
    // =========================
    window.onload = function () {
      restoreCardHeights();
      attachResizeObservers();

      restoreAllLocal();
      syncExamUI();
      updateBloomHint();
      updateCalculations();
    };
  </script>
</body>
</html>
