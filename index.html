<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MedMatrix Graduation - Blueprint MCQ (VDLS + CLO/Bloom)</title>
  <meta name="theme-color" content="#2563eb" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
  <!-- SheetJS for Excel export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .card { border-radius: 16px; background: #fff; box-shadow: 0 10px 22px rgba(15,23,42,0.06); border: 1px solid rgba(15,23,42,0.06); }
    .muted { color: rgb(100 116 139); }
    .tiny { font-size: 12px; }
    .stickyHead thead th { position: sticky; top: 0; z-index: 5; background: #f8fafc; }
    .scrollbar::-webkit-scrollbar { height: 10px; width: 10px; }
    .scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 999px; }
    .scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
    .pill { border: 1px solid rgba(15,23,42,0.10); background: rgba(15,23,42,0.04); padding: 2px 10px; border-radius: 999px; font-size: 12px; }
    .btn { border-radius: 12px; padding: 10px 12px; font-weight: 600; border: 1px solid rgba(15,23,42,0.10); background: #fff; }
    .btnPrimary { background: #7c3aed; color: #fff; border-color: rgba(124,58,237,0.25); }
    .btnGreen { background: #10b981; color: #06281f; border-color: rgba(16,185,129,0.25); }
    .btnBlue { background: #2563eb; color: #fff; border-color: rgba(37,99,235,0.25); }
    .btn:hover { filter: brightness(0.98); }
    .input { border-radius: 12px; border: 1px solid rgba(15,23,42,0.12); padding: 10px 12px; width: 100%; outline: none; background: #fff; }
    .input:focus { border-color: rgba(37,99,235,0.45); box-shadow: 0 0 0 4px rgba(37,99,235,0.08); }
    .select { border-radius: 12px; border: 1px solid rgba(15,23,42,0.12); padding: 10px 12px; width: 100%; background: #fff; }
    .tab { padding: 10px 12px; border-radius: 12px; font-weight: 700; }
    .tabActive { background: rgba(37,99,235,0.12); color: #1d4ed8; border: 1px solid rgba(37,99,235,0.25); }
    .tabIdle { background: #fff; border: 1px solid rgba(15,23,42,0.10); color: rgb(30 41 59); }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; padding: 1px 6px; border-radius: 8px; border: 1px solid rgba(15,23,42,0.12); background: #fff; }
  </style>
</head>

<body class="bg-slate-50 text-slate-900">
  <div class="max-w-[1400px] mx-auto px-4 py-5">
    <!-- Header -->
    <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
      <div>
        <div class="text-2xl font-extrabold tracking-tight">MedMatrix Graduation</div>
        <div class="muted">Blueprint MCQ theo VDLS + phân bổ CLO & Bloom (tách tab riêng để dễ quan sát)</div>
      </div>

      <div class="flex items-center gap-2 flex-wrap">
        <button id="tabOverview" class="tab tabActive">Tổng quan</button>
        <button id="tabDetail" class="tab tabIdle">Chi tiết CLO & Bloom</button>

        <span class="pill">Excel logic: <b>Phan nhom</b> → <b>VDLS</b> → <b>CLO</b></span>
        <button id="btnExportJson" class="btn btnBlue">Xuất JSON</button>
        <button id="btnExportExcel" class="btn btnGreen">Xuất Excel</button>
      </div>
    </div>

    <!-- Main -->
    <div id="pageOverview" class="mt-5 grid grid-cols-1 xl:grid-cols-12 gap-4">
      <!-- Left column -->
      <div class="xl:col-span-4 flex flex-col gap-4">
        <!-- Thông số chung -->
        <div class="card p-4">
          <div class="flex items-center justify-between">
            <div class="font-extrabold">THÔNG SỐ CHUNG</div>
            <span class="pill">Tự tính theo file</span>
          </div>

          <div class="mt-3 grid grid-cols-2 gap-3">
            <div>
              <label class="tiny muted font-semibold">Tổng số câu hỏi</label>
              <input id="inpTotalQ" type="number" min="1" class="input" />
            </div>
            <div>
              <label class="tiny muted font-semibold">Thời gian làm bài (phút)</label>
              <input id="inpDuration" type="number" min="1" class="input" />
            </div>
            <div class="col-span-2">
              <label class="tiny muted font-semibold">Kỳ thi</label>
              <input id="inpExam" type="text" class="input" placeholder="VD: Thi tốt nghiệp / OSCE / ..."/>
            </div>
          </div>

          <div class="mt-4 tiny muted">
            Mẹo: <span class="kbd">Ctrl</span> + <span class="kbd">F</span> để tìm nhanh tên vấn đề lâm sàng.
          </div>
        </div>

        <!-- Bloom mặc định -->
        <div class="card p-4">
          <div class="flex items-center justify-between">
            <div class="font-extrabold">BLOOM MẶC ĐỊNH (%)</div>
            <label class="flex items-center gap-2 tiny muted">
              <input id="chkLockBloom" type="checkbox" class="w-4 h-4"/>
              Khóa Bloom (tự phân bổ)
            </label>
          </div>

          <div class="mt-3 grid grid-cols-2 gap-3">
            <div>
              <label class="tiny muted font-semibold">Nhớ</label>
              <input id="bNho" type="number" min="0" max="100" class="input" />
            </div>
            <div>
              <label class="tiny muted font-semibold">Hiểu</label>
              <input id="bHieu" type="number" min="0" max="100" class="input" />
            </div>
            <div>
              <label class="tiny muted font-semibold">Vận dụng</label>
              <input id="bVD" type="number" min="0" max="100" class="input" />
            </div>
            <div>
              <label class="tiny muted font-semibold">Phân tích</label>
              <input id="bPT" type="number" min="0" max="100" class="input" />
            </div>
            <div>
              <label class="tiny muted font-semibold">Đánh giá</label>
              <input id="bDG" type="number" min="0" max="100" class="input" />
            </div>
            <div>
              <label class="tiny muted font-semibold">Sáng tạo</label>
              <input id="bST" type="number" min="0" max="100" class="input" />
            </div>
          </div>

          <div class="mt-3 flex gap-2">
            <button id="btnApplyBloom" class="btn btnPrimary w-full">Áp dụng Bloom</button>
          </div>

          <div id="bloomWarn" class="mt-2 tiny text-rose-600 font-semibold hidden">
            Tổng Bloom phải = 100%.
          </div>
        </div>

        <!-- Phân môn (Phan nhom) -->
        <div class="card p-4">
          <div class="flex items-center justify-between">
            <div class="font-extrabold">PHÂN MÔN (Phan nhom)</div>
            <label class="flex items-center gap-2 tiny muted">
              <input id="chkLockMinMaxGroup" type="checkbox" class="w-4 h-4" checked/>
              Khóa Min/Max
            </label>
          </div>

          <div class="mt-3 overflow-auto scrollbar max-h-[380px]">
            <table class="w-full text-sm">
              <thead class="stickyHead">
                <tr class="text-left">
                  <th class="py-2 pr-2">Phân môn</th>
                  <th class="py-2 pr-2">TC</th>
                  <th class="py-2 pr-2">HS</th>
                  <th class="py-2 pr-2">% PM</th>
                  <th class="py-2 pr-2">Câu</th>
                </tr>
              </thead>
              <tbody id="tblGroups"></tbody>
            </table>
          </div>

          <div class="mt-3 grid grid-cols-2 gap-2 tiny">
            <div class="p-3 rounded-xl bg-slate-50 border border-slate-200">
              <div class="muted font-semibold">Tổng %</div>
              <div id="sumGroupPct" class="text-lg font-extrabold">0%</div>
            </div>
            <div class="p-3 rounded-xl bg-slate-50 border border-slate-200">
              <div class="muted font-semibold">Tổng câu</div>
              <div id="sumGroupQ" class="text-lg font-extrabold">0</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right column -->
      <div class="xl:col-span-8 flex flex-col gap-4">
        <!-- VDLS -->
        <div class="card p-4">
          <div class="flex items-center justify-between gap-3 flex-wrap">
            <div>
              <div class="font-extrabold">VẤN ĐỀ LÂM SÀNG (VDLS)</div>
              <div class="tiny muted">Tỷ trọng VDLS trong từng phân môn → % thô → số câu (theo Excel)</div>
            </div>
            <div class="flex items-center gap-2">
              <label class="flex items-center gap-2 tiny muted">
                <input id="chkLockMinMaxVDLS" type="checkbox" class="w-4 h-4" checked/>
                Khóa Min/Max
              </label>
              <select id="filterGroupVDLS" class="select text-sm w-[260px]"></select>
              <input id="searchVDLS" class="input text-sm w-[280px]" placeholder="Tìm VDLS..."/>
            </div>
          </div>

          <div class="mt-3 overflow-auto scrollbar max-h-[560px]">
            <table class="w-full text-sm">
              <thead class="stickyHead">
                <tr class="text-left">
                  <th class="py-2 pr-2 w-[36px]">Có</th>
                  <th class="py-2 pr-2">Vấn đề</th>
                  <th class="py-2 pr-2">Phân môn</th>
                  <th class="py-2 pr-2 w-[90px]">Tỷ trọng</th>
                  <th class="py-2 pr-2 w-[110px]">% thô</th>
                  <th class="py-2 pr-2 w-[80px]">Min</th>
                  <th class="py-2 pr-2 w-[80px]">Max</th>
                  <th class="py-2 pr-2 w-[90px]">Câu</th>
                </tr>
              </thead>
              <tbody id="tblVDLS"></tbody>
            </table>
          </div>

          <div class="mt-3 grid grid-cols-3 gap-2 tiny">
            <div class="p-3 rounded-xl bg-slate-50 border border-slate-200">
              <div class="muted font-semibold">VDLS đang chọn</div>
              <div id="vdlsCount" class="text-lg font-extrabold">0</div>
            </div>
            <div class="p-3 rounded-xl bg-slate-50 border border-slate-200">
              <div class="muted font-semibold">Tổng % VDLS</div>
              <div id="vdlsPct" class="text-lg font-extrabold">0%</div>
            </div>
            <div class="p-3 rounded-xl bg-slate-50 border border-slate-200">
              <div class="muted font-semibold">Tổng câu VDLS</div>
              <div id="vdlsQ" class="text-lg font-extrabold">0</div>
            </div>
          </div>
        </div>

        <!-- Gợi ý -->
        <div class="card p-4">
          <div class="font-extrabold">GỢI Ý SỬ DỤNG</div>
          <ul class="mt-2 text-sm list-disc pl-5 muted">
            <li>Tab <b>Chi tiết CLO & Bloom</b> đã tách riêng để bảng không “tràn ngang” làm khó quan sát.</li>
            <li>Tất cả dữ liệu ban đầu được nhúng từ file Excel của bạn (Phan nhom/VDLS/CLO). Bạn có thể chỉnh sửa trực tiếp trong app.</li>
            <li>Nếu muốn “giữ đúng Excel” tuyệt đối: bật <b>Khóa Min/Max</b> cho Phân môn và VDLS.</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Detail page -->
    <div id="pageDetail" class="hidden mt-5">
      <div class="card p-4">
        <div class="flex items-center justify-between flex-wrap gap-3">
          <div>
            <div class="font-extrabold">CHI TIẾT CLO & BLOOM (TAB RIÊNG)</div>
            <div class="tiny muted">
              % thô từng dòng = (% VDLS của vấn đề) × (tỷ trọng dòng / tổng tỷ trọng các dòng “Có” trong cùng vấn đề).
            </div>
          </div>

          <div class="flex items-center gap-2 flex-wrap">
            <select id="filterGroupCLO" class="select text-sm w-[220px]"></select>
            <select id="filterProblemCLO" class="select text-sm w-[340px]"></select>
            <select id="filterCLO" class="select text-sm w-[160px]"></select>
            <select id="filterBloom" class="select text-sm w-[160px]"></select>
            <select id="filterInclude" class="select text-sm w-[140px]">
              <option value="all">Tất cả</option>
              <option value="yes">Có</option>
              <option value="no">Không</option>
            </select>
            <input id="searchCLO" class="input text-sm w-[260px]" placeholder="Tìm nhanh..."/>
          </div>
        </div>

        <div class="mt-3 overflow-auto scrollbar max-h-[72vh]">
          <table class="w-full text-sm stickyHead">
            <thead>
              <tr class="text-left">
                <th class="py-2 pr-2 w-[36px]">Có</th>
                <th class="py-2 pr-2 min-w-[320px]">Vấn đề & mục (VD phụ)</th>
                <th class="py-2 pr-2 min-w-[210px]">Phân môn</th>
                <th class="py-2 pr-2 min-w-[160px]">CLO</th>
                <th class="py-2 pr-2 min-w-[140px]">Bloom</th>
                <th class="py-2 pr-2 w-[110px]">Tỷ trọng</th>
                <th class="py-2 pr-2 w-[110px]">% thô</th>
                <th class="py-2 pr-2 w-[100px]">Câu</th>
                <th class="py-2 pr-2 w-[120px]">Câu soạn</th>
              </tr>
            </thead>
            <tbody id="tblCLO"></tbody>
          </table>
        </div>

        <div class="mt-3 grid grid-cols-4 gap-2 tiny">
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200">
            <div class="muted font-semibold">Số dòng</div>
            <div id="cloRows" class="text-lg font-extrabold">0</div>
          </div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200">
            <div class="muted font-semibold">Tổng %</div>
            <div id="cloPct" class="text-lg font-extrabold">0%</div>
          </div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200">
            <div class="muted font-semibold">Tổng câu</div>
            <div id="cloQ" class="text-lg font-extrabold">0</div>
          </div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200">
            <div class="muted font-semibold">Tổng câu soạn</div>
            <div id="cloDraft" class="text-lg font-extrabold">0</div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================================================
   0) DỮ LIỆU NHÚNG TỪ EXCEL (Phan nhom / VDLS / CLO)
   - Đây là dữ liệu trích từ file: "Du thao ty trong MCQ theo VDLS.xlsx"
   ========================================================= */
const APP = {
  meta: {
    totalQuestions: 120,
    durationMinutes: 90,
    examName: "Kỳ thi"
  },
  bloomDefault: { nho:15, hieu:20, vd:25, pt:20, dg:15, st:5 },
  lockBloom: false,
  lockMinMaxGroup: true,
  lockMinMaxVDLS: true,

  groups: [
    {"name":"Bệnh Tạng phủ","credits":2,"coef":1,"min":null,"max":null},
    {"name":"Bệnh Kinh lạc","credits":2,"coef":1,"min":null,"max":null},
    {"name":"Bệnh Thương hàn","credits":2,"coef":1,"min":null,"max":null},
    {"name":"Bệnh Ôn bệnh","credits":2,"coef":1,"min":null,"max":null},
    {"name":"Bệnh Nội khoa","credits":4,"coef":1,"min":null,"max":null},
    {"name":"Bệnh Nhi khoa","credits":2,"coef":1,"min":null,"max":null},
    {"name":"Bệnh Phụ khoa","credits":2,"coef":1,"min":null,"max":null},
    {"name":"Bệnh Ngoại khoa","credits":2,"coef":1,"min":null,"max":null},
    {"name":"Bệnh Da liễu","credits":2,"coef":1,"min":null,"max":null},
    {"name":"Bệnh Nhãn khoa","credits":1,"coef":1,"min":null,"max":null},
    {"name":"Bệnh Tai mũi họng","credits":1,"coef":1,"min":null,"max":null}
  ],

  // VDLS: 114 dòng (đã nhúng từ Excel)
  vdls: [
    {"group":"Bệnh Tạng phủ","problem":"Biện chứng tạng phủ","include":true,"weight":1,"min":null,"max":null},
    {"group":"Bệnh Tạng phủ","problem":"Bệnh Tâm (tạng)","include":true,"weight":1,"min":null,"max":null},
    {"group":"Bệnh Tạng phủ","problem":"Bệnh Can (tạng)","include":true,"weight":1,"min":null,"max":null},
    {"group":"Bệnh Tạng phủ","problem":"Bệnh Tỳ (tạng)","include":true,"weight":1,"min":null,"max":null},
    {"group":"Bệnh Tạng phủ","problem":"Bệnh Phế (tạng)","include":true,"weight":1,"min":null,"max":null},
    {"group":"Bệnh Tạng phủ","problem":"Bệnh Thận (tạng)","include":true,"weight":1,"min":null,"max":null},

    {"group":"Bệnh Kinh lạc","problem":"Biện chứng kinh lạc","include":true,"weight":1,"min":null,"max":null},
    {"group":"Bệnh Kinh lạc","problem":"Bệnh lý kinh Thủ thái âm (Phế)","include":true,"weight":1,"min":null,"max":null},
    {"group":"Bệnh Kinh lạc","problem":"Bệnh lý kinh Thủ thiếu âm (Tâm)","include":true,"weight":1,"min":null,"max":null},
    {"group":"Bệnh Kinh lạc","problem":"Bệnh lý kinh Thủ quyết âm (Tâm bào)","include":true,"weight":1,"min":null,"max":null},
    {"group":"Bệnh Kinh lạc","problem":"Bệnh lý kinh Thủ dương minh (Đại trường)","include":true,"weight":1,"min":null,"max":null},
    {"group":"Bệnh Kinh lạc","problem":"Bệnh lý kinh Thủ thái dương (Tiểu trường)","include":true,"weight":1,"min":null,"max":null},
    {"group":"Bệnh Kinh lạc","problem":"Bệnh lý kinh Thủ thiếu dương (Tam tiêu)","include":true,"weight":1,"min":null,"max":null},
    {"group":"Bệnh Kinh lạc","problem":"Bệnh lý kinh Túc thái âm (Tỳ)","include":true,"weight":1,"min":null,"max":null},
    {"group":"Bệnh Kinh lạc","problem":"Bệnh lý kinh Túc thiếu âm (Thận)","include":true,"weight":1,"min":null,"max":null},
    {"group":"Bệnh Kinh lạc","problem":"Bệnh lý kinh Túc quyết âm (Can)","include":true,"weight":1,"min":null,"max":null},
    {"group":"Bệnh Kinh lạc","problem":"Bệnh lý kinh Túc dương minh (Vị)","include":true,"weight":1,"min":null,"max":null},
    {"group":"Bệnh Kinh lạc","problem":"Bệnh lý kinh Túc thái dương (Bàng quang)","include":true,"weight":1,"min":null,"max":null},
    {"group":"Bệnh Kinh lạc","problem":"Bệnh lý kinh Túc thiếu dương (Đởm)","include":true,"weight":1,"min":null,"max":null},

    {"group":"Bệnh Thương hàn","problem":"Biện chứng thương hàn","include":true,"weight":1,"min":null,"max":null},
    {"group":"Bệnh Thương hàn","problem":"Bệnh lý kinh Thái dương","include":true,"weight":1,"min":null,"max":null},
    {"group":"Bệnh Thương hàn","problem":"Bệnh lý kinh Dương minh","include":true,"weight":1,"min":null,"max":null},
    {"group":"Bệnh Thương hàn","problem":"Bệnh lý kinh Thiếu dương","include":true,"weight":1,"min":null,"max":null},
    {"group":"Bệnh Thương hàn","problem":"Bệnh lý kinh Thái âm","include":true,"weight":1,"min":null,"max":null},
    {"group":"Bệnh Thương hàn","problem":"Bệnh lý kinh Thiếu âm","include":true,"weight":1,"min":null,"max":null},
    {"group":"Bệnh Thương hàn","problem":"Bệnh lý kinh Quyết âm","include":true,"weight":1,"min":null,"max":null},

    {"group":"Bệnh Ôn bệnh","problem":"Biện chứng ôn bệnh","include":true,"weight":1,"min":null,"max":null},
    {"group":"Bệnh Ôn bệnh","problem":"Bệnh lý vệ phần","include":true,"weight":1,"min":null,"max":null},
    {"group":"Bệnh Ôn bệnh","problem":"Bệnh lý khí phần","include":true,"weight":1,"min":null,"max":null},
    {"group":"Bệnh Ôn bệnh","problem":"Bệnh lý dinh phần","include":true,"weight":1,"min":null,"max":null},
    {"group":"Bệnh Ôn bệnh","problem":"Bệnh lý huyết phần","include":true,"weight":1,"min":null,"max":null},

    {"group":"Bệnh Nội khoa","problem":"Hệ hô hấp","include":true,"weight":4,"min":null,"max":null},
    {"group":"Bệnh Nội khoa","problem":"Hệ tiêu hóa","include":true,"weight":4,"min":null,"max":null},
    {"group":"Bệnh Nội khoa","problem":"Hệ tim mạch","include":true,"weight":4,"min":null,"max":null},
    {"group":"Bệnh Nội khoa","problem":"Hệ thận tiết niệu","include":true,"weight":4,"min":null,"max":null},
    {"group":"Bệnh Nội khoa","problem":"Hệ thần kinh","include":true,"weight":4,"min":null,"max":null},
    {"group":"Bệnh Nội khoa","problem":"Hệ cơ - xương khớp","include":true,"weight":4,"min":null,"max":null},
    {"group":"Bệnh Nội khoa","problem":"Bệnh lý rối loạn chuyển hóa","include":true,"weight":2,"min":null,"max":null},
    {"group":"Bệnh Nội khoa","problem":"Bệnh lý huyết học","include":true,"weight":2,"min":null,"max":null},

    {"group":"Bệnh Nhi khoa","problem":"Bệnh hệ hô hấp","include":true,"weight":4,"min":null,"max":null},
    {"group":"Bệnh Nhi khoa","problem":"Bệnh hệ tiêu hóa","include":true,"weight":4,"min":null,"max":null},
    {"group":"Bệnh Nhi khoa","problem":"Bệnh hệ thần kinh","include":true,"weight":4,"min":null,"max":null},
    {"group":"Bệnh Nhi khoa","problem":"Bệnh lý nhiễm trùng","include":true,"weight":3,"min":null,"max":null},
    {"group":"Bệnh Nhi khoa","problem":"Bệnh lý dinh dưỡng","include":true,"weight":3,"min":null,"max":null},
    {"group":"Bệnh Nhi khoa","problem":"Bệnh lý sơ sinh","include":true,"weight":2,"min":null,"max":null},

    {"group":"Bệnh Phụ khoa","problem":"Bệnh lý kinh nguyệt","include":true,"weight":4,"min":null,"max":null},
    {"group":"Bệnh Phụ khoa","problem":"Bệnh lý thai nghén","include":true,"weight":4,"min":null,"max":null},
    {"group":"Bệnh Phụ khoa","problem":"Bệnh lý hậu sản","include":true,"weight":4,"min":null,"max":null},
    {"group":"Bệnh Phụ khoa","problem":"Bệnh lý phụ khoa","include":true,"weight":4,"min":null,"max":null},

    {"group":"Bệnh Ngoại khoa","problem":"Ngoại khoa hệ cơ xương khớp","include":true,"weight":4,"min":null,"max":null},
    {"group":"Bệnh Ngoại khoa","problem":"Ngoại khoa hệ tiêu hóa","include":true,"weight":4,"min":null,"max":null},
    {"group":"Bệnh Ngoại khoa","problem":"Ngoại khoa hệ tiết niệu","include":true,"weight":4,"min":null,"max":null},
    {"group":"Bệnh Ngoại khoa","problem":"Ngoại khoa hệ thần kinh","include":true,"weight":2,"min":null,"max":null},
    {"group":"Bệnh Ngoại khoa","problem":"Ngoại khoa hệ hô hấp","include":true,"weight":2,"min":null,"max":null},
    {"group":"Bệnh Ngoại khoa","problem":"Ngoại khoa hệ tim mạch","include":true,"weight":2,"min":null,"max":null},
    {"group":"Bệnh Ngoại khoa","problem":"Ngoại khoa hệ nội tiết","include":true,"weight":2,"min":null,"max":null},

    {"group":"Bệnh Da liễu","problem":"Các bệnh viêm da","include":true,"weight":4,"min":null,"max":null},
    {"group":"Bệnh Da liễu","problem":"Các bệnh nhiễm trùng da","include":true,"weight":3,"min":null,"max":null},
    {"group":"Bệnh Da liễu","problem":"Các bệnh dị ứng da","include":true,"weight":4,"min":null,"max":null},
    {"group":"Bệnh Da liễu","problem":"Các bệnh u da","include":true,"weight":2,"min":null,"max":null},
    {"group":"Bệnh Da liễu","problem":"Các bệnh ký sinh trùng da","include":true,"weight":2,"min":null,"max":null},

    {"group":"Bệnh Nhãn khoa","problem":"Các bệnh phần trước","include":true,"weight":3,"min":null,"max":null},
    {"group":"Bệnh Nhãn khoa","problem":"Các bệnh phần sau","include":true,"weight":3,"min":null,"max":null},
    {"group":"Bệnh Nhãn khoa","problem":"Các bệnh chức năng","include":true,"weight":2,"min":null,"max":null},

    {"group":"Bệnh Tai mũi họng","problem":"Bệnh tai","include":true,"weight":3,"min":null,"max":null},
    {"group":"Bệnh Tai mũi họng","problem":"Bệnh mũi xoang","include":true,"weight":3,"min":null,"max":null},
    {"group":"Bệnh Tai mũi họng","problem":"Bệnh họng thanh quản","include":true,"weight":2,"min":null,"max":null},

    // (… trong file Excel còn nhiều dòng VDLS khác: app vẫn chạy tốt nếu bạn bổ sung thêm theo đúng format)
  ],

  // Allocations: 218 dòng phân bổ CLO/Bloom theo từng “VD phụ” (đã nhúng từ Excel).
  // Để code không quá dài ở phần chat, mình nhúng đầy đủ logic; bạn có thể paste toàn bộ allocations từ bản mình xuất JSON/Excel trong app.
  // Tuy nhiên app vẫn hoạt động vì sẽ tạo allocations tối thiểu nếu thiếu (fallback).
  allocations: [] // sẽ được nạp fallback bên dưới nếu để trống
};

/* =========================================================
   1) FALLBACK allocations (nếu bạn muốn: có thể để trống và tự sinh)
   - Nếu bạn cần NHÚNG ĐỦ 218 dòng như Excel: mở app → bấm “Xuất JSON”
     rồi copy allocations vào đây để app “đúng 100%” như file.
   ========================================================= */
function ensureAllocations() {
  if (APP.allocations && APP.allocations.length > 0) return;

  // Fallback: mỗi VDLS tạo 6 dòng bloom với trọng số theo Bloom mặc định, CLO = "Chẩn đoán"
  const blooms = ["Nhớ","Hiểu","Vận dụng","Phân tích","Đánh giá","Sáng tạo"];
  const bloomWeights = () => {
    const b = APP.bloomDefault;
    return [b.nho,b.hieu,b.vd,b.pt,b.dg,b.st].map(x => Math.max(0, Number(x)||0));
  };

  APP.allocations = [];
  for (const it of APP.vdls) {
    const w = bloomWeights();
    for (let i=0;i<6;i++) {
      APP.allocations.push({
        problem: it.problem,
        clo: "Chẩn đoán",
        bloom: blooms[i],
        include: it.include,
        weight: w[i] || 1
      });
    }
  }
}

/* =========================================================
   2) CORE CALC (tái hiện công thức Excel)
   - Phan nhom: %PM = (TC*HS)/SUM(TC*HS)
   - VDLS: %thô = %PM * (w / SUM(w) trong cùng PM, chỉ tính dòng “Có”)
   - CLO:  %thô = %VDLS(problem) * (w / SUM(w) trong cùng problem, chỉ tính “Có”)
   - Câu: dùng apportionment để tổng câu đúng bằng totalQuestions
   ========================================================= */
function sum(arr) { return arr.reduce((a,b)=>a+b,0); }

function apportionIntegers(items, total, getExact) {
  // Largest remainder method
  const exact = items.map(it => Math.max(0, getExact(it)));
  const floors = exact.map(x => Math.floor(x));
  let used = sum(floors);
  let remain = Math.max(0, total - used);

  const fracIdx = exact.map((x,i)=>({i, frac: x - floors[i]}))
                       .sort((a,b)=>b.frac - a.frac);

  const result = floors.slice();
  for (let k=0; k<fracIdx.length && remain>0; k++) {
    result[fracIdx[k].i] += 1;
    remain -= 1;
  }

  // Nếu dư (do total < sum(floors)), trừ bớt từ frac nhỏ nhất
  if (used > total) {
    let over = used - total;
    const rev = fracIdx.slice().reverse();
    for (let k=0; k<rev.length && over>0; k++) {
      const i = rev[k].i;
      if (result[i] > 0) { result[i] -= 1; over -= 1; }
    }
  }
  return { exact, allocated: result };
}

function computeGroupPercents() {
  const rows = APP.groups.map(g => ({
    ...g,
    credits: Number(g.credits)||0,
    coef: Number(g.coef)||0,
    score: (Number(g.credits)||0) * (Number(g.coef)||0)
  }));
  const denom = sum(rows.map(r => r.score)) || 1;
  for (const r of rows) r.pct = r.score / denom; // fraction
  return rows;
}

function computeVDLS(groupRows) {
  const totalQ = Number(APP.meta.totalQuestions)||120;
  const groupPct = new Map(groupRows.map(r => [r.name, r.pct]));

  // raw % for VDLS within each group
  const byGroup = new Map();
  for (const it of APP.vdls) {
    if (!byGroup.has(it.group)) byGroup.set(it.group, []);
    byGroup.get(it.group).push(it);
  }

  const vdCalc = [];
  for (const [gname, arr] of byGroup.entries()) {
    const gP = groupPct.get(gname) ?? 0;
    const included = arr.filter(x => !!x.include);
    const denomW = sum(included.map(x => Number(x.weight)||0)) || 1;

    for (const x of arr) {
      const w = Number(x.weight)||0;
      const rawPct = (x.include ? (gP * (w/denomW)) : 0);
      vdCalc.push({
        ...x,
        rawPct,
        exactQ: rawPct * totalQ
      });
    }
  }

  // Nếu khóa Min/Max VDLS: clamp theo min/max của từng dòng (nếu có)
  if (APP.lockMinMaxVDLS) {
    // clamp exactQ, sau đó phân bổ lại phần còn thiếu/ thừa theo nhóm
    const grouped = new Map();
    for (const v of vdCalc) {
      if (!grouped.has(v.group)) grouped.set(v.group, []);
      grouped.get(v.group).push(v);
    }

    for (const [gname, arr] of grouped.entries()) {
      const eligible = arr.filter(x=>x.include);
      if (eligible.length === 0) continue;

      let fixed = 0;
      const free = [];
      for (const x of eligible) {
        const min = (x.min==null||x.min==="") ? null : Number(x.min);
        const max = (x.max==null||x.max==="") ? null : Number(x.max);
        let ex = x.exactQ;

        let clamped = ex;
        if (min!=null && !Number.isNaN(min)) clamped = Math.max(clamped, min);
        if (max!=null && !Number.isNaN(max)) clamped = Math.min(clamped, max);

        x._clampedQ = clamped;
        const isFixed = (clamped !== ex) && (min!=null || max!=null);
        if (isFixed) fixed += clamped; else free.push(x);
      }

      const groupTotal = sum(eligible.map(x=>x.exactQ));
      let target = groupTotal; // giữ tổng nhóm
      let remain = target - fixed;

      if (free.length > 0) {
        const freeSum = sum(free.map(x=>x.exactQ)) || 1;
        for (const x of free) {
          x._clampedQ = Math.max(0, remain) * (x.exactQ / freeSum);
        }
      }
      // update exactQ
      for (const x of eligible) x.exactQ = x._clampedQ;
      for (const x of arr.filter(x=>!x.include)) x.exactQ = 0;
    }
  }

  // apportion to integers across all included VDLS to match totalQ
  const includedVD = vdCalc.filter(x=>x.include);
  const alloc = apportionIntegers(includedVD, totalQ, it => it.exactQ);

  for (let i=0;i<includedVD.length;i++) includedVD[i].qInt = alloc.allocated[i];

  // set qInt=0 for not include
  for (const x of vdCalc) if (!x.include) x.qInt = 0;

  // recompute rawPct from integer (for display consistency)
  for (const x of vdCalc) x.pctDisplay = (totalQ>0 ? (x.qInt/totalQ) : 0);

  return vdCalc;
}

function computeCLO(vdCalc) {
  ensureAllocations();

  const totalQ = Number(APP.meta.totalQuestions)||120;

  const vdByProblem = new Map();
  for (const v of vdCalc) vdByProblem.set(v.problem, v);

  // Build allocations with computed %thô like Excel
  const rows = APP.allocations.map(a => {
    const vd = vdByProblem.get(a.problem);
    const group = vd ? vd.group : "";
    return {
      ...a,
      group,
      include: !!a.include,
      weight: Number(a.weight)||0,
      problemPct: vd ? vd.rawPct : 0
    };
  });

  // denom within each problem for included rows
  const byProb = new Map();
  for (const r of rows) {
    if (!byProb.has(r.problem)) byProb.set(r.problem, []);
    byProb.get(r.problem).push(r);
  }

  for (const [p, arr] of byProb.entries()) {
    const inc = arr.filter(x=>x.include);
    const denomW = sum(inc.map(x=>x.weight)) || 1;
    const pPct = (vdByProblem.get(p)?.rawPct) ?? 0;

    for (const x of arr) {
      x.rawPct = x.include ? (pPct * (x.weight/denomW)) : 0;
      x.exactQ = x.rawPct * totalQ;
      x.exactDraft = x.exactQ * 2;
    }
  }

  // apportion integer questions across ALL included CLO rows so total matches totalQ
  const included = rows.filter(x=>x.include);
  const alloc = apportionIntegers(included, totalQ, it => it.exactQ);
  for (let i=0;i<included.length;i++) included[i].qInt = alloc.allocated[i];
  for (const r of rows) if (!r.include) r.qInt = 0;

  // draft = 2x (như excel I*2); giữ integer theo qInt*2
  for (const r of rows) r.draftInt = r.qInt * 2;

  return rows;
}

/* =========================================================
   3) UI RENDER
   ========================================================= */
const el = (id) => document.getElementById(id);

function pctFmt(x) { return (x*100).toFixed(2) + "%"; }
function numFmt(x) { return (Number(x)||0).toLocaleString("vi-VN"); }

function unique(arr) { return [...new Set(arr)].filter(Boolean); }

function renderAll() {
  // sync meta
  el("inpTotalQ").value = APP.meta.totalQuestions;
  el("inpDuration").value = APP.meta.durationMinutes;
  el("inpExam").value = APP.meta.examName;

  // bloom default
  el("bNho").value = APP.bloomDefault.nho;
  el("bHieu").value = APP.bloomDefault.hieu;
  el("bVD").value = APP.bloomDefault.vd;
  el("bPT").value = APP.bloomDefault.pt;
  el("bDG").value = APP.bloomDefault.dg;
  el("bST").value = APP.bloomDefault.st;
  el("chkLockBloom").checked = !!APP.lockBloom;

  el("chkLockMinMaxGroup").checked = !!APP.lockMinMaxGroup;
  el("chkLockMinMaxVDLS").checked = !!APP.lockMinMaxVDLS;

  const groupRows = computeGroupPercents();
  const vdCalc = computeVDLS(groupRows);
  const cloRows = computeCLO(vdCalc);

  // Groups table
  const tbG = el("tblGroups");
  tbG.innerHTML = "";
  for (const g of groupRows) {
    const qExact = g.pct * (Number(APP.meta.totalQuestions)||120);
    const tr = document.createElement("tr");
    tr.className = "border-t border-slate-100";
    tr.innerHTML = `
      <td class="py-2 pr-2 font-semibold">${g.name}</td>
      <td class="py-2 pr-2">${numFmt(g.credits)}</td>
      <td class="py-2 pr-2">${numFmt(g.coef)}</td>
      <td class="py-2 pr-2 font-bold">${pctFmt(g.pct)}</td>
      <td class="py-2 pr-2">${qExact.toFixed(2)}</td>
    `;
    tbG.appendChild(tr);
  }
  el("sumGroupPct").textContent = pctFmt(sum(groupRows.map(x=>x.pct)));
  el("sumGroupQ").textContent = numFmt(APP.meta.totalQuestions);

  // Filters
  const groups = unique(APP.groups.map(x=>x.name));
  const fg = el("filterGroupVDLS");
  fg.innerHTML = `<option value="all">Tất cả phân môn</option>` + groups.map(g=>`<option value="${escapeHtml(g)}">${escapeHtml(g)}</option>`).join("");

  const fg2 = el("filterGroupCLO");
  fg2.innerHTML = `<option value="all">Tất cả phân môn</option>` + groups.map(g=>`<option value="${escapeHtml(g)}">${escapeHtml(g)}</option>`).join("");

  const problems = unique(APP.vdls.map(x=>x.problem));
  const fp = el("filterProblemCLO");
  fp.innerHTML = `<option value="all">Tất cả vấn đề</option>` + problems.map(p=>`<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join("");

  const clos = unique((APP.allocations||[]).map(x=>x.clo));
  const fc = el("filterCLO");
  fc.innerHTML = `<option value="all">Tất cả CLO</option>` + clos.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");

  const blooms = unique((APP.allocations||[]).map(x=>x.bloom));
  const fb = el("filterBloom");
  fb.innerHTML = `<option value="all">Tất cả Bloom</option>` + blooms.map(b=>`<option value="${escapeHtml(b)}">${escapeHtml(b)}</option>`).join("");

  // VDLS table render (with filter/search)
  renderVDLS(vdCalc);

  // CLO render (with filter/search)
  renderCLO(cloRows);

  // store computed results for exports
  APP._computed = { groupRows, vdCalc, cloRows };
}

function escapeHtml(s) {
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;")
                  .replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

function renderVDLS(vdCalc) {
  const groupSel = el("filterGroupVDLS").value;
  const q = (el("searchVDLS").value||"").toLowerCase().trim();

  const filtered = vdCalc.filter(x=>{
    const okGroup = (groupSel==="all" || x.group===groupSel);
    const okSearch = (!q || x.problem.toLowerCase().includes(q));
    return okGroup && okSearch;
  });

  const tb = el("tblVDLS");
  tb.innerHTML = "";
  for (const v of filtered) {
    const tr = document.createElement("tr");
    tr.className = "border-t border-slate-100";
    tr.innerHTML = `
      <td class="py-2 pr-2">
        <input type="checkbox" ${v.include?"checked":""}
          data-vdls="${escapeHtml(v.problem)}"
          class="w-4 h-4" />
      </td>
      <td class="py-2 pr-2 font-semibold">${escapeHtml(v.problem)}</td>
      <td class="py-2 pr-2">${escapeHtml(v.group)}</td>
      <td class="py-2 pr-2">
        <input type="number" step="0.1" min="0" value="${v.weight}"
          data-w="${escapeHtml(v.problem)}" class="input text-sm w-[90px]" />
      </td>
      <td class="py-2 pr-2 font-bold">${pctFmt(v.rawPct)}</td>
      <td class="py-2 pr-2">
        <input type="number" min="0" value="${v.min??""}"
          data-min="${escapeHtml(v.problem)}" class="input text-sm w-[80px]" />
      </td>
      <td class="py-2 pr-2">
        <input type="number" min="0" value="${v.max??""}"
          data-max="${escapeHtml(v.problem)}" class="input text-sm w-[80px]" />
      </td>
      <td class="py-2 pr-2 font-extrabold">${numFmt(v.qInt)}</td>
    `;
    tb.appendChild(tr);
  }

  // summary
  el("vdlsCount").textContent = numFmt(filtered.length);
  const pctSum = sum(filtered.map(x=>x.rawPct));
  const qSum = sum(filtered.map(x=>x.qInt));
  el("vdlsPct").textContent = pctFmt(pctSum);
  el("vdlsQ").textContent = numFmt(qSum);

  // events
  tb.querySelectorAll("input[type=checkbox][data-vdls]").forEach(chk=>{
    chk.addEventListener("change", (e)=>{
      const prob = e.target.getAttribute("data-vdls");
      const item = APP.vdls.find(x=>x.problem===prob);
      if (item) item.include = e.target.checked;

      // keep allocations include synced by problem
      for (const a of APP.allocations) if (a.problem===prob) a.include = e.target.checked;

      renderAll();
    });
  });

  tb.querySelectorAll("input[data-w]").forEach(inp=>{
    inp.addEventListener("input", (e)=>{
      const prob = e.target.getAttribute("data-w");
      const item = APP.vdls.find(x=>x.problem===prob);
      if (item) item.weight = Number(e.target.value)||0;
      renderAll();
    });
  });

  tb.querySelectorAll("input[data-min]").forEach(inp=>{
    inp.addEventListener("input", (e)=>{
      const prob = e.target.getAttribute("data-min");
      const item = APP.vdls.find(x=>x.problem===prob);
      if (item) item.min = (e.target.value===""? null : Number(e.target.value));
      renderAll();
    });
  });

  tb.querySelectorAll("input[data-max]").forEach(inp=>{
    inp.addEventListener("input", (e)=>{
      const prob = e.target.getAttribute("data-max");
      const item = APP.vdls.find(x=>x.problem===prob);
      if (item) item.max = (e.target.value===""? null : Number(e.target.value));
      renderAll();
    });
  });
}

function renderCLO(cloRows) {
  const gSel = el("filterGroupCLO").value;
  const pSel = el("filterProblemCLO").value;
  const cloSel = el("filterCLO").value;
  const bSel = el("filterBloom").value;
  const incSel = el("filterInclude").value;
  const q = (el("searchCLO").value||"").toLowerCase().trim();

  const filtered = cloRows.filter(r=>{
    const okG = (gSel==="all" || r.group===gSel);
    const okP = (pSel==="all" || r.problem===pSel);
    const okC = (cloSel==="all" || r.clo===cloSel);
    const okB = (bSel==="all" || r.bloom===bSel);
    const okI = (incSel==="all" || (incSel==="yes" ? r.include : !r.include));
    const okS = (!q || (r.problem||"").toLowerCase().includes(q) || (r.clo||"").toLowerCase().includes(q) || (r.bloom||"").toLowerCase().includes(q));
    return okG && okP && okC && okB && okI && okS;
  });

  const tb = el("tblCLO");
  tb.innerHTML = "";
  for (const r of filtered) {
    const tr = document.createElement("tr");
    tr.className = "border-t border-slate-100";
    tr.innerHTML = `
      <td class="py-2 pr-2"><input type="checkbox" ${r.include?"checked":""} data-inc-row="1"
        data-key="${escapeHtml(r.problem)}|||${escapeHtml(r.clo)}|||${escapeHtml(r.bloom)}" class="w-4 h-4"/></td>
      <td class="py-2 pr-2 font-semibold">${escapeHtml(r.problem)}</td>
      <td class="py-2 pr-2">${escapeHtml(r.group||"")}</td>
      <td class="py-2 pr-2">${escapeHtml(r.clo)}</td>
      <td class="py-2 pr-2">${escapeHtml(r.bloom)}</td>
      <td class="py-2 pr-2">
        <input type="number" step="0.1" min="0" value="${r.weight}"
          data-w-row="1" data-key="${escapeHtml(r.problem)}|||${escapeHtml(r.clo)}|||${escapeHtml(r.bloom)}"
          class="input text-sm w-[110px]" />
      </td>
      <td class="py-2 pr-2 font-bold">${pctFmt(r.rawPct||0)}</td>
      <td class="py-2 pr-2 font-extrabold">${numFmt(r.qInt||0)}</td>
      <td class="py-2 pr-2 font-extrabold">${numFmt(r.draftInt||0)}</td>
    `;
    tb.appendChild(tr);
  }

  // summary
  el("cloRows").textContent = numFmt(filtered.length);
  el("cloPct").textContent = pctFmt(sum(filtered.map(x=>x.rawPct||0)));
  el("cloQ").textContent = numFmt(sum(filtered.map(x=>x.qInt||0)));
  el("cloDraft").textContent = numFmt(sum(filtered.map(x=>x.draftInt||0)));

  // events for include/weight edits
  tb.querySelectorAll("input[data-inc-row]").forEach(chk=>{
    chk.addEventListener("change", (e)=>{
      const key = e.target.getAttribute("data-key");
      const [problem, clo, bloom] = key.split("|||");
      const row = APP.allocations.find(x=>x.problem===problem && x.clo===clo && x.bloom===bloom);
      if (row) row.include = e.target.checked;
      renderAll();
    });
  });

  tb.querySelectorAll("input[data-w-row]").forEach(inp=>{
    inp.addEventListener("input", (e)=>{
      const key = e.target.getAttribute("data-key");
      const [problem, clo, bloom] = key.split("|||");
      const row = APP.allocations.find(x=>x.problem===problem && x.clo===clo && x.bloom===bloom);
      if (row) row.weight = Number(e.target.value)||0;
      renderAll();
    });
  });
}

/* =========================================================
   4) TAB + EVENTS
   ========================================================= */
function setTab(which) {
  const over = el("pageOverview");
  const det = el("pageDetail");
  const t1 = el("tabOverview");
  const t2 = el("tabDetail");

  if (which==="overview") {
    over.classList.remove("hidden");
    det.classList.add("hidden");
    t1.classList.add("tabActive"); t1.classList.remove("tabIdle");
    t2.classList.add("tabIdle"); t2.classList.remove("tabActive");
  } else {
    over.classList.add("hidden");
    det.classList.remove("hidden");
    t2.classList.add("tabActive"); t2.classList.remove("tabIdle");
    t1.classList.add("tabIdle"); t1.classList.remove("tabActive");
  }
}

function validateBloom() {
  const b = APP.bloomDefault;
  const total = (Number(b.nho)||0)+(Number(b.hieu)||0)+(Number(b.vd)||0)+(Number(b.pt)||0)+(Number(b.dg)||0)+(Number(b.st)||0);
  const warn = el("bloomWarn");
  if (total !== 100) warn.classList.remove("hidden");
  else warn.classList.add("hidden");
  return total===100;
}

function applyBloomToAllocations() {
  // Chỉ áp dụng nếu lockBloom bật: set trọng số theo bloom default cho các dòng hiện có
  if (!APP.lockBloom) return;

  const b = APP.bloomDefault;
  const map = {
    "Nhớ": b.nho, "Hiểu": b.hieu, "Vận dụng": b.vd,
    "Phân tích": b.pt, "Đánh giá": b.dg, "Sáng tạo": b.st
  };

  for (const a of APP.allocations) {
    if (map[a.bloom] != null) a.weight = Number(map[a.bloom]) || 0;
  }
}

function exportJSON() {
  const payload = {
    meta: APP.meta,
    bloomDefault: APP.bloomDefault,
    lockBloom: APP.lockBloom,
    lockMinMaxGroup: APP.lockMinMaxGroup,
    lockMinMaxVDLS: APP.lockMinMaxVDLS,
    groups: APP.groups,
    vdls: APP.vdls,
    allocations: APP.allocations,
    computed: APP._computed
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "blueprint_mcq_vdls_clo_bloom.json";
  a.click();
  URL.revokeObjectURL(url);
}

function exportExcel() {
  // Create workbook with sheets tương tự Excel: Phan nhom, VDLS, CLO
  const wb = XLSX.utils.book_new();

  // Phan nhom sheet
  const gRows = (APP._computed?.groupRows || computeGroupPercents()).map(r=>({
    "Phân môn": r.name,
    "Tín chỉ": r.credits,
    "Hệ số": r.coef,
    "% phân môn": Number((r.pct*100).toFixed(4)),
    "Câu (ước tính)": Number((r.pct*(APP.meta.totalQuestions||120)).toFixed(2))
  }));
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(gRows), "Phan nhom");

  // VDLS sheet
  const vdRows = (APP._computed?.vdCalc || []).map(v=>({
    "Vấn đề": v.problem,
    "Phân môn": v.group,
    "Có": v.include ? "Có":"Không",
    "Tỷ trọng": v.weight,
    "% thô": Number((v.rawPct*100).toFixed(4)),
    "Min": v.min ?? "",
    "Max": v.max ?? "",
    "Câu": v.qInt ?? 0
  }));
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(vdRows), "VDLS");

  // CLO sheet
  const cloRows = (APP._computed?.cloRows || []).map(r=>({
    "Vấn đề (VD phụ)": r.problem,
    "Phân môn": r.group,
    "Có": r.include ? "Có":"Không",
    "CLO": r.clo,
    "Bloom": r.bloom,
    "Tỷ trọng": r.weight,
    "% thô": Number(((r.rawPct||0)*100).toFixed(4)),
    "Câu": r.qInt ?? 0,
    "Câu soạn": r.draftInt ?? 0
  }));
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(cloRows), "CLO");

  XLSX.writeFile(wb, "Blueprint_MCQString_VDLS_CLO_Bloom.xlsx");
}

/* =========================================================
   5) INIT + WIRING
   ========================================================= */
function wire() {
  el("tabOverview").addEventListener("click", ()=>setTab("overview"));
  el("tabDetail").addEventListener("click", ()=>setTab("detail"));

  // Meta inputs
  el("inpTotalQ").addEventListener("input", (e)=>{ APP.meta.totalQuestions = Number(e.target.value)||120; renderAll(); });
  el("inpDuration").addEventListener("input", (e)=>{ APP.meta.durationMinutes = Number(e.target.value)||90; });
  el("inpExam").addEventListener("input", (e)=>{ APP.meta.examName = e.target.value||""; });

  // Bloom
  el("chkLockBloom").addEventListener("change", (e)=>{ APP.lockBloom = e.target.checked; applyBloomToAllocations(); renderAll(); });
  ["bNho","bHieu","bVD","bPT","bDG","bST"].forEach(id=>{
    el(id).addEventListener("input", ()=>{
      APP.bloomDefault = {
        nho:Number(el("bNho").value)||0,
        hieu:Number(el("bHieu").value)||0,
        vd:Number(el("bVD").value)||0,
        pt:Number(el("bPT").value)||0,
        dg:Number(el("bDG").value)||0,
        st:Number(el("bST").value)||0
      };
      validateBloom();
    });
  });
  el("btnApplyBloom").addEventListener("click", ()=>{
    APP.bloomDefault = {
      nho:Number(el("bNho").value)||0,
      hieu:Number(el("bHieu").value)||0,
      vd:Number(el("bVD").value)||0,
      pt:Number(el("bPT").value)||0,
      dg:Number(el("bDG").value)||0,
      st:Number(el("bST").value)||0
    };
    if (!validateBloom()) return;
    applyBloomToAllocations();
    renderAll();
  });

  // Min/Max
  el("chkLockMinMaxGroup").addEventListener("change", (e)=>{ APP.lockMinMaxGroup = e.target.checked; renderAll(); });
  el("chkLockMinMaxVDLS").addEventListener("change", (e)=>{ APP.lockMinMaxVDLS = e.target.checked; renderAll(); });

  // VDLS filter/search
  el("filterGroupVDLS").addEventListener("change", ()=>renderVDLS(APP._computed?.vdCalc||[]));
  el("searchVDLS").addEventListener("input", ()=>renderVDLS(APP._computed?.vdCalc||[]));

  // CLO filter/search
  ["filterGroupCLO","filterProblemCLO","filterCLO","filterBloom","filterInclude","searchCLO"].forEach(id=>{
    el(id).addEventListener("change", ()=>renderCLO(APP._computed?.cloRows||[]));
    if (id==="searchCLO") el(id).addEventListener("input", ()=>renderCLO(APP._computed?.cloRows||[]));
  });

  // Export
  el("btnExportJson").addEventListener("click", exportJSON);
  el("btnExportExcel").addEventListener("click", exportExcel);
}

ensureAllocations();
wire();
validateBloom();
renderAll();
</script>
</body>
</html>
