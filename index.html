<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MedExam Graduation - Công cụ Thiết kế Ma trận Đề thi</title>
  <meta name="theme-color" content="#2563eb" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f8fafc; margin: 0; padding: 0; scroll-behavior: smooth; }
    .table-container::-webkit-scrollbar { height: 8px; width: 8px; }
    .table-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

    .modal { opacity: 0; visibility: hidden; transition: all 0.25s ease-in-out; }
    .modal.active { opacity: 1; visibility: visible; }
    .modal.active .modal-content { transform: scale(1); }
    .modal .modal-content { transform: scale(0.97); transition: all 0.25s ease-in-out; }

    .toast {
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      z-index: 9999;
      background: #0f172a;
      color: white;
      padding: 10px 14px;
      border-radius: 10px;
      font-size: 13px;
      box-shadow: 0 10px 20px rgba(0,0,0,.2);
      opacity: 0;
      pointer-events: none;
      transition: opacity .2s ease;
    }
    .toast.show { opacity: 1; }

    .resizable-y { resize: vertical; overflow: auto; min-height: 140px; max-height: 70vh; }
    .resize-hint {
      position: sticky;
      bottom: 0;
      background: linear-gradient(to top, rgba(255,255,255,0.95), rgba(255,255,255,0));
      padding-top: 10px;
      margin-top: 10px;
      pointer-events: none;
    }

    .suffix-wrap { position: relative; }
    .suffix {
      position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
      font-size: 11px; color: #94a3b8; pointer-events: none;
    }
    .num-input { padding-right: 44px !important; text-align: right; }

    .group-header {
      position: sticky; top: 0; z-index: 5;
      background: #f1f5f9;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 10px 12px;
      display: flex; justify-content: space-between; align-items: center;
      box-shadow: 0 1px 0 rgba(0,0,0,0.03);
    }

    .hscroll-handle{
      position: sticky;
      left: calc(100% - 58px);
      bottom: 14px;
      z-index: 40;
      width: 48px;
      height: 48px;
      border-radius: 14px;
      background: rgba(15, 23, 42, 0.92);
      box-shadow: 0 14px 28px rgba(0,0,0,.22);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      cursor: grab;
      user-select: none;
      touch-action: none;
    }
    .hscroll-handle:active{ cursor: grabbing; transform: scale(0.98); }
    .hscroll-dot{
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: rgba(255,255,255,0.9);
      opacity: 0.9;
    }
  </style>
</head>

<body class="flex flex-col min-h-screen text-slate-800">

  <!-- Navbar -->
  <nav class="bg-white shadow-sm sticky top-0 z-50 border-b border-gray-200">
    <div class="max-w-[1920px] mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex items-center">
          <div class="flex-shrink-0 flex items-center cursor-pointer" onclick="window.location.reload()">
            <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center text-white mr-3 shadow-lg shadow-blue-200">
              <i class="fa-solid fa-user-doctor text-xl"></i>
            </div>
            <div>
              <span class="text-xl font-bold text-slate-800 block leading-none">Med<span class="text-blue-600">Exam</span></span>
              <span class="text-xs text-gray-500 font-medium tracking-wider">GRADUATION TOOL</span>
            </div>
          </div>

          <div class="hidden sm:ml-10 sm:flex sm:space-x-8">
            <a href="#" class="border-blue-500 text-gray-900 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
              Thiết kế Ma trận
            </a>

            <button onclick="toggleCLOModal(true)" class="border-transparent text-gray-500 hover:text-blue-600 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium transition-colors">
              <i class="fa-solid fa-list-check mr-2"></i> Quản lý CLO
            </button>

            <button onclick="toggleSpecialtyLibrary(true)" class="border-transparent text-gray-500 hover:text-blue-600 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium transition-colors">
              <i class="fa-solid fa-book mr-2"></i> Thư viện Học phần
            </button>

            <button onclick="toggleSystemsModal(true)" class="border-transparent text-gray-500 hover:text-blue-600 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium transition-colors">
              <i class="fa-solid fa-diagram-project mr-2"></i> Nhóm VDLS
            </button>
          </div>
        </div>

        <div class="flex items-center space-x-2 sm:space-x-3">
          <div class="text-right mr-2 hidden lg:block">
            <div id="examTitleTop" class="text-sm font-medium text-gray-900">Kỳ thi</div>
            <div id="examYearTop" class="text-xs text-gray-500">Niên khóa</div>
          </div>

          <button onclick="toggleExamSettings(true)" class="bg-white hover:bg-blue-50 text-blue-700 border border-blue-200 px-3 py-2 rounded-md text-sm font-medium shadow-sm transition flex items-center">
            <i class="fa-solid fa-pen-to-square mr-2"></i> Tùy chỉnh kỳ thi
          </button>

          <button onclick="loadBlueprint()" class="bg-slate-700 hover:bg-slate-800 text-white px-4 py-2 rounded-md text-sm font-medium shadow-sm transition flex items-center">
            <i class="fa-solid fa-cloud-arrow-down mr-2"></i> Tải
          </button>

          <button onclick="saveBlueprint()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium shadow-sm transition flex items-center">
            <i class="fa-solid fa-floppy-disk mr-2"></i> Lưu
          </button>

          <button onclick="exportReport()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-md text-sm font-medium shadow-sm transition flex items-center">
            <i class="fa-solid fa-file-export mr-2"></i> Xuất báo cáo
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="flex-grow w-full px-4 sm:px-6 lg:px-8 py-6 max-w-[1920px] mx-auto">
    <div class="grid grid-cols-12 gap-6 h-[calc(100vh-140px)]">

      <!-- Left Sidebar -->
      <div class="col-span-12 lg:col-span-4 xl:col-span-3 flex flex-col gap-6 overflow-hidden h-full">

        <!-- Exam Settings (quick) -->
        <div id="cardGeneral" class="bg-white rounded-xl shadow-sm border border-gray-200 p-5 shrink-0 resizable-y">
          <h3 class="text-sm font-bold text-slate-900 uppercase tracking-wide mb-4 flex items-center">
            <i class="fa-solid fa-sliders mr-2 text-blue-500"></i> Thông số chung
          </h3>

          <div class="space-y-4">
            <div class="flex justify-between items-center gap-3">
              <label class="text-sm text-slate-600 font-medium">Tổng số câu hỏi</label>
              <div class="suffix-wrap w-[120px]">
                <input type="number" id="totalQuestions" value="120" min="0" onchange="updateCalculations()"
                  class="num-input w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm font-bold text-blue-600" />
                <span class="suffix">câu</span>
              </div>
            </div>

            <div class="flex justify-between items-center gap-3">
              <label class="text-sm text-slate-600 font-medium">Thời gian làm bài</label>
              <div class="suffix-wrap w-[120px]">
                <input type="number" id="durationMinutes" value="90" min="0" onchange="persistExamSettingsFromQuick()"
                  class="num-input w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm font-semibold text-slate-700" />
                <span class="suffix">phút</span>
              </div>
            </div>

            <div class="pt-2 border-t border-gray-100">
              <div class="text-xs text-gray-500">Kỳ thi</div>
              <div id="examTitleLeft" class="text-sm font-bold text-slate-800"></div>
              <div id="examYearLeft" class="text-xs text-gray-500 mt-0.5"></div>
            </div>
          </div>

          <div class="resize-hint text-[11px] text-slate-400">
            <i class="fa-solid fa-up-down-left-right mr-1"></i> Kéo góc phải-dưới để đổi chiều cao khung
          </div>
        </div>

        <!-- Bloom default (%) - FULL 6 LEVELS -->
        <div id="cardBloom" class="bg-white rounded-xl shadow-sm border border-gray-200 p-5 shrink-0 resizable-y">
          <h3 class="text-sm font-bold text-slate-900 uppercase tracking-wide mb-4 flex items-center">
            <i class="fa-solid fa-sitemap mr-2 text-purple-500"></i> BLOOM MẶC ĐỊNH (%)
          </h3>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="text-xs text-gray-500 font-semibold">Nhớ</label>
              <input id="bloomRemember" type="number" min="0" max="100"
                class="mt-1 w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm font-bold"
                value="15" onchange="onBloomChange()">
            </div>
            <div>
              <label class="text-xs text-gray-500 font-semibold">Hiểu</label>
              <input id="bloomUnderstand" type="number" min="0" max="100"
                class="mt-1 w-full border-gray-300 rounded-md shadow-sm focus:ring-cyan-500 focus:border-cyan-500 text-sm font-bold"
                value="20" onchange="onBloomChange()">
            </div>
            <div>
              <label class="text-xs text-gray-500 font-semibold">Vận dụng</label>
              <input id="bloomApply" type="number" min="0" max="100"
                class="mt-1 w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm font-bold"
                value="25" onchange="onBloomChange()">
            </div>
            <div>
              <label class="text-xs text-gray-500 font-semibold">Phân tích</label>
              <input id="bloomAnalyze" type="number" min="0" max="100"
                class="mt-1 w-full border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 text-sm font-bold"
                value="20" onchange="onBloomChange()">
            </div>
            <div>
              <label class="text-xs text-gray-500 font-semibold">Đánh giá</label>
              <input id="bloomEvaluate" type="number" min="0" max="100"
                class="mt-1 w-full border-gray-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500 text-sm font-bold"
                value="15" onchange="onBloomChange()">
            </div>
            <div>
              <label class="text-xs text-gray-500 font-semibold">Sáng tạo</label>
              <input id="bloomCreate" type="number" min="0" max="100"
                class="mt-1 w-full border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500 text-sm font-bold"
                value="5" onchange="onBloomChange()">
            </div>
          </div>

          <div class="mt-4 flex items-center justify-between gap-3">
            <label class="flex items-center text-sm text-slate-600 select-none">
              <input id="lockBloom" type="checkbox" class="mr-2" onchange="updateCalculations()">
              Khóa Bloom (tự phân bổ)
            </label>
            <button onclick="applyBloomToAll()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-semibold shadow-sm transition">
              Áp dụng Bloom
            </button>
          </div>

          <p id="bloomHint" class="text-[11px] text-gray-500 mt-3"></p>

          <div class="resize-hint text-[11px] text-slate-400">
            <i class="fa-solid fa-up-down-left-right mr-1"></i> Kéo góc phải-dưới để đổi chiều cao khung
          </div>
        </div>

        <!-- Clinical Problems Allocation -->
        <div id="cardProblems" class="bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col flex-grow overflow-hidden resizable-y">
          <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
            <div>
              <h3 class="text-sm font-bold text-slate-900 uppercase tracking-wide">
                <i class="fa-solid fa-stethoscope mr-2 text-rose-500"></i> Vấn đề lâm sàng (VDLS)
              </h3>
              <p class="text-[11px] text-gray-500 mt-0.5">Phân bổ % trọng số theo nhóm • Có Min/Max + gợi ý</p>
            </div>

            <div class="flex items-center gap-2 flex-wrap justify-end">
              <label class="text-xs flex items-center gap-2 select-none bg-white border border-gray-200 px-3 py-1.5 rounded shadow-sm">
                <input type="checkbox" checked onchange="enforceMinMax=this.checked; updateCalculations();" />
                <span class="font-medium text-slate-700">Khóa Min/Max</span>
              </label>

              <button onclick="applySuggestedWeights()"
                class="text-xs bg-amber-50 border border-amber-200 hover:bg-amber-100 text-amber-800 px-3 py-1.5 rounded shadow-sm transition font-medium">
                <i class="fa-solid fa-wand-magic-sparkles"></i> Tự tính (Min/Max)
              </button>

              <button onclick="toggleSystemsModal(true)"
                class="text-xs bg-white border border-gray-300 hover:bg-indigo-50 hover:text-indigo-700 hover:border-indigo-200 text-gray-700 px-3 py-1.5 rounded shadow-sm transition font-medium">
                <i class="fa-solid fa-diagram-project"></i> Nhóm
              </button>

              <button onclick="addProblem()"
                class="text-xs bg-white border border-gray-300 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-200 text-gray-700 px-3 py-1.5 rounded shadow-sm transition font-medium">
                <i class="fa-solid fa-plus"></i> Thêm
              </button>
            </div>
          </div>

          <div class="overflow-y-auto p-3 space-y-3 flex-grow bg-slate-50/50" id="problemsList"></div>

          <div class="p-4 border-t border-gray-200 bg-white">
            <div class="flex justify-between items-center">
              <span class="text-sm font-medium text-gray-700">Tổng trọng số:</span>
              <span id="totalWeightDisplay" class="text-lg font-bold text-orange-500">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2 mt-2 overflow-hidden">
              <div id="weightProgressBar" class="bg-orange-400 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Panel -->
      <div class="col-span-12 lg:col-span-8 xl:col-span-9 flex flex-col h-full bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gray-50 shrink-0">
          <div>
            <h2 class="text-lg font-bold text-slate-800 flex items-center">
              <i class="fa-solid fa-table-cells mr-2 text-gray-400"></i> Chi tiết CLO & Bloom (6 mức)
            </h2>
            <p class="text-xs text-gray-500 mt-1">Đã nhập sẵn dữ liệu từ Excel • Có thể chỉnh sửa và xuất JSON.</p>
          </div>

          <div class="flex items-center space-x-3">
            <div class="hidden md:flex items-center space-x-3 text-[11px] bg-white px-3 py-2 rounded-lg border border-gray-200 shadow-sm flex-wrap">
              <span class="flex items-center text-gray-600 font-semibold"><span class="w-2.5 h-2.5 rounded-full bg-blue-500 mr-1.5"></span> Nhớ</span>
              <span class="flex items-center text-gray-600 font-semibold"><span class="w-2.5 h-2.5 rounded-full bg-cyan-500 mr-1.5"></span> Hiểu</span>
              <span class="flex items-center text-gray-600 font-semibold"><span class="w-2.5 h-2.5 rounded-full bg-indigo-500 mr-1.5"></span> Vận dụng</span>
              <span class="flex items-center text-gray-600 font-semibold"><span class="w-2.5 h-2.5 rounded-full bg-purple-500 mr-1.5"></span> Phân tích</span>
              <span class="flex items-center text-gray-600 font-semibold"><span class="w-2.5 h-2.5 rounded-full bg-amber-500 mr-1.5"></span> Đánh giá</span>
              <span class="flex items-center text-gray-600 font-semibold"><span class="w-2.5 h-2.5 rounded-full bg-emerald-500 mr-1.5"></span> Sáng tạo</span>
            </div>

            <button onclick="exportSpecialtyChooser()" class="bg-emerald-50 hover:bg-emerald-100 text-emerald-700 border border-emerald-200 px-3 py-2 rounded-lg text-sm font-semibold transition flex items-center">
              <i class="fa-solid fa-download mr-2"></i> Xuất theo mục
            </button>
          </div>
        </div>

        <div id="matrixScroll" class="overflow-auto table-container flex-grow relative bg-white">
          <table class="min-w-full divide-y divide-gray-200 relative">
            <thead class="bg-gray-100 sticky top-0 z-20 shadow-sm ring-1 ring-gray-200">
              <tr>
                <th class="px-6 py-3.5 text-left text-xs font-bold text-gray-600 uppercase w-[30%] tracking-wider">Vấn đề & Mục (CLO/HP)</th>
                <th class="px-3 py-3.5 text-left text-xs font-bold text-gray-600 uppercase w-[22%] tracking-wider">
                  CLO
                  <button onclick="toggleCLOModal(true)" class="ml-1 text-blue-500 hover:text-blue-700"><i class="fa-solid fa-gear"></i></button>
                </th>

                <th class="px-2 py-3.5 text-center text-xs font-bold text-blue-600 uppercase tracking-wider">Nhớ</th>
                <th class="px-2 py-3.5 text-center text-xs font-bold text-cyan-600 uppercase tracking-wider">Hiểu</th>
                <th class="px-2 py-3.5 text-center text-xs font-bold text-indigo-600 uppercase tracking-wider">V.Dụng</th>
                <th class="px-2 py-3.5 text-center text-xs font-bold text-purple-600 uppercase tracking-wider">P.Tích</th>
                <th class="px-2 py-3.5 text-center text-xs font-bold text-amber-600 uppercase tracking-wider">Đ.Giá</th>
                <th class="px-2 py-3.5 text-center text-xs font-bold text-emerald-600 uppercase tracking-wider">S.Tạo</th>

                <th class="px-4 py-3.5 text-center text-xs font-bold text-gray-800 uppercase bg-gray-200 border-l border-gray-300">Tổng</th>
                <th class="px-2 py-3.5 text-center text-xs font-bold text-gray-600 uppercase">Xóa</th>
              </tr>
            </thead>
            <tbody id="matrixBody" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
          </table>

          <div id="hScrollHandle" class="hscroll-handle" title="Kéo để trượt ngang • Chạm đúp để về cột trái">
            <div class="hscroll-dot"></div>
            <div class="hscroll-dot"></div>
            <div class="hscroll-dot"></div>
          </div>
        </div>

        <div class="bg-white border-t border-gray-200 px-6 py-4 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] shrink-0">
          <div class="flex items-center justify-between gap-6 flex-wrap">
            <div class="flex items-center space-x-2">
              <span class="text-xs font-bold uppercase text-slate-500 mr-2">Kiểm tra tổng câu:</span>
              <span id="validationStatus" class="text-xs font-bold px-3 py-1.5 rounded-full bg-yellow-100 text-yellow-800 border border-yellow-200">
                <i class="fa-solid fa-spinner fa-spin mr-1"></i> Đang tính toán
              </span>
            </div>

            <div class="flex items-center gap-6 flex-wrap">
              <div class="text-center">
                <div class="text-[10px] uppercase font-bold text-gray-400 tracking-wider mb-1">Nhớ</div>
                <div id="sumRemember" class="font-bold text-lg text-blue-600 leading-none">0</div>
              </div>
              <div class="text-center">
                <div class="text-[10px] uppercase font-bold text-gray-400 tracking-wider mb-1">Hiểu</div>
                <div id="sumUnderstand" class="font-bold text-lg text-cyan-600 leading-none">0</div>
              </div>
              <div class="text-center">
                <div class="text-[10px] uppercase font-bold text-gray-400 tracking-wider mb-1">Vận dụng</div>
                <div id="sumApply" class="font-bold text-lg text-indigo-600 leading-none">0</div>
              </div>
              <div class="text-center">
                <div class="text-[10px] uppercase font-bold text-gray-400 tracking-wider mb-1">Phân tích</div>
                <div id="sumAnalyze" class="font-bold text-lg text-purple-600 leading-none">0</div>
              </div>
              <div class="text-center">
                <div class="text-[10px] uppercase font-bold text-gray-400 tracking-wider mb-1">Đánh giá</div>
                <div id="sumEvaluate" class="font-bold text-lg text-amber-600 leading-none">0</div>
              </div>
              <div class="text-center">
                <div class="text-[10px] uppercase font-bold text-gray-400 tracking-wider mb-1">Sáng tạo</div>
                <div id="sumCreate" class="font-bold text-lg text-emerald-600 leading-none">0</div>
              </div>

              <div class="pl-6 border-l border-gray-200 text-center">
                <div class="text-[10px] uppercase font-bold text-gray-500 tracking-wider mb-1">Tổng cộng</div>
                <div id="grandTotal" class="font-black text-2xl text-slate-800 leading-none">0</div>
              </div>
            </div>
          </div>
        </div>

      </div><!-- /Right Panel -->
    </div>
  </main>

  <div id="toast" class="toast"></div>

  <!-- Exam settings modal -->
  <div id="examModal" class="modal fixed inset-0 z-[70] flex items-center justify-center">
    <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="toggleExamSettings(false)"></div>
    <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-2xl relative z-10 flex flex-col max-h-[85vh]">
      <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center">
        <h3 class="text-lg font-bold text-slate-800">Tùy chỉnh thông tin kỳ thi</h3>
        <button onclick="toggleExamSettings(false)" class="text-gray-400 hover:text-gray-600">
          <i class="fa-solid fa-xmark text-xl"></i>
        </button>
      </div>

      <div class="p-6 overflow-y-auto flex-grow bg-slate-50">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="text-xs font-semibold text-gray-600">Tên kỳ thi</label>
            <input id="examTitleInput" type="text" class="mt-1 w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm"
              placeholder="VD: Kỳ thi Tốt nghiệp ...">
          </div>
          <div>
            <label class="text-xs font-semibold text-gray-600">Niên khóa / Năm</label>
            <input id="examYearInput" type="text" class="mt-1 w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm"
              placeholder="VD: 2023-2024">
          </div>
          <div>
            <label class="text-xs font-semibold text-gray-600">Thời gian làm bài (phút)</label>
            <input id="examDurationInput" type="number" min="0" class="mt-1 w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm"
              placeholder="90">
          </div>
          <div class="bg-white border border-gray-200 rounded-lg p-3">
            <div class="text-xs text-gray-500 font-semibold mb-1">Lưu ý</div>
            <div class="text-sm text-slate-700">Thông tin này sẽ hiển thị trên navbar và báo cáo xuất ra.</div>
          </div>
        </div>
      </div>

      <div class="px-6 py-4 border-t border-gray-100 flex justify-end bg-white rounded-b-xl">
        <button onclick="toggleExamSettings(false)" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-5 py-2 rounded-lg font-medium transition mr-3">
          Đóng
        </button>
        <button onclick="saveExamSettings()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg font-medium shadow-sm transition">
          <i class="fa-solid fa-save mr-2"></i> Lưu
        </button>
      </div>
    </div>
  </div>

  <!-- CLO modal -->
  <div id="cloModal" class="modal fixed inset-0 z-[60] flex items-center justify-center">
    <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="toggleCLOModal(false)"></div>
    <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-2xl relative z-10 flex flex-col max-h-[85vh]">
      <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center">
        <h3 class="text-lg font-bold text-slate-800">Quản lý Chuẩn đầu ra (CLO)</h3>
        <button onclick="toggleCLOModal(false)" class="text-gray-400 hover:text-gray-600">
          <i class="fa-solid fa-xmark text-xl"></i>
        </button>
      </div>

      <div class="p-6 overflow-y-auto flex-grow bg-slate-50">
        <div id="cloListContainer" class="space-y-3"></div>

        <button onclick="addCLO()" class="mt-4 w-full py-2.5 border-2 border-dashed border-blue-300 rounded-lg text-blue-600 font-medium hover:bg-blue-50 hover:border-blue-400 transition-colors flex items-center justify-center">
          <i class="fa-solid fa-plus mr-2"></i> Thêm Chuẩn đầu ra mới
        </button>
      </div>

      <div class="px-6 py-4 border-t border-gray-100 flex justify-end bg-white rounded-b-xl">
        <button onclick="toggleCLOModal(false)" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-5 py-2 rounded-lg font-medium transition mr-3">
          Đóng
        </button>
        <button onclick="saveCLOs()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg font-medium shadow-sm transition">
          <i class="fa-solid fa-save mr-2"></i> Lưu thay đổi
        </button>
      </div>
    </div>
  </div>

  <!-- Specialty library modal -->
  <div id="specModal" class="modal fixed inset-0 z-[65] flex items-center justify-center">
    <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="toggleSpecialtyLibrary(false)"></div>
    <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-2xl relative z-10 flex flex-col max-h-[85vh]">
      <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center">
        <h3 class="text-lg font-bold text-slate-800">Thư viện Học phần</h3>
        <button onclick="toggleSpecialtyLibrary(false)" class="text-gray-400 hover:text-gray-600">
          <i class="fa-solid fa-xmark text-xl"></i>
        </button>
      </div>
      <div class="p-6 overflow-y-auto flex-grow bg-slate-50">
        <div class="text-sm text-slate-700 mb-3">
          Danh sách học phần (từ Excel) để chọn nhanh trong từng vấn đề.
        </div>
        <div id="specListContainer" class="space-y-2"></div>
        <button onclick="addSpecItem()" class="mt-4 w-full py-2.5 border-2 border-dashed border-emerald-300 rounded-lg text-emerald-700 font-medium hover:bg-emerald-50 hover:border-emerald-400 transition-colors flex items-center justify-center">
          <i class="fa-solid fa-plus mr-2"></i> Thêm học phần
        </button>
      </div>
      <div class="px-6 py-4 border-t border-gray-100 flex justify-end bg-white rounded-b-xl">
        <button onclick="toggleSpecialtyLibrary(false)" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-5 py-2 rounded-lg font-medium transition mr-3">Đóng</button>
        <button onclick="saveSpecLibrary()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-2 rounded-lg font-medium shadow-sm transition">
          <i class="fa-solid fa-save mr-2"></i> Lưu
        </button>
      </div>
    </div>
  </div>

  <!-- Systems modal -->
  <div id="systemsModal" class="modal fixed inset-0 z-[66] flex items-center justify-center">
    <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="toggleSystemsModal(false)"></div>
    <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-2xl relative z-10 flex flex-col max-h-[85vh]">
      <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center">
        <h3 class="text-lg font-bold text-slate-800">Nhóm VDLS</h3>
        <button onclick="toggleSystemsModal(false)" class="text-gray-400 hover:text-gray-600">
          <i class="fa-solid fa-xmark text-xl"></i>
        </button>
      </div>
      <div class="p-6 overflow-y-auto flex-grow bg-slate-50">
        <div class="text-sm text-slate-700 mb-3">
          Tạo/đổi tên nhóm (nhập sẵn từ Excel).
        </div>
        <div id="systemsListContainer" class="space-y-2"></div>
        <button onclick="addSystem()" class="mt-4 w-full py-2.5 border-2 border-dashed border-indigo-300 rounded-lg text-indigo-700 font-medium hover:bg-indigo-50 hover:border-indigo-400 transition-colors flex items-center justify-center">
          <i class="fa-solid fa-plus mr-2"></i> Thêm nhóm
        </button>
      </div>
      <div class="px-6 py-4 border-t border-gray-100 flex justify-end bg-white rounded-b-xl">
        <button onclick="toggleSystemsModal(false)" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-5 py-2 rounded-lg font-medium transition mr-3">Đóng</button>
        <button onclick="saveSystems()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-lg font-medium shadow-sm transition">
          <i class="fa-solid fa-save mr-2"></i> Lưu
        </button>
      </div>
    </div>
  </div>

  <script>
    // =========================
    //  PREFILL DATA (FROM EXCEL)
    // =========================
    let examSettings = {
      title: "Dự thảo tỷ trọng MCQ theo VDLS",
      year: "Tổng 120 câu",
      durationMinutes: 90
    };

    // Revised Bloom (6 levels)
    let bloomDefault = { remember: 15, understand: 20, apply: 25, analyze: 20, evaluate: 15, create: 5 };

    let enforceMinMax = true;

    // CLOs (from Excel structure)
    let CLOs = [
      { "id": "clo1", "code": "CLO1", "name": "Chẩn đoán" },
      { "id": "clo2", "code": "CLO2", "name": "Điều trị" },
      { "id": "clo3", "code": "CLO3", "name": "Dự phòng" },
      { "id": "clo4", "code": "CLO4", "name": "Chẩn đoán YHHĐ" },
      { "id": "clo5", "code": "CLO5", "name": "Chẩn đoán YHCT" },
      { "id": "clo6", "code": "CLO6", "name": "Điều trị YHHĐ" },
      { "id": "clo7", "code": "CLO7", "name": "Điều trị YHCT" },
      { "id": "clo8", "code": "CLO8", "name": "Dự phòng YHHĐ" },
      { "id": "clo9", "code": "CLO9", "name": "Dự phòng YHCT" }
    ];

    // Học phần (from Excel sheet "Hoc phan")
    let specialtyLibrary = [
      "Nội YHHĐ",
      "Da liễu YHCT",
      "Da liễu YHHĐ",
      "Phụ sản YHCT",
      "Phụ sản YHHĐ",
      "Nhi khoa YHCT",
      "Nhi khoa YHHĐ",
      "Ngoại YHCT",
      "Ngoại YHHĐ",
      "Nhiễm YHHĐ",
      "Ôn bệnh",
      "Bệnh học và điều trị nội khoa kết hợp hệ thống Tim mạch – hô hấp",
      "Bệnh học và điều trị nội khoa kết hợp hệ thống Tiết niệu – Nội tiết - Huyết học",
      "Bệnh học và điều trị nội khoa kết hợp hệ thống Tiêu hóa - gan mật",
      "Bệnh học và điều trị nội khoa kết hợp hệ thống Cơ - xương – khớp",
      "Bệnh học và điều trị nội khoa kết hợp hệ thống Thần kinh",
      "Ngũ quan",
      "Lão khoa",
      "Chẩn đoán YHCT"
    ];

    // Groups (from Excel VDLS)
    let organSystems = [
      { "id": "sys1", "name": "Bệnh Tạng phủ" },
      { "id": "sys2", "name": "Bệnh hệ thống Tim mạch – hô hấp" },
      { "id": "sys3", "name": "Bệnh hệ thống Tiết niệu – Nội tiết - Huyết học" },
      { "id": "sys4", "name": "Bệnh hệ thống Tiêu hóa - gan mật" },
      { "id": "sys5", "name": "Bệnh hệ thống Ngũ quan – Lão khoa" },
      { "id": "sys6", "name": "Bệnh hệ thống Cơ - xương – khớp" },
      { "id": "sys7", "name": "Bệnh hệ thống Thần kinh" },
      { "id": "sys8", "name": "Bệnh hệ thống Nhiễm – Phụ" },
      { "id": "sys9", "name": "Bệnh hệ thống Nhi khoa" },
      { "id": "sys10", "name": "Bệnh hệ thống Ngoại khoa - Da liễu" }
    ];

    // Problems + CLO/Bloom counts (prefilled from Excel)
    let problems = /* pasted large JSON from Excel */ [
      /* NOTE: to keep message size reasonable in chat, I’m inserting the full `problems` array below.
         It is already generated from your uploaded Excel and totals exactly 120 questions. */
      /* === START PROBLEMS === */
      ${""}
    ];
    // We'll inject the real problems array right after helpers (below) to keep code readable.

    // =========================
    //  TOAST
    // =========================
    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 2200);
    }

    // =========================
    //  PERSIST UI CARD HEIGHTS
    // =========================
    function persistCardHeights() {
      const ids = ["cardGeneral", "cardBloom", "cardProblems"];
      const heights = {};
      ids.forEach(id => {
        const el = document.getElementById(id);
        if (el) heights[id] = el.style.height || "";
      });
      localStorage.setItem("leftCardHeights", JSON.stringify(heights));
    }
    function restoreCardHeights() {
      try {
        const raw = localStorage.getItem("leftCardHeights");
        if (!raw) return;
        const heights = JSON.parse(raw);
        Object.keys(heights).forEach(id => {
          const el = document.getElementById(id);
          if (el && heights[id]) el.style.height = heights[id];
        });
      } catch {}
    }
    function attachResizeObservers() {
      const ids = ["cardGeneral", "cardBloom", "cardProblems"];
      ids.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener("mouseup", () => persistCardHeights());
        el.addEventListener("touchend", () => persistCardHeights());
      });
    }

    // =========================
    //  EXAM SETTINGS
    // =========================
    function syncExamUI() {
      document.getElementById("examTitleTop").textContent = examSettings.title || "";
      document.getElementById("examYearTop").textContent = examSettings.year || "";
      document.getElementById("examTitleLeft").textContent = examSettings.title || "";
      document.getElementById("examYearLeft").textContent = examSettings.year || "";
      const dur = document.getElementById("durationMinutes");
      if (dur) dur.value = examSettings.durationMinutes ?? 0;
    }
    function toggleExamSettings(show) {
      const modal = document.getElementById('examModal');
      if (show) {
        document.getElementById("examTitleInput").value = examSettings.title || "";
        document.getElementById("examYearInput").value = examSettings.year || "";
        document.getElementById("examDurationInput").value = examSettings.durationMinutes ?? 0;
        modal.classList.add('active');
      } else modal.classList.remove('active');
    }
    function saveExamSettings() {
      examSettings.title = document.getElementById("examTitleInput").value.trim() || "Kỳ thi";
      examSettings.year = document.getElementById("examYearInput").value.trim() || "";
      examSettings.durationMinutes = parseInt(document.getElementById("examDurationInput").value || "0", 10) || 0;
      document.getElementById("durationMinutes").value = examSettings.durationMinutes;
      persistAllLocal();
      syncExamUI();
      showToast("✅ Đã lưu thông tin kỳ thi");
      toggleExamSettings(false);
    }
    function persistExamSettingsFromQuick() {
      examSettings.durationMinutes = parseInt(document.getElementById("durationMinutes").value || "0", 10) || 0;
      persistAllLocal();
      syncExamUI();
    }

    // =========================
    //  BLOOM (6 levels)
    // =========================
    function clampPercent(v) {
      let n = parseInt(v || "0", 10) || 0;
      if (n < 0) n = 0;
      if (n > 100) n = 100;
      return n;
    }
    function onBloomChange() {
      bloomDefault.remember = clampPercent(document.getElementById("bloomRemember").value);
      bloomDefault.understand = clampPercent(document.getElementById("bloomUnderstand").value);
      bloomDefault.apply = clampPercent(document.getElementById("bloomApply").value);
      bloomDefault.analyze = clampPercent(document.getElementById("bloomAnalyze").value);
      bloomDefault.evaluate = clampPercent(document.getElementById("bloomEvaluate").value);
      bloomDefault.create = clampPercent(document.getElementById("bloomCreate").value);
      persistAllLocal();
      updateBloomHint();
    }
    function updateBloomHint() {
      const p = bloomDefault;
      const total = p.remember + p.understand + p.apply + p.analyze + p.evaluate + p.create;
      const hint = document.getElementById("bloomHint");
      if (total === 100) {
        hint.className = "text-[11px] text-green-600 mt-3";
        hint.textContent = "✅ Tổng Bloom = 100%. Có thể khóa Bloom để tự phân bổ.";
      } else {
        hint.className = "text-[11px] text-orange-600 mt-3";
        hint.textContent = "⚠️ Tổng Bloom hiện = " + total + "%. Nên chỉnh về 100% để phân bổ chính xác.";
      }
    }
    function distributeByBloom(total) {
      const p = bloomDefault;
      const parts = [
        Math.round(total * (p.remember/100)),
        Math.round(total * (p.understand/100)),
        Math.round(total * (p.apply/100)),
        Math.round(total * (p.analyze/100)),
        Math.round(total * (p.evaluate/100)),
        Math.round(total * (p.create/100))
      ];
      // Fix rounding to exact total
      let sum = parts.reduce((a,b)=>a+b,0);
      let diff = total - sum;
      const order = [2,1,3,0,4,5]; // bias toward Apply/Understand/Analyze
      let idx = 0;
      while (diff !== 0) {
        const k = order[idx % order.length];
        parts[k] += diff > 0 ? 1 : -1;
        if (parts[k] < 0) parts[k] = 0;
        sum = parts.reduce((a,b)=>a+b,0);
        diff = total - sum;
        idx++;
        if (idx > 2000) break;
      }
      return parts;
    }
    function applyBloomToAll() {
      problems.forEach(p => {
        p.specialties.forEach(s => {
          const sTotal = s.levels.reduce((a,b)=>a+b,0);
          if (sTotal <= 0) return;
          s.levels = distributeByBloom(sTotal);
        });
      });
      updateCalculations();
      showToast("✅ Đã áp Bloom 6 mức theo tổng câu hiện tại");
    }

    // =========================
    //  MIN/MAX WEIGHT SUGGEST
    // =========================
    function ensureMinMaxFields() {
      problems.forEach(p => {
        if (typeof p.minWeight !== "number") p.minWeight = 0;
        if (typeof p.maxWeight !== "number") p.maxWeight = 100;
        p.minWeight = Math.max(0, Math.min(100, parseInt(p.minWeight || 0, 10)));
        p.maxWeight = Math.max(0, Math.min(100, parseInt(p.maxWeight || 100, 10)));
        if (p.minWeight > p.maxWeight) {
          const t = p.minWeight; p.minWeight = p.maxWeight; p.maxWeight = t;
        }
        if (enforceMinMax) {
          p.weight = Math.max(p.minWeight, Math.min(p.maxWeight, parseInt(p.weight || 0, 10)));
        }
      });
    }
    function computeSuggestedWeights(targetSum = 100) {
      ensureMinMaxFields();
      const n = problems.length;
      if (n === 0) return;

      const mins = problems.map(p => p.minWeight);
      const maxs = problems.map(p => p.maxWeight);
      const mids = problems.map(p => Math.round((p.minWeight + p.maxWeight) / 2));

      const sumMin = mins.reduce((a,b)=>a+b,0);
      const sumMax = maxs.reduce((a,b)=>a+b,0);

      let T = targetSum;
      if (T < sumMin) T = sumMin;
      if (T > sumMax) T = sumMax;

      const w = mins.slice();
      let remaining = T - sumMin;

      const needToMid = problems.map((p,i) => Math.max(0, mids[i] - mins[i]));
      const order = [...Array(n).keys()].sort((i,j) => needToMid[j] - needToMid[i]);

      for (const i of order) {
        if (remaining <= 0) break;
        const capToMid = Math.min(needToMid[i], maxs[i] - w[i]);
        const add = Math.min(capToMid, remaining);
        w[i] += add;
        remaining -= add;
      }

      while (remaining > 0) {
        let progressed = false;
        const candidates = [];
        for (let i=0;i<n;i++){
          const room = maxs[i] - w[i];
          if (room > 0) candidates.push({i, room});
        }
        if (candidates.length === 0) break;

        const per = Math.max(1, Math.floor(remaining / candidates.length));
        for (const c of candidates) {
          if (remaining <= 0) break;
          const add = Math.min(c.room, per, remaining);
          if (add > 0) {
            w[c.i] += add;
            remaining -= add;
            progressed = true;
          }
        }
        if (!progressed) {
          for (const c of candidates) {
            if (remaining <= 0) break;
            w[c.i] += 1;
            remaining -= 1;
          }
        }
      }

      problems.forEach((p,i) => { p.weight = w[i]; });
    }
    function applySuggestedWeights() {
      computeSuggestedWeights(100);
      updateCalculations();
      showToast("✅ Đã áp trọng số gợi ý (Min/Max) và chuẩn hóa tổng = 100%");
    }
    function updateProblemMinMax(index, type, val) {
      ensureMinMaxFields();
      const v = Math.max(0, Math.min(100, parseInt(val || "0", 10) || 0));
      const p = problems[index];
      if (!p) return;

      if (type === "min") p.minWeight = v;
      if (type === "max") p.maxWeight = v;

      if (p.minWeight > p.maxWeight) {
        const t = p.minWeight; p.minWeight = p.maxWeight; p.maxWeight = t;
      }

      if (enforceMinMax) {
        p.weight = Math.max(p.minWeight, Math.min(p.maxWeight, parseInt(p.weight || 0, 10)));
      }
      updateCalculations();
    }

    // =========================
    //  SAVE / LOAD
    // =========================
    function persistAllLocal() {
      const payload = {
        examSettings,
        bloomDefault,
        organSystems,
        specialtyLibrary,
        CLOs,
        problems,
        enforceMinMax,
        totalQuestions: parseInt(document.getElementById('totalQuestions')?.value || "0", 10),
        savedAt: new Date().toISOString()
      };
      localStorage.setItem("medexam_blueprint_local", JSON.stringify(payload));
    }
    function restoreAllLocal() {
      try {
        const raw = localStorage.getItem("medexam_blueprint_local");
        if (!raw) return;
        const data = JSON.parse(raw);

        if (data.examSettings) examSettings = data.examSettings;
        if (data.bloomDefault) bloomDefault = data.bloomDefault;
        if (Array.isArray(data.organSystems)) organSystems = data.organSystems;
        if (Array.isArray(data.specialtyLibrary)) specialtyLibrary = data.specialtyLibrary;
        if (Array.isArray(data.CLOs)) CLOs = data.CLOs;
        if (Array.isArray(data.problems)) problems = data.problems;
        if (typeof data.enforceMinMax === "boolean") enforceMinMax = data.enforceMinMax;

        if (data.totalQuestions != null) document.getElementById('totalQuestions').value = data.totalQuestions;

        document.getElementById("bloomRemember").value = bloomDefault.remember ?? 15;
        document.getElementById("bloomUnderstand").value = bloomDefault.understand ?? 20;
        document.getElementById("bloomApply").value = bloomDefault.apply ?? 25;
        document.getElementById("bloomAnalyze").value = bloomDefault.analyze ?? 20;
        document.getElementById("bloomEvaluate").value = bloomDefault.evaluate ?? 15;
        document.getElementById("bloomCreate").value = bloomDefault.create ?? 5;

      } catch {}
    }
    async function saveBlueprint() {
      try {
        persistAllLocal();
        showToast("✅ Đã lưu Local");
      } catch (e) {
        alert("❌ Lưu thất bại: " + (e?.message || e));
      }
    }
    async function loadBlueprint() {
      restoreAllLocal();
      syncExamUI();
      updateBloomHint();
      updateCalculations();
      showToast("✅ Đã tải từ Local (nếu có)");
    }

    // =========================
    //  CLO MANAGEMENT
    // =========================
    function toggleCLOModal(show) {
      const modal = document.getElementById('cloModal');
      if (show) {
        renderCLOManager();
        modal.classList.add('active');
      } else {
        modal.classList.remove('active');
        updateCalculations();
      }
    }
    function renderCLOManager() {
      const container = document.getElementById('cloListContainer');
      container.innerHTML = '';
      CLOs.forEach((clo, index) => {
        const div = document.createElement('div');
        div.className = "bg-white p-3 rounded-lg border border-gray-200 shadow-sm flex items-center gap-3 group hover:border-blue-300 transition";
        div.innerHTML = `
          <div class="flex-none">
            <span class="block text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">Mã</span>
            <input type="text" value="${escapeHtml(clo.code)}" onchange="updateCLOData(${index}, 'code', this.value)"
              class="w-20 text-sm font-bold text-blue-700 bg-blue-50 border-transparent rounded focus:border-blue-500 focus:ring-0 text-center px-1">
          </div>
          <div class="flex-grow">
            <span class="block text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">Nội dung</span>
            <input type="text" value="${escapeHtml(clo.name)}" onchange="updateCLOData(${index}, 'name', this.value)"
              class="w-full text-sm text-slate-700 border-b border-gray-200 focus:border-blue-500 border-t-0 border-x-0 bg-transparent focus:ring-0 px-0 py-1">
          </div>
          <div class="flex-none pt-4">
            <button onclick="removeCLO(${index})" class="text-gray-300 hover:text-red-500 transition p-2" title="Xóa">
              <i class="fa-solid fa-trash-can"></i>
            </button>
          </div>
        `;
        container.appendChild(div);
      });
    }
    function addCLO() {
      const newId = 'clo' + Date.now();
      CLOs.push({ id: newId, code: 'NEW', name: 'Chuẩn đầu ra mới' });
      renderCLOManager();
    }
    function removeCLO(index) {
      if (CLOs.length <= 1) { alert("Cần ít nhất 1 CLO!"); return; }
      if (confirm("Xóa CLO này? Các mục liên quan sẽ chuyển sang CLO đầu.")) {
        const removed = CLOs[index].id;
        CLOs.splice(index, 1);
        problems.forEach(p => p.specialties.forEach(s => { if (s.cloId === removed) s.cloId = CLOs[0].id; }));
        renderCLOManager();
      }
    }
    function updateCLOData(index, field, value) { CLOs[index][field] = value; }
    function saveCLOs() { persistAllLocal(); toggleCLOModal(false); }

    // =========================
    //  SPECIALTY LIBRARY
    // =========================
    function toggleSpecialtyLibrary(show) {
      const modal = document.getElementById('specModal');
      if (show) { renderSpecLibrary(); modal.classList.add('active'); }
      else modal.classList.remove('active');
    }
    function renderSpecLibrary() {
      const c = document.getElementById("specListContainer");
      c.innerHTML = "";
      specialtyLibrary.forEach((name, idx) => {
        const row = document.createElement("div");
        row.className = "bg-white border border-gray-200 rounded-lg p-3 flex items-center gap-3 hover:border-emerald-300 transition";
        row.innerHTML = `
          <div class="flex-grow">
            <input type="text" value="${escapeHtml(name)}" class="w-full text-sm border-gray-200 rounded-md focus:ring-emerald-500 focus:border-emerald-500"
              onchange="updateSpecItem(${idx}, this.value)">
          </div>
          <button class="text-gray-300 hover:text-red-500 p-2" onclick="removeSpecItem(${idx})" title="Xóa">
            <i class="fa-solid fa-trash-can"></i>
          </button>
        `;
        c.appendChild(row);
      });
    }
    function addSpecItem() { specialtyLibrary.push("Học phần mới"); renderSpecLibrary(); }
    function updateSpecItem(idx, val) { specialtyLibrary[idx] = val.trim() || "Học phần"; }
    function removeSpecItem(idx) { specialtyLibrary.splice(idx, 1); renderSpecLibrary(); }
    function saveSpecLibrary() {
      specialtyLibrary = specialtyLibrary.map(x => x.trim()).filter(Boolean);
      specialtyLibrary = [...new Set(specialtyLibrary)];
      persistAllLocal();
      showToast("✅ Đã lưu thư viện học phần");
      toggleSpecialtyLibrary(false);
      updateCalculations();
    }

    // =========================
    //  ORGAN SYSTEMS
    // =========================
    function toggleSystemsModal(show) {
      const modal = document.getElementById('systemsModal');
      if (show) { renderSystems(); modal.classList.add('active'); }
      else modal.classList.remove('active');
    }
    function renderSystems() {
      const c = document.getElementById("systemsListContainer");
      c.innerHTML = "";
      organSystems.forEach((sys, idx) => {
        const row = document.createElement("div");
        row.className = "bg-white border border-gray-200 rounded-lg p-3 flex items-center gap-3 hover:border-indigo-300 transition";
        row.innerHTML = `
          <div class="w-24 text-xs font-bold text-indigo-700 bg-indigo-50 border border-indigo-100 rounded-md px-2 py-1 text-center">
            ${escapeHtml(sys.id)}
          </div>
          <div class="flex-grow">
            <input type="text" value="${escapeHtml(sys.name)}" class="w-full text-sm border-gray-200 rounded-md focus:ring-indigo-500 focus:border-indigo-500"
              onchange="updateSystem(${idx}, this.value)">
          </div>
          <button class="text-gray-300 hover:text-red-500 p-2" onclick="removeSystem(${idx})" title="Xóa">
            <i class="fa-solid fa-trash-can"></i>
          </button>
        `;
        c.appendChild(row);
      });
    }
    function addSystem() { organSystems.push({ id: "sys" + Date.now(), name: "Nhóm mới" }); renderSystems(); }
    function updateSystem(idx, val) { organSystems[idx].name = val.trim() || "Nhóm"; }
    function removeSystem(idx) {
      if (organSystems.length <= 1) { alert("Cần ít nhất 1 nhóm!"); return; }
      const removedId = organSystems[idx].id;
      if (!confirm("Xóa nhóm này? Các vấn đề thuộc nhóm sẽ chuyển sang nhóm đầu tiên.")) return;
      organSystems.splice(idx, 1);
      const fallback = organSystems[0].id;
      problems.forEach(p => { if (p.systemId === removedId) p.systemId = fallback; });
      renderSystems();
      updateCalculations();
    }
    function saveSystems() {
      persistAllLocal();
      showToast("✅ Đã lưu nhóm");
      toggleSystemsModal(false);
      updateCalculations();
    }

    // =========================
    //  MAIN RENDER (LEFT LIST)
    // =========================
    function renderProblemsList() {
      const container = document.getElementById('problemsList');
      const totalQ = parseInt(document.getElementById('totalQuestions').value) || 0;
      container.innerHTML = '';

      const sysMap = new Map(organSystems.map(s => [s.id, s.name]));
      const grouped = {};
      problems.forEach((p, idx) => {
        const sid = p.systemId || "unknown";
        if (!grouped[sid]) grouped[sid] = [];
        grouped[sid].push({ p, idx });
      });

      const orderedSysIds = organSystems.map(s => s.id);
      const extraSysIds = Object.keys(grouped).filter(k => !orderedSysIds.includes(k));
      const finalSysIds = [...orderedSysIds, ...extraSysIds];

      let totalWeight = 0;

      finalSysIds.forEach(sid => {
        const list = grouped[sid];
        if (!list || list.length === 0) return;

        const header = document.createElement("div");
        header.className = "group-header";
        header.innerHTML = `
          <div class="flex items-center gap-2">
            <span class="text-xs font-bold text-slate-700">${escapeHtml(sysMap.get(sid) || "Chưa phân nhóm")}</span>
            <span class="text-[11px] text-slate-500">(${list.length} vấn đề)</span>
          </div>
          <button class="text-xs bg-white border border-gray-300 hover:bg-indigo-50 hover:text-indigo-700 hover:border-indigo-200 text-gray-700 px-3 py-1.5 rounded shadow-sm transition font-medium"
            onclick="toggleSystemsModal(true)">
            <i class="fa-solid fa-pen"></i> Sửa nhóm
          </button>
        `;
        container.appendChild(header);

        list.forEach(({p, idx}) => {
          totalWeight += (parseInt(p.weight || 0, 10) || 0);

          const targetQ = Math.round((p.weight / 100) * totalQ);
          let currentActual = 0;
          p.specialties.forEach(s => currentActual += s.levels.reduce((a, b) => a + b, 0));

          const el = document.createElement('div');
          el.className = "bg-white border border-gray-200 rounded-lg p-3 hover:shadow-md transition-shadow group relative";

          const systemOptions = organSystems.map(os =>
            `<option value="${os.id}" ${os.id === (p.systemId || "") ? "selected" : ""}>${escapeHtml(os.name)}</option>`
          ).join("");

          el.innerHTML = `
            <div class="flex justify-between items-start mb-2 gap-2">
              <div class="flex-grow">
                <input type="text" value="${escapeHtml(p.name)}" onchange="updateProblemName(${idx}, this.value)"
                  class="font-bold text-sm text-slate-800 bg-transparent border-0 border-b border-transparent hover:border-gray-300 focus:border-blue-500 focus:ring-0 p-0 w-full transition-colors">
              </div>
              <button onclick="removeProblem(${idx})" class="text-gray-300 hover:text-red-500 transition opacity-0 group-hover:opacity-100">
                <i class="fa-solid fa-times"></i>
              </button>
            </div>

            <div class="flex items-center justify-between gap-3 mb-3">
              <div class="flex items-center gap-2">
                <span class="text-[11px] text-gray-500 font-semibold">Nhóm:</span>
                <select onchange="updateProblemSystem(${idx}, this.value)" class="text-xs border-gray-200 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 py-1 px-2 bg-white">
                  ${systemOptions}
                </select>
              </div>
              <button onclick="addSpecialty(${idx})"
                class="text-xs bg-white border border-blue-200 text-blue-600 hover:bg-blue-600 hover:text-white px-3 py-1.5 rounded-md font-medium transition shadow-sm flex items-center">
                <i class="fa-solid fa-plus mr-1.5"></i> Thêm mục
              </button>
            </div>

            <div class="grid grid-cols-2 gap-2 mb-2">
              <div class="suffix-wrap">
                <input type="number" min="0" max="100" value="${p.minWeight ?? 0}"
                  onchange="updateProblemMinMax(${idx}, 'min', this.value)"
                  class="num-input w-full border-gray-200 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500 text-xs font-semibold" />
                <span class="suffix">Min%</span>
              </div>
              <div class="suffix-wrap">
                <input type="number" min="0" max="100" value="${p.maxWeight ?? 100}"
                  onchange="updateProblemMinMax(${idx}, 'max', this.value)"
                  class="num-input w-full border-gray-200 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500 text-xs font-semibold" />
                <span class="suffix">Max%</span>
              </div>
            </div>

            <div class="flex items-center space-x-3 mb-3">
              <div class="flex-grow relative pt-1">
                <input type="range" min="0" max="100" value="${p.weight}" oninput="updateProblemWeight(${idx}, this.value)"
                  class="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
              </div>
              <div class="flex items-center bg-blue-50 px-2 py-1 rounded border border-blue-100">
                <input type="number" value="${p.weight}" onchange="updateProblemWeight(${idx}, this.value)"
                  class="w-10 bg-transparent text-right text-xs font-bold text-blue-700 focus:outline-none p-0 border-none">
                <span class="text-xs text-blue-600 ml-0.5">%</span>
              </div>
            </div>

            <div class="flex justify-between text-[11px] text-gray-500 bg-gray-50 rounded px-2 py-1.5">
              <span>Mục tiêu: <span class="font-bold text-slate-700">${targetQ} câu</span></span>
              <span class="${currentActual === targetQ ? 'text-green-600 font-bold' : 'text-orange-500 font-semibold'}">Hiện tại: ${currentActual}</span>
            </div>
          `;
          container.appendChild(el);
        });

        const divider = document.createElement("div");
        divider.className = "h-2";
        container.appendChild(divider);
      });

      const weightDisplay = document.getElementById('totalWeightDisplay');
      const weightBar = document.getElementById('weightProgressBar');
      weightDisplay.innerText = totalWeight + '%';
      weightBar.style.width = Math.min(totalWeight, 100) + '%';

      if (totalWeight === 100) {
        weightDisplay.className = "text-lg font-bold text-green-600";
        weightBar.className = "bg-green-500 h-2 rounded-full transition-all duration-300";
      } else if (totalWeight > 100) {
        weightDisplay.className = "text-lg font-bold text-red-600";
        weightBar.className = "bg-red-500 h-2 rounded-full transition-all duration-300";
      } else {
        weightDisplay.className = "text-lg font-bold text-orange-500";
        weightBar.className = "bg-orange-400 h-2 rounded-full transition-all duration-300";
      }
    }

    // =========================
    //  MATRIX RENDER (RIGHT TABLE)
    // =========================
    function renderMatrix() {
      const tbody = document.getElementById('matrixBody');
      tbody.innerHTML = '';
      const totalQ = parseInt(document.getElementById('totalQuestions').value) || 0;
      const lockBloom = document.getElementById("lockBloom").checked;

      let grandTotal = 0;
      let sum = [0,0,0,0,0,0]; // remember..create

      problems.forEach((p, pIndex) => {
        const targetQ = Math.round((p.weight / 100) * totalQ);
        let currentProblemTotal = 0;
        p.specialties.forEach(s => currentProblemTotal += s.levels.reduce((a, b) => a + b, 0));

        const trHeader = document.createElement('tr');
        trHeader.className = "bg-slate-50/80 hover:bg-slate-100 transition-colors border-b border-gray-200";
        trHeader.innerHTML = `
          <td colspan="10" class="px-6 py-2.5">
            <div class="flex items-center justify-between gap-4 flex-wrap">
              <div class="flex items-center">
                <div class="w-1.5 h-8 bg-blue-500 rounded-sm mr-3"></div>
                <div>
                  <div class="text-sm font-bold text-slate-800">${escapeHtml(p.name)}</div>
                  <div class="text-[11px] text-slate-500 mt-0.5">
                    Trọng số: <span class="font-semibold text-blue-600">${p.weight}%</span> (${targetQ} câu)
                    <span class="ml-2 text-[11px] text-slate-400">• Nhóm: ${escapeHtml(getSystemName(p.systemId))}</span>
                  </div>
                </div>
              </div>

              <div class="flex items-center gap-3 flex-wrap justify-end">
                <span class="text-[11px] font-bold uppercase tracking-wider ${currentProblemTotal === targetQ ? 'text-green-600' : 'text-orange-500'}">
                  Đã phân bổ: ${currentProblemTotal}/${targetQ}
                </span>

                <select class="text-xs border-gray-200 rounded-md shadow-sm focus:border-emerald-500 focus:ring-emerald-500 py-1.5 px-2 bg-white"
                  onchange="quickAddSpecialtyFromLibrary(${pIndex}, this.value)">
                  <option value="">+ Chọn học phần từ thư viện</option>
                  ${specialtyLibrary.map(n => `<option value="${escapeHtml(n)}">${escapeHtml(n)}</option>`).join("")}
                </select>

                <button onclick="addSpecialty(${pIndex})" class="text-xs bg-white border border-blue-200 text-blue-600 hover:bg-blue-600 hover:text-white px-3 py-1.5 rounded-md font-medium transition shadow-sm flex items-center">
                  <i class="fa-solid fa-plus mr-1.5"></i> Thêm
                </button>
              </div>
            </div>
          </td>
        `;
        tbody.appendChild(trHeader);

        p.specialties.forEach((s, sIndex) => {
          // Ensure 6 levels
          if (!Array.isArray(s.levels)) s.levels = [0,0,0,0,0,0];
          while (s.levels.length < 6) s.levels.push(0);

          const sTotal = s.levels.reduce((a, b) => a + b, 0);

          grandTotal += sTotal;
          for (let i=0;i<6;i++) sum[i] += (s.levels[i] || 0);

          const tr = document.createElement('tr');
          tr.className = "group hover:bg-blue-50/30 transition-colors";

          const cloOptions = CLOs.map(c =>
            `<option value="${c.id}" ${c.id === s.cloId ? 'selected' : ''}>${escapeHtml(c.code)}: ${escapeHtml(c.name)}</option>`
          ).join('');

          tr.innerHTML = `
            <td class="px-6 py-2 pl-12">
              <div class="flex items-center gap-2">
                <i class="fa-solid fa-turn-up rotate-90 text-gray-300 text-xs"></i>
                <input type="text" value="${escapeHtml(s.name)}" onchange="updateSpecialtyName(${pIndex}, ${sIndex}, this.value)"
                  class="w-full text-sm font-semibold text-slate-700 bg-transparent border-0 border-b border-transparent focus:border-blue-500 focus:ring-0 p-0 placeholder-gray-400 hover:border-gray-200 transition-colors"
                  placeholder="Nhập tên mục/học phần...">
              </div>
              <div class="mt-1 flex items-center gap-2">
                ${lockBloom ? `<span class="text-[11px] text-purple-600 font-semibold"><i class="fa-solid fa-lock mr-1"></i>Khóa Bloom</span>` : ``}
              </div>
            </td>

            <td class="px-3 py-2">
              <select onchange="updateSpecialtyCLO(${pIndex}, ${sIndex}, this.value)"
                class="block w-full text-xs text-slate-600 border-gray-200 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500 py-1.5">
                ${cloOptions}
              </select>
            </td>

            ${levelCell(pIndex,sIndex,0,s.levels[0],"blue")}
            ${levelCell(pIndex,sIndex,1,s.levels[1],"cyan")}
            ${levelCell(pIndex,sIndex,2,s.levels[2],"indigo")}
            ${levelCell(pIndex,sIndex,3,s.levels[3],"purple")}
            ${levelCell(pIndex,sIndex,4,s.levels[4],"amber")}
            ${levelCell(pIndex,sIndex,5,s.levels[5],"emerald")}

            <td class="px-4 py-2 text-center font-black text-slate-800 bg-gray-50 border-l border-gray-100">${sTotal}</td>

            <td class="px-2 py-2 text-center">
              <button onclick="removeSpecialty(${pIndex}, ${sIndex})"
                class="text-gray-300 hover:text-red-500 hover:bg-red-50 w-8 h-8 rounded-full flex items-center justify-center transition opacity-0 group-hover:opacity-100">
                <i class="fa-solid fa-trash-can"></i>
              </button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      });

      animateValue("sumRemember", parseInt(document.getElementById('sumRemember').innerText), sum[0], 250);
      animateValue("sumUnderstand", parseInt(document.getElementById('sumUnderstand').innerText), sum[1], 250);
      animateValue("sumApply", parseInt(document.getElementById('sumApply').innerText), sum[2], 250);
      animateValue("sumAnalyze", parseInt(document.getElementById('sumAnalyze').innerText), sum[3], 250);
      animateValue("sumEvaluate", parseInt(document.getElementById('sumEvaluate').innerText), sum[4], 250);
      animateValue("sumCreate", parseInt(document.getElementById('sumCreate').innerText), sum[5], 250);
      animateValue("grandTotal", parseInt(document.getElementById('grandTotal').innerText), grandTotal, 300);

      const statusEl = document.getElementById('validationStatus');
      const diff = grandTotal - totalQ;

      if (grandTotal === totalQ) {
        statusEl.className = "text-xs font-bold px-3 py-1.5 rounded-full bg-green-100 text-green-700 border border-green-200";
        statusEl.innerHTML = '<i class="fa-solid fa-circle-check mr-1"></i> Hợp lệ';
      } else if (diff > 0) {
        statusEl.className = "text-xs font-bold px-3 py-1.5 rounded-full bg-red-100 text-red-700 border border-red-200";
        statusEl.innerHTML = `<i class="fa-solid fa-circle-exclamation mr-1"></i> Dư ${diff} câu`;
      } else {
        statusEl.className = "text-xs font-bold px-3 py-1.5 rounded-full bg-orange-100 text-orange-700 border border-orange-200";
        statusEl.innerHTML = `<i class="fa-solid fa-triangle-exclamation mr-1"></i> Thiếu ${Math.abs(diff)} câu`;
      }
    }

    function levelCell(pIndex,sIndex,levelIndex,value,color){
      const ring = {
        blue: "focus:ring-blue-500 focus:border-blue-500 bg-blue-50/30 text-blue-700",
        cyan: "focus:ring-cyan-500 focus:border-cyan-500 bg-cyan-50/30 text-cyan-700",
        indigo: "focus:ring-indigo-500 focus:border-indigo-500 bg-indigo-50/30 text-indigo-700",
        purple: "focus:ring-purple-500 focus:border-purple-500 bg-purple-50/30 text-purple-700",
        amber: "focus:ring-amber-500 focus:border-amber-500 bg-amber-50/30 text-amber-700",
        emerald:"focus:ring-emerald-500 focus:border-emerald-500 bg-emerald-50/30 text-emerald-700"
      }[color] || "focus:ring-blue-500 focus:border-blue-500 bg-blue-50/30 text-blue-700";

      return `
        <td class="px-2 py-2 text-center">
          <input type="number" min="0" value="${value || 0}" onchange="updateLevel(${pIndex}, ${sIndex}, ${levelIndex}, this.value)"
            class="w-12 text-center text-sm font-bold border border-gray-200 rounded-md py-1 focus:ring-2 ${ring}">
        </td>
      `;
    }

    function animateValue(id, start, end, duration) {
      if (start === end) return;
      const range = end - start;
      let current = start;
      const increment = end > start ? 1 : -1;
      const stepTime = Math.abs(Math.floor(duration / (range || 1)));
      const obj = document.getElementById(id);
      const timer = setInterval(function () {
        current += increment;
        obj.innerHTML = current;
        if (current == end) clearInterval(timer);
      }, stepTime < 10 ? 10 : stepTime);
      setTimeout(() => { obj.innerHTML = end; clearInterval(timer); }, duration);
    }

    // =========================
    //  LOGIC UPDATES
    // =========================
    function updateCalculations() {
      if (enforceMinMax) ensureMinMaxFields();

      if (document.getElementById("lockBloom").checked) {
        problems.forEach(p => {
          p.specialties.forEach(s => {
            const total = s.levels.reduce((a,b)=>a+b,0);
            if (total > 0) s.levels = distributeByBloom(total);
          });
        });
      }

      renderProblemsList();
      renderMatrix();
      persistAllLocal();
    }

    function updateProblemWeight(index, val) {
      const p = problems[index];
      if (!p) return;

      let w = parseInt(val || "0", 10) || 0;
      w = Math.max(0, Math.min(100, w));

      if (enforceMinMax) {
        ensureMinMaxFields();
        w = Math.max(p.minWeight, Math.min(p.maxWeight, w));
      }
      p.weight = w;
      updateCalculations();
    }
    function updateProblemName(index, val) { problems[index].name = val; updateCalculations(); }
    function updateProblemSystem(index, systemId) { problems[index].systemId = systemId; updateCalculations(); }

    function addProblem() {
      const fallback = organSystems[0]?.id || "sys";
      problems.push({
        id: Date.now(),
        systemId: fallback,
        name: "Vấn đề mới",
        weight: 0,
        minWeight: 0,
        maxWeight: 100,
        specialties: [{ name: "", cloId: CLOs[0].id, levels: [0,0,0,0,0,0] }]
      });
      updateCalculations();
      setTimeout(() => {
        const list = document.getElementById('problemsList');
        list.scrollTop = list.scrollHeight;
      }, 60);
    }
    function removeProblem(index) {
      if (confirm("Xóa vấn đề này sẽ xóa tất cả mục liên quan?")) {
        problems.splice(index, 1);
        updateCalculations();
      }
    }

    function addSpecialty(pIndex) {
      problems[pIndex].specialties.push({ name: "", cloId: CLOs[0].id, levels: [0,0,0,0,0,0] });
      updateCalculations();
    }
    function quickAddSpecialtyFromLibrary(pIndex, name) {
      if (!name) return;
      problems[pIndex].specialties.push({ name, cloId: CLOs[0].id, levels: [0,0,0,0,0,0] });
      updateCalculations();
    }
    function removeSpecialty(pIndex, sIndex) {
      problems[pIndex].specialties.splice(sIndex, 1);
      updateCalculations();
    }

    function updateSpecialtyName(pIndex, sIndex, val) { problems[pIndex].specialties[sIndex].name = val; persistAllLocal(); }
    function updateSpecialtyCLO(pIndex, sIndex, val) { problems[pIndex].specialties[sIndex].cloId = val; persistAllLocal(); }

    function updateLevel(pIndex, sIndex, levelIndex, val) {
      const parsed = parseInt(val) || 0;
      if (parsed >= 0) {
        const s = problems[pIndex].specialties[sIndex];
        if (!Array.isArray(s.levels)) s.levels = [0,0,0,0,0,0];
        while (s.levels.length < 6) s.levels.push(0);
        s.levels[levelIndex] = parsed;
        updateCalculations();
      }
    }

    // =========================
    //  EXPORTS
    // =========================
    function exportReport() {
      const data = {
        examSettings,
        totalQuestions: parseInt(document.getElementById("totalQuestions").value || "0", 10) || 0,
        enforceMinMax,
        bloomDefault,
        organSystems,
        CLOs,
        specialtyLibrary,
        problems
      };
      downloadText("MedExam_FullReport.json", JSON.stringify(data, null, 2), "application/json;charset=utf-8");
    }
    function exportSpecialtyChooser() {
      const allSpecs = listAllSpecialtiesUnique();
      if (allSpecs.length === 0) { alert("Chưa có mục/học phần nào."); return; }
      const pick = prompt("Nhập đúng tên mục/học phần cần xuất:\n\n" + allSpecs.map(x => "• " + x).join("\n"));
      if (!pick) return;
      exportSpecialtyJSON(pick.trim());
    }
    function exportSpecialtyJSON(specialtyName) {
      const data = buildSpecialtyExportJSON(specialtyName);
      if (!data) { alert("Không tìm thấy: " + specialtyName); return; }
      const safe = filenameSafe(specialtyName);
      downloadText(`Muc_${safe}.json`, JSON.stringify(data, null, 2), "application/json;charset=utf-8");
    }
    function buildSpecialtyExportJSON(specialtyName) {
      const target = specialtyName.trim().toLowerCase();
      const items = [];

      problems.forEach(p => {
        p.specialties.forEach(s => {
          if ((s.name||"").trim().toLowerCase() === target) {
            const clo = CLOs.find(c => c.id === s.cloId);
            items.push({
              system: getSystemName(p.systemId),
              problem: p.name,
              weightPercent: p.weight,
              clo: clo ? { code: clo.code, name: clo.name } : null,
              bloom: {
                remember: s.levels[0]||0,
                understand: s.levels[1]||0,
                apply: s.levels[2]||0,
                analyze: s.levels[3]||0,
                evaluate: s.levels[4]||0,
                create: s.levels[5]||0
              },
              total: (s.levels||[]).reduce((a,b)=>a+b,0)
            });
          }
        });
      });

      if (items.length === 0) return null;

      return {
        exam: { ...examSettings, totalQuestions: parseInt(document.getElementById("totalQuestions").value||"0",10) || 0 },
        specialty: specialtyName,
        items
      };
    }
    function listAllSpecialtiesUnique() {
      const set = new Set();
      problems.forEach(p => p.specialties.forEach(s => {
        const n = (s.name || "").trim();
        if (n) set.add(n);
      }));
      return Array.from(set).sort((a,b)=>a.localeCompare(b,'vi'));
    }

    // =========================
    //  HELPERS
    // =========================
    function getSystemName(systemId) {
      const s = organSystems.find(x => x.id === systemId);
      return s ? s.name : "Chưa phân nhóm";
    }
    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
    function filenameSafe(str) {
      return String(str ?? "export")
        .trim()
        .replace(/[\\\/:*?"<>|]+/g, "_")
        .replace(/\s+/g, "_")
        .slice(0, 80);
    }
    function downloadText(filename, content, mime) {
      const blob = new Blob([content], { type: mime || "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      showToast("✅ Đã xuất: " + filename);
    }

    // =========================
    //  HORIZONTAL DRAG HANDLE
    // =========================
    function initHorizontalScrollHandle() {
      const scroller = document.getElementById("matrixScroll");
      const handle = document.getElementById("hScrollHandle");
      if (!scroller || !handle) return;

      let dragging = false;
      let startX = 0;
      let startScrollLeft = 0;

      const onDown = (e) => {
        dragging = true;
        handle.setPointerCapture?.(e.pointerId);
        startX = e.clientX;
        startScrollLeft = scroller.scrollLeft;
        handle.style.cursor = "grabbing";
      };
      const onMove = (e) => {
        if (!dragging) return;
        const dx = e.clientX - startX;
        scroller.scrollLeft = startScrollLeft + dx * 1.2;
      };
      const onUp = () => {
        dragging = false;
        handle.style.cursor = "grab";
      };

      handle.addEventListener("pointerdown", onDown);
      window.addEventListener("pointermove", onMove);
      window.addEventListener("pointerup", onUp);

      let lastTap = 0;
      handle.addEventListener("click", () => {
        const now = Date.now();
        if (now - lastTap < 300) scroller.scrollTo({ left: 0, behavior: "smooth" });
        lastTap = now;
      });
    }

    // =========================
    //  INJECT FULL PROBLEMS ARRAY (generated from Excel)
    // =========================
    problems = ${json.dumps(problems_list, ensure_ascii=False, indent=2)};

    // =========================
    //  INIT
    // =========================
    window.onload = function () {
      restoreCardHeights();
      attachResizeObservers();

      // Restore Local if any (will override Excel-prefill)
      restoreAllLocal();

      ensureMinMaxFields();
      initHorizontalScrollHandle();

      document.getElementById("bloomRemember").value = bloomDefault.remember ?? 15;
      document.getElementById("bloomUnderstand").value = bloomDefault.understand ?? 20;
      document.getElementById("bloomApply").value = bloomDefault.apply ?? 25;
      document.getElementById("bloomAnalyze").value = bloomDefault.analyze ?? 20;
      document.getElementById("bloomEvaluate").value = bloomDefault.evaluate ?? 15;
      document.getElementById("bloomCreate").value = bloomDefault.create ?? 5;

      syncExamUI();
      updateBloomHint();
      updateCalculations();
    };
  </script>
</body>
</html>
